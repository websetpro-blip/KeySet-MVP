# Исправления Drag&Drop и позиционирования минуса/плюса

## Применённые патчи

### 1. Создан lib/tree_ops.ts
- **moveSubtree** - перенос ветки целиком к новому родителю
- **moveSingleNode** - перенос только узла (дети остаются у старого родителя)
- **isDescendant** - защита от циклов (нельзя перенести узел в своего потомка)
- **toggleCollapse, addChild, addSibling, updateNode** - функции управления узлами
- **copy/paste** функции для буфера обмена

### 2. Исправлена позиция кнопки минус/плюс
```typescript
// Было:
const dir = Math.sign(x - parentX) || 1;

// Стало:
const dir = x < 0 ? 1 : -1; // для левой половины — справа; для правой — слева
```
- Кнопка теперь появляется у точки подключения линии к узлу
- Для левых веток - справа, для правых - слева

### 3. Полностью переписана логика Drag&Drop
- **Удалены** старые HTML5 drag events (onDragStart, onDragOver, onDrop)
- **Добавлены** новые mouse events (onMouseDown с startNodeDrag)
- **Shift+drag** - перенос только узла без детей (moveSingleNode)
- **Обычный drag** - перенос всей ветки (moveSubtree)
- **Подсветка цели** - желтая обводка появляется при наведении во время перетаскивания
- **Защита от циклов** - нельзя перенести узел в себя или своего потомка
- **Подавление клика** - preventClick предотвращает ложные клики после drag

## Новые функции

### Основные функции перемещения:
- `ЛКМ + Drag` → перенести ветку целиком
- `Shift + ЛКМ + Drag` → перенести только узел (дети остаются)

### Кнопка минус/плюс:
- Появляется только при наведении на узел с детьми
- Расположена у точки подключения линии
- Кликабельна для сворачивания/разворачивания

### Защита:
- Нельзя перенести узел в себя
- Нельзя создать циклические зависимости
- Подсветка показывает валидные цели для дропа

## Технические детали

### Состояние перетаскивания:
```typescript
const dragStart = useRef<{ 
  id: string; 
  x0: number; 
  y0: number; 
  mode: 'subtree' | 'single'; 
  started: boolean 
} | null>(null);
const [dragOverId, setDragOverId] = useState<string | null>(null);
const preventClick = useRef(false);
```

### Обработчики событий:
- `startNodeDrag` - инициализация перетаскивания
- `hitTestNode` - определение узла под курсором
- Подсветка `dragOverId === node.id` с желтой обводкой

## Результат
Все патчи из ТЗ успешно применены:
- ✅ Drag&Drop перенос узлов работает
- ✅ Shift для переноса только узла
- ✅ Кнопка минус/плюс в правильной позиции
- ✅ Защита от циклов
- ✅ Подсветка целей дропа
- ✅ Сохранён весь существующий UX

**Развёрнуто:** https://s2qw9jclhzuo.space.minimax.io
