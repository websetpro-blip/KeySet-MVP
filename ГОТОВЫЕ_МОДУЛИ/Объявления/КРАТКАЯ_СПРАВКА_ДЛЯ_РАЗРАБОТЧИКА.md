# КРАТКАЯ СПРАВКА ДЛЯ РАЗРАБОТЧИКА
## AdsCreator v4.14.xlsb → Веб-версия

---

## АРХИТЕКТУРА В 2 ПРЕДЛОЖЕНИЯХ

**AdsCreator** - это инструмент для создания 1000+ объявлений Яндекс.Директ за 5 минут.
**Структура:** 4 листа Excel (AdsCreator + Параметры + Яндекс Директ + Google Adwords) + VBA макросы = 7-шаговый визард.

---

## ОСНОВНОЙ ПОТОК (7 ШАГОВ)

```
ЛИСТ 1 (AdsCreator):
  ШАГ 1: Ввод ключей (до 1000, макс 8192 символов)
  ШАГ 2: Домен + UTM + ID группы
  ШАГ 3: Нажать "Далее"

ЛИСТ 2 (Параметры):
  ШАГ 4: Добавки к H2 (20 вариантов, от длинных к коротким)
  ШАГ 5: Варианты текста (по одному на строке)
  ШАГ 6: Нажать "Обработать" (применить правила подмены)
  ШАГ 7: Редактировать H1/H2 вручную (опционально)

ЛИСТ 3 (Яндекс Директ):
  ШАГ 8: Финальная таблица (~30+ колонок)
  ШАГ 9: Экспорт CSV или загрузка в API
```

---

## КЛЮЧЕВЫЕ ДАННЫЕ

### Лимиты
```javascript
H1: 56 символов
H2: 56 символов
Text: 81 символ
Clarification: 66 символов (до 4 штук)
SiteLink Text: 30 символов
SiteLink Desc: 60 символов
Keys: 1000 штук макс, 8192 символов макс
```

### Структура AdRow
```typescript
type AdRow = {
  key: string;              // ключевая фраза
  h1: string;               // заголовок 1
  h2: string;               // заголовок 2
  txt: string;              // текст объявления
  url: string;              // полная URL (с UTM)
  path: string;             // отображаемая ссылка (без UTM)
  clar: string;             // уточнения (до 4, через \n)
  sl1_text, sl1_url, sl1_anchor, sl1_desc;  // быстрая ссылка 1
  sl2_text, sl2_url, sl2_anchor, sl2_desc;  // быстрая ссылка 2
  sl3_text, sl3_url, sl3_anchor, sl3_desc;  // быстрая ссылка 3
  sl4_text, sl4_url, sl4_anchor, sl4_desc;  // быстрая ссылка 4
}
```

---

## ОСНОВНЫЕ АЛГОРИТМЫ

### 1. Разбиение H1/H2
```javascript
// Вход: "система очистки воды из скважины для частного"
// H2-суффиксы: ["за 70 190р!", "за 16 90р!", ...]

// Алгоритм:
1. Собрать слова в H1, пока длина <= 56
2. Остаток слов идёт в H2 (хвост)
3. Если хвост есть: H2 = хвост + " - " + максимально_подходящий_суффикс
4. Если хвоста нет: H2 = максимально_подходящий_суффикс
5. Добавить "!" в конец H1 и H2

// Выход:
// H1: "Система очистки воды из скважины!" (48 символов)
// H2: "Для частного - за 70 190р!" (28 символов)
```

### 2. Правила подмены (2 RuleSet)
```javascript
type Rule = {
  type: "plain" | "regex";
  find: string;
  replace: string;
  scope: ["*"] | ["key", "h1", "h2", "txt", "url", "path", "clar", ...];
}

// Примеры:
[
  { type: "plain", find: "→", replace: " - ", scope: ["h1", "h2"] },
  { type: "regex", find: "\\{city\\}", replace: "Москва", scope: ["*"] },
  { type: "regex", find: "система", replace: "комплекс", scope: ["h1"] }
]

// Применяются сверху вниз для каждого объявления
```

### 3. Генерация текста
```javascript
// Циклически подставлять из массива вариантов
textVariants[индекс % textVariants.length]

// Пример:
// Объявление 1 → текст 1
// Объявление 2 → текст 2
// Объявление 3 → текст 3
// Объявление 4 → текст 1 (повторение, так как вариантов 3)
```

### 4. URL с UTM (подстановка макросов)
```javascript
// Шаблон: "utm_source=yandex&utm_medium=cpc&utm_campaign={group}&utm_term={key}"
// Макросы:
// {key} → ключевая фраза (URL-encoded)
// {group} → первые 40 символов ключа

// Пример:
// Входные данные: key="купить систему очистки", domain="nordkor.ru"
// Выход: "https://nordkor.ru?utm_source=yandex&utm_medium=cpc&utm_campaign=kupitj_sistemu&utm_term=kupitj%20sistemu%20ochistki"
```

---

## ЭКСПОРТ CSV (Direct Commander)

### Формат
- **Кодировка:** UTF-8 + BOM (`\ufeff`)
- **Разделитель:** `;`
- **Экранирование:** если поле содержит `;` или `"` или `\n` → обернуть в `""`

### Заголовки (точный порядок!)
```
Кампания;Группа;Ключевая фраза;Заголовок 1;Заголовок 2;Текст;Ссылка;Отображаемая ссылка;Уточнения;SL1;SL1 URL;SL1 Anchor;SL1 Desc;SL2;SL2 URL;SL2 Anchor;SL2 Desc;SL3;SL3 URL;SL3 Anchor;SL3 Desc;SL4;SL4 URL;SL4 Anchor;SL4 Desc
```

### Значения
```
Кампания:              "AUTO-2025-11-16" (дата)
Группа:               первые 80 символов ключа
Ключевая фраза:       полный ключ
Заголовок 1:          H1
Заголовок 2:          H2
Текст:                текст объявления
Ссылка:               полная URL с UTM
Отображаемая ссылка:  домен/путь БЕЗ UTM ← КРИТИЧНО!
Уточнения:            "уточ1 | уточ2 | уточ3 | уточ4"
SL1-SL4:              4 быстрые ссылки (текст, URL, anchor, desc)
```

---

## ИНТЕГРАЦИЯ С ИИ (Gemini)

### Запрос (POST /api/ai/ads/generate)
```json
{
  "keys": ["ключ1", "ключ2", ...],
  "domain": "nordkor.ru",
  "utm": "utm_source=yandex&utm_medium=cpc&utm_campaign={group}&utm_term={key}",
  "locale": "ru",
  "mode": "serp",
  "limits": { "h1": 56, "h2": 56, "body": 81 }
}
```

### Ответ
```json
{
  "rows": [
    { AdRow },
    { AdRow },
    ...
  ]
}
```

### Что делает ИИ
1. Анализирует SERP по ключу
2. Смотрит объявления конкурентов
3. Генерирует заголовки, текст, уточнения, быстрые ссылки
4. Гарантирует: соблюдение лимитов, релевантность 10/10, качество 10/10

---

## ВЕБ-ВЕРСИЯ: ЧТО ДОЛЖНО БЫТЬ

### Layout
```
┌─────────────────────────────────────────────────────┐
│  Левая панель (280px)  │  Правая панель (широкая)   │
│  ─────────────────────┼───────────────────────────  │
│  Ключи                │  Toolbar                    │
│  Домен + UTM          │  ─────────────────────────  │
│  Шаблоны H1/H2        │  Excel таблица (все ряды)   │
│  Текст варианты       │  ─────────────────────────  │
│  [БС] (раскрыв.)      │  Предпросмотр "как в YD"    │
│  [Уточнения] (раск.)  │  (sticky, компактный)       │
│  [Отобр. ссылка]      │                             │
│  [Контакты]           │                             │
│  [Правила подмены]    │                             │
│  [Кнопки]             │                             │
└─────────────────────────────────────────────────────┘
```

### Таблица (колонки)
```
Ключ | H1 | H2 | Текст | URL | Отобр. путь | Уточнения |
SL1 | SL1 URL | SL1 Anchor | SL1 Desc |
SL2 | SL2 URL | SL2 Anchor | SL2 Desc |
SL3 | SL3 URL | SL3 Anchor | SL3 Desc |
SL4 | SL4 URL | SL4 Anchor | SL4 Desc
```

### Режим копирования
```
Переключатель: "Режим копирования" (вкл/выкл)
При включении: таблица в plain text формат → можно выделить мышью → Ctrl+C
Кнопки:
  - Копировать как TSV
  - Копировать только ключи
  - Экспорт CSV
```

### Предпросмотр "как в Яндексе"
```
┌─────────────────────────────┐
│ ≫ H1 — H2 (синий 18px)      │
│                             │
│ [Префикс] домен/путь        │
│ (зелёный 13px)              │
│                             │
│ Текст объявления            │
│ (чёрный 14px)               │
│                             │
│ [Чип1] [Чип2] [Чип3]        │
│ (серые 12px)                │
│                             │
│ ┌──┬──┬──┬──┐                │
│ │SL1│SL2│SL3│SL4│            │
│ └──┴──┴──┴──┘                │
│                             │
│ [←] [→]                     │
└─────────────────────────────┘
```

---

## ТИПИЧНЫЕ ОШИБКИ

### Ошибка: H1/H2 превышает лимит
**Решение:** Кнопка "Подрезать по лимитам" → обрезать до лимита + "…"

### Ошибка: Пустые уточнения или быстрые ссылки
**Решение:** Кнопка "+ Быстрые ссылки (4)" → автозаполнение

### Ошибка: CSV не открывается в Excel
**Проверить:**
- BOM: `\ufeff` в начале
- Разделитель: `;` (не `,`)
- Кодировка: UTF-8

### Ошибка: "Отображаемая ссылка" содержит UTM
**КРИТИЧНО!** Отображаемая ссылка ВСЕГДА = домен/путь БЕЗ UTM

---

## ПРОИЗВОДИТЕЛЬНОСТЬ

```
1000 ключей → генерация: <5 сек
1000 объявлений → экспорт CSV: <1 сек
1000 объявлений → копирование в буфер: <1 сек
1000 объявлений → память: ~1-2 MB
```

---

## ЧАСТЫЕ ВОПРОСЫ

**Q: Можно ли вставить 10,000 ключей?**
A: Максимум 1000 (лимит по требованиям). Можно запустить несколько раз с разными наборами.

**Q: Где хранятся данные?**
A: В LocalStorage браузера (не на сервере). Очистка кэша = потеря данных.

**Q: Что если правила подмены перекрывают друг друга?**
A: Применяются последовательно сверху вниз. Результат одного = вход для другого.

**Q: Как загрузить в Яндекс напрямую?**
A: Кнопка "Загрузить в Яндекс" (API v5) или экспорт CSV → Direct Commander.

**Q: Что если в ключе очень длинное слово?**
A: Если слово > 56 символов → обрезка с "…" на кнопку "Подрезать по лимитам".

---

## ВЕРСИОНИРОВАНИЕ

**v4.14** - текущая версия (скриншоты 1-6.png)
- 7-шаговый визард
- Две RuleSet для подмен
- Экспорт CSV под Direct Commander
- Поддержка быстрых ссылок (4 штуки)

**Веб-версия (планируется)**
- React/Vite фронт
- FastAPI бэкенд
- Прямая интеграция с ИИ (Gemini)
- LocalStorage для черновика
- Таблица как в Excel (resizable, sticky)

---

## ФАЙЛЫ В ПРОЕКТЕ

```
/ГОТОВЫЕ_МОДУЛИ/Объявления/
├── AdsCreator v4.14.xlsb ................... основной файл Excel
├── Правила подмены.xlsb ................... дополнительный файл с правилами
├── Пример готовых объявлений.xlsx ......... пример выходных данных
├── Чат РАБОЧИЙ КОД.txt .................... все скрипты и логика
├── Создание объявлений.txt ................ инструкция
├── ПОЛНОЕ ОПИСАНИЕ AdsCreator Excel.md ... подробное описание
├── АНАЛИЗ - Упущенные функции.md ......... анализ проблем текущей версии
├── ПОЛНЫЙ_АНАЛИЗ_ФУНКЦИОНАЛА.md ......... этот документ (15+ разделов)
├── КРАТКАЯ_СПРАВКА_ДЛЯ_РАЗРАБОТЧИКА.md . краткая справка (этот файл)
├── 1.png - 6.png .......................... скриншоты интерфейса
└── ads-creator-standalone.html ........... попытка веб-версии
```

---

## СЛЕДУЮЩИЙ ШАГ

**Для разработчика:**
1. Прочитать `ПОЛНЫЙ_АНАЛИЗ_ФУНКЦИОНАЛА.md` (все детали)
2. Реализовать веб-версию на React/Vite с таким же UX
3. Подключить ИИ-генерацию (POST /api/ai/ads/generate)
4. Тестировать на 100+ ключах
5. Экспортировать CSV и проверить в Direct Commander

**Временная оценка:** 40-60 часов (фронт + бэкенд + тесты)

