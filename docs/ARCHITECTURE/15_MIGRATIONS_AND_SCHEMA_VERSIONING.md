# 15. Migrations & Schema Versioning KeySet-MVP

> **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: SQLite schema changes, Alembic, –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–¶–µ–ª—å](#—Ü–µ–ª—å)
- [–î–ª—è –∫–æ–≥–æ](#–¥–ª—è-–∫–æ–≥–æ)
- [–°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã](#—Å–≤—è–∑–∞–Ω–Ω—ã–µ-–¥–æ–∫—É–º–µ–Ω—Ç—ã)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–∏–≥—Ä–∞—Ü–∏–π](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–º–∏–≥—Ä–∞—Ü–∏–π)
- [–î–∏–∞–≥—Ä–∞–º–º–∞ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è](#–¥–∏–∞–≥—Ä–∞–º–º–∞-–≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)
- [–°—Ç—Ä–∞—Ç–µ–≥–∏—è –º–∏–≥—Ä–∞—Ü–∏–π](#—Å—Ç—Ä–∞—Ç–µ–≥–∏—è-–º–∏–≥—Ä–∞—Ü–∏–π)
- [–°–Ω–∏–ø–ø–µ—Ç—ã](#—Å–Ω–∏–ø–ø–µ—Ç—ã)
- [–¢–∏–ø–æ–≤—ã–µ –æ—à–∏–±–∫–∏](#—Ç–∏–ø–æ–≤—ã–µ-–æ—à–∏–±–∫–∏)
- [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](#–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)
- [TL;DR](#tldr)
- [–ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è](#—á–µ–∫-–ª–∏—Å—Ç-–ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è)

---

## –¶–µ–ª—å

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –º–∏–≥—Ä–∞—Ü–∏–π KeySet-MVP: –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã –ë–î, –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

## –î–ª—è –∫–æ–≥–æ

- Backend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã
- DevOps –¥–ª—è deployment –º–∏–≥—Ä–∞—Ü–∏–π
- Database –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã
- QA –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [01_DATABASE.md](./01_DATABASE.md) ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î
- [12_PRODUCTION_WINDOWS_BUILD.md](./12_PRODUCTION_WINDOWS_BUILD.md) ‚Äî –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ production
- [13_SECURITY_NOTES.md](./13_SECURITY_NOTES.md) ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–∏–≥—Ä–∞—Ü–∏–π

```mermaid
graph TD
    A[Schema V1] -->|migration_001| B[Schema V2]
    B -->|migration_002| C[Schema V3]
    C -->|migration_003| D[Schema V4]
    
    E[Alembic] --> F[Version Table]
    F --> G[Current Version]
    
    G -->|upgrade| D
    G -->|downgrade| C
    
    D --> H[Backup Before Migrate]
    H --> I[Apply Migration]
    I --> J[Verify Schema]
```

---

## –î–∏–∞–≥—Ä–∞–º–º–∞ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

```mermaid
sequenceDiagram
    participant Dev as Developer
    participant Alembic as Alembic Tool
    participant DB as SQLite DB
    participant App as Application
    
    Dev->>Alembic: alembic revision -m "add column"
    Alembic->>Alembic: create migration file
    Dev->>Dev: edit migration file
    Dev->>Alembic: alembic upgrade head
    Alembic->>DB: ALTER TABLE ...
    DB-->>Alembic: success
    Alembic->>DB: UPDATE alembic_version
    App->>DB: use new schema
```

---

## –°—Ç—Ä–∞—Ç–µ–≥–∏—è –º–∏–≥—Ä–∞—Ü–∏–π

### 1. –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã
- –ò—Å–ø–æ–ª—å–∑—É–µ–º Alembic –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
- –ö–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
- –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ git

### 2. –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- Backward compatibility –¥–ª—è 1 –≤–µ—Ä—Å–∏–∏ –Ω–∞–∑–∞–¥
- Deprecated –ø–æ–ª—è –ø–æ–º–µ—á–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
- Data migration –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç schema migration

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –¢–µ—Å—Ç–∏—Ä—É–µ–º upgrade –∏ downgrade
- –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–æ–ø–∏–∏ –ë–î
- Rollback –ø–ª–∞–Ω –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 4. Production deployment
- Backup –ë–î –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π
- –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤ maintenance window
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

---

## –°–Ω–∏–ø–ø–µ—Ç—ã

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Alembic

```bash
# —Ñ–∞–π–ª: TBD:TBD-TBD
```

### –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```python
# —Ñ–∞–π–ª: TBD:TBD-TBD
```

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```python
# —Ñ–∞–π–ª: backend/db.py:TBD-TBD
```

### Rollback –º–∏–≥—Ä–∞—Ü–∏–∏

```python
# —Ñ–∞–π–ª: TBD:TBD-TBD
```

### Data migration –ø—Ä–∏–º–µ—Ä

```python
# —Ñ–∞–π–ª: TBD:TBD-TBD
```

---

## –¢–∏–ø–æ–≤—ã–µ –æ—à–∏–±–∫–∏

### ‚ùå –û—à–∏–±–∫–∞: "Alembic version mismatch"

**–ü—Ä–∏—á–∏–Ω–∞:** –ë–î –Ω–∞ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏, –∫–æ–¥ —Ç—Ä–µ–±—É–µ—Ç –Ω–æ–≤—É—é.

**–†–µ—à–µ–Ω–∏–µ:**
```bash
alembic upgrade head
```

### ‚ùå –û—à–∏–±–∫–∞: "Migration failed halfway"

**–ü—Ä–∏—á–∏–Ω–∞:** –û—à–∏–±–∫–∞ –≤ migration —Å–∫—Ä–∏–ø—Ç–µ.

**–†–µ—à–µ–Ω–∏–µ:**
- –û—Ç–∫–∞—Ç–∏—Ç—å –Ω–∞ backup
- –ò—Å–ø—Ä–∞–≤–∏—Ç—å migration —Ñ–∞–π–ª
- –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–Ω–æ–≤–∞ —Å —Ç–µ—Å—Ç–∞–º–∏

### ‚ùå –û—à–∏–±–∫–∞: "SQLite locked during migration"

**–ü—Ä–∏—á–∏–Ω–∞:** –î—Ä—É–≥–æ–π –ø—Ä–æ—Ü–µ—Å—Å –¥–µ—Ä–∂–∏—Ç lock –Ω–∞ –ë–î.

**–†–µ—à–µ–Ω–∏–µ:**
- –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ connections –∑–∞–∫—Ä—ã—Ç—ã
- –í–∫–ª—é—á–∏—Ç—å WAL mode

---

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Alembic

```bash
cd backend
alembic init alembic
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ alembic.ini

```ini
sqlalchemy.url = sqlite:///keyset.db
```

### 3. –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
alembic revision -m "initial schema"
```

### 4. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```python
def upgrade():
    op.create_table(
        'accounts',
        sa.Column('id', sa.Integer, primary_key=True),
        sa.Column('name', sa.String(255)),
    )

def downgrade():
    op.drop_table('accounts')
```

### 5. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
alembic upgrade head
```

### 6. –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
alembic downgrade -1
```

---

## TL;DR

- **Alembic** ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
- **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî –∫–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã
- **Backward compatibility** ‚Äî 1 –≤–µ—Ä—Å–∏—è –Ω–∞–∑–∞–¥
- **Backup** ‚Äî –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π –º–∏–≥—Ä–∞—Ü–∏–µ–π
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî upgrade –∏ downgrade

---

## –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

- [ ] Alembic –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ –ø—Ä–æ–µ–∫—Ç–µ
- [ ] alembic.ini –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω—ã –≤ git
- [ ] –¢–µ—Å—Ç—ã –¥–ª—è upgrade –∏ downgrade
- [ ] Backup –ë–î –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π
- [ ] Rollback –ø–ª–∞–Ω –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] Data migrations –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç schema
- [ ] Production –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ maintenance window
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2024-11-10

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ [ARCHITECTURE_INDEX.md](./ARCHITECTURE_INDEX.md)
