# 06. –ü–∞—Ä—Å–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã KeySet-MVP

> **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø–∞—Ä—Å–∏–Ω–≥–∞ Yandex Wordstat —á–µ—Ä–µ–∑ CDP –∏ Playwright**

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–¶–µ–ª—å](#—Ü–µ–ª—å)
- [–î–ª—è –∫–æ–≥–æ](#–¥–ª—è-–∫–æ–≥–æ)
- [–°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã](#—Å–≤—è–∑–∞–Ω–Ω—ã–µ-–¥–æ–∫—É–º–µ–Ω—Ç—ã)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–∞—Ä—Å–µ—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–ø–∞—Ä—Å–µ—Ä–∞)
- [–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Ç–æ–∫–∞](#–¥–∏–∞–≥—Ä–∞–º–º–∞-–ø–æ—Ç–æ–∫–∞)
- [–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã](#–∫–ª—é—á–µ–≤—ã–µ-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
- [–°–Ω–∏–ø–ø–µ—Ç—ã –∫–æ–¥–∞](#—Å–Ω–∏–ø–ø–µ—Ç—ã-–∫–æ–¥–∞)
- [–¢–∏–ø–æ–≤—ã–µ –æ—à–∏–±–∫–∏](#—Ç–∏–ø–æ–≤—ã–µ-–æ—à–∏–±–∫–∏)
- [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](#–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)
- [TL;DR](#tldr)
- [–ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è](#—á–µ–∫-–ª–∏—Å—Ç-–ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è)

---

## –¶–µ–ª—å

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ø–∞—Ä—Å–∏–Ω–≥–∞ KeySet-MVP: TurboParser —Å CDP –ø–µ—Ä–µ—Ö–≤–∞—Ç–æ–º, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ 10 –≤–∫–ª–∞–¥–æ–∫ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç, N –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ~526 —Ñ—Ä–∞–∑/–º–∏–Ω—É—Ç—É.

## –î–ª—è –∫–æ–≥–æ

- Backend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏, —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å –ø–∞—Ä—Å–µ—Ä–æ–º
- DevOps –∏–Ω–∂–µ–Ω–µ—Ä—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- QA –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
- Tech Lead –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [02_AUTHENTICATION.md](./02_AUTHENTICATION.md) ‚Äî –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ cookies
- [03_ACCOUNTS_PROFILES.md](./03_ACCOUNTS_PROFILES.md) ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏
- [04_PROXY_CONNECTIONS.md](./04_PROXY_CONNECTIONS.md) ‚Äî –ø—Ä–æ–∫—Å–∏ —Å–∏—Å—Ç–µ–º–∞
- [07_GEO_SYSTEM.md](./07_GEO_SYSTEM.md) ‚Äî –ø–æ–¥–º–µ–Ω–∞ —Ä–µ–≥–∏–æ–Ω–∞
- [11_DATA_FLOW.md](./11_DATA_FLOW.md) ‚Äî –ø–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
- [14_LOGGING_OBSERVABILITY.md](./14_LOGGING_OBSERVABILITY.md) ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–∞—Ä—Å–µ—Ä–∞

```mermaid
graph TD
    A[MultiParsingWorker] -->|N –∞–∫–∫–∞—É–Ω—Ç–æ–≤| B1[TurboParser #1]
    A -->|–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ| B2[TurboParser #2]
    A -->|–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ| B3[TurboParser #N]
    
    B1 -->|10 –≤–∫–ª–∞–¥–æ–∫| C1[Tab 1]
    B1 --> C2[Tab 2]
    B1 --> C3[Tab 10]
    
    C1 -->|CDP –ø–µ—Ä–µ—Ö–≤–∞—Ç| D[Chrome DevTools Protocol]
    C2 --> D
    C3 --> D
    
    D -->|–∑–∞–ø—Ä–æ—Å—ã| E[Yandex Wordstat API]
    E -->|JSON –æ—Ç–≤–µ—Ç—ã| D
    
    D -->|–ø–∞—Ä—Å–∏–Ω–≥| F[freq_results ‚Üí DB]
    
    G[Phrases Queue] -->|—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ| B1
    G --> B2
    G --> B3
```

## –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Ç–æ–∫–∞

**–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑—ã:**

```mermaid
sequenceDiagram
    participant UI as Frontend UI
    participant API as FastAPI
    participant MP as MultiParsingWorker
    participant TP as TurboParser
    participant Tab as Browser Tab
    participant CDP as Chrome CDP
    participant YA as Yandex API
    participant DB as SQLite DB
    
    UI->>API: POST /api/wordstat/start
    API->>MP: init_parsing_task(phrases, accounts)
    MP->>TP: assign phrases to TurboParser
    TP->>Tab: create 10 parallel tabs
    Tab->>CDP: enable Network & Fetch domains
    CDP->>YA: intercept /api/v2/keyword/frequency
    YA-->>CDP: JSON {shows, clicks, region}
    CDP-->>Tab: parse response
    Tab-->>TP: aggregate results
    TP-->>MP: return stats
    MP-->>DB: INSERT INTO freq_results
    DB-->>API: task completed
    API-->>UI: WebSocket update
```

---

## –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. TurboParser

–û—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ä—Å–µ—Ä —Å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º–∏ –≤–∫–ª–∞–¥–∫–∞–º–∏.

### 2. MultiParsingWorker

–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –¥–ª—è N –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.

### 3. CDP (Chrome DevTools Protocol)

–ü–µ—Ä–µ—Ö–≤–∞—Ç –∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

### 4. Phrase Distribution

–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ—Ä–∞–∑ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏.

---

## –°–Ω–∏–ø–ø–µ—Ç—ã –∫–æ–¥–∞

### TurboParser –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```python
# —Ñ–∞–π–ª: keyset/workers/turbo_parser_working.py:TBD-TBD
```

### CDP –ø–µ—Ä–µ—Ö–≤–∞—Ç –∑–∞–ø—Ä–æ—Å–æ–≤

```python
# —Ñ–∞–π–ª: keyset/workers/cdp_frequency_runner.py:TBD-TBD
```

### MultiParsingWorker –∑–∞–ø—É—Å–∫

```python
# —Ñ–∞–π–ª: keyset/services/multiparser_manager.py:TBD-TBD
```

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ—Ä–∞–∑

```python
# —Ñ–∞–π–ª: keyset/workers/turbo_parser_working.py:TBD-TBD
```

---

## –¢–∏–ø–æ–≤—ã–µ –æ—à–∏–±–∫–∏

### ‚ùå –û—à–∏–±–∫–∞: "Chrome process crashed"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Ö–≤–∞—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏–ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:**
- –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
- –£–≤–µ–ª–∏—á–∏—Ç—å RAM
- –ó–∞–∫—Ä—ã—Ç—å –ª–∏—à–Ω–∏–µ Chrome –ø—Ä–æ—Ü–µ—Å—Å—ã

### ‚ùå –û—à–∏–±–∫–∞: "CDP session closed unexpectedly"

**–ü—Ä–∏—á–∏–Ω–∞:** –í–∫–ª–∞–¥–∫–∞ –∑–∞–∫—Ä—ã–ª–∞—Å—å –∏–ª–∏ –∑–∞–≤–∏—Å–ª–∞.

**–†–µ—à–µ–Ω–∏–µ:**
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å retry –ª–æ–≥–∏–∫—É
- –î–æ–±–∞–≤–∏—Ç—å timeout –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫

### ‚ùå –û—à–∏–±–∫–∞: "No responses intercepted"

**–ü—Ä–∏—á–∏–Ω–∞:** CDP –Ω–µ —É—Å–ø–µ–ª –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Network domain.

**–†–µ—à–µ–Ω–∏–µ:**
- –í–∫–ª—é—á–∞—Ç—å CDP –ø–µ—Ä–µ—Ö–≤–∞—Ç –¥–æ –ø–µ—Ä–≤–æ–≥–æ navigate
- –î–æ–±–∞–≤–∏—Ç—å –æ–∂–∏–¥–∞–Ω–∏–µ –ø–æ—Å–ª–µ enable
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞

---

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏–∑ Python

```python
from keyset.services.multiparser_manager import MultiParsingManager

manager = MultiParsingManager()
task_id = await manager.start_parsing(
    phrases=["–∫—É–ø–∏—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É", "–∞—Ä–µ–Ω–¥–∞ –¥–æ–º–∞"],
    account_ids=[1, 2, 3],
    region_id=213  # –ú–æ—Å–∫–≤–∞
)
```

### 2. –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ API

```bash
curl -X POST http://localhost:8000/api/wordstat/start \
  -H "Content-Type: application/json" \
  -d '{
    "phrases": ["–∫—É–ø–∏—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É"],
    "account_ids": [1],
    "region_id": 213
  }'
```

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–∞

```python
status = await manager.get_task_status(task_id)
print(f"Processed: {status['processed']}/{status['total']}")
```

---

## TL;DR

- **TurboParser** ‚Äî 10 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤–∫–ª–∞–¥–æ–∫ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç
- **MultiParsingWorker** ‚Äî N –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- **CDP –ø–µ—Ä–µ—Ö–≤–∞—Ç** ‚Äî –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è API –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ª–µ—Ç—É
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚Äî ~526 —Ñ—Ä–∞–∑/–º–∏–Ω—É—Ç—É (5 –∞–∫–∫–∞—É–Ω—Ç–æ–≤ √ó 10 –≤–∫–ª–∞–¥–æ–∫)
- **Retry –ª–æ–≥–∏–∫–∞** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- **Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** ‚Äî —á–µ—Ä–µ–∑ WebSocket

---

## –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

- [ ] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Chrome/Chromium –≤ —Å–∏—Å—Ç–µ–º–µ
- [ ] Playwright —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] CDP –ø–µ—Ä–µ—Ö–≤–∞—Ç –≤–∫–ª—é—á–µ–Ω –ø–µ—Ä–µ–¥ navigate
- [ ] –ê–∫–∫–∞—É–Ω—Ç—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –∏ –∏–º–µ—é—Ç –≤–∞–ª–∏–¥–Ω—ã–µ cookies
- [ ] –ü—Ä–æ–∫—Å–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)
- [ ] –§—Ä–∞–∑—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏
- [ ] Retry –ª–æ–≥–∏–∫–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –¥–ª—è –æ—à–∏–±–æ–∫
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- [ ] –¢–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
- [ ] –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2024-11-10

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** [07_GEO_SYSTEM.md](./07_GEO_SYSTEM.md) ‚Äî –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞
