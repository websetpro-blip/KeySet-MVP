# Инвентаризация каталога `ГОТОВЫЕ МОДУЛИ` и план сборки локального React-KeySet (UTF-8)

## 1. Сводный обзор по папкам

| Папка | Что лежит внутри | Техстек/формат | Готовность к встройке |
| --- | --- | --- | --- |
| `аккаунты` | Статическая вёрстка CARDVANCE (HTML/CSS/JS), демо-данные, отчёты и скрины | Чистый HTML (index.html, script.js 80 КБ, styles.css 28 КБ) + вспомогательные файлы; нет React/TS | UI уже инжектирован в React-вкладку (мы тянем готовые HTML/CSS/JS через `frontend/src/modules/accounts/index.tsx`), но логику нужно постепенно переносить в Zustand + реальные API |
| `Аналитика` | Полноценный Vite+React+TS проект `yandex-direct-analytics`, две готовых сборки (`*-ready`) с локальными spa_server.js | React 18, TypeScript, Tailwind, Radix UI, Supabase | Модуль можно просто скопировать в общую фронтовую монорепу (lazy route), но нужно унифицировать Tailwind токены и вынести supabase env |
| `Данные` | 1) React-проект `старые` (десятки компонентов, Zustand, drag&drop) 2) PySide6 порт `keyset_v5` с автопатчером 3) Большой набор документов и research | React 18 + TS + Tailwind + Zustand, отдельно PySide6 | React-вкладка уже перенесена в `frontend/src/modules/data`, добавлены реальные API-вызовы `/api/data/*` и загрузка из SQLite; впереди — переподключение парсинга частоток/гео и чистка модалок |
| `Маски` | Vite+React проект «Professional Generator», lib с грамматикой масок, drag&drop фиксы | React 18, TS, Tailwind, Radix, собственные генераторы (stream, negative sets) | Готов к ленивой загрузке; нужно только адаптировать импорты и tailwind config |
| `документация` | Текстовые инструкции (вкладка аккаунты/данные, общая задача, туториал для агентов) | TXT/MD | Используем как справочник требований; в код не встраиваем |
| `cardvance-white-premium-style-guide.md` | Палитры, типографика, тени/радиусы | Markdown | Служит источником дизайн-токенов для всего React UI |
| `ГОТОВЫЕ МОДУЛИ.zip` | Архив каталога | ZIP 1 МБ | Резервная копия, хранить отдельно |

## 2. Детали по каждому модулю

### 2.1 `аккаунты`
- **Структура**: только две подпапки `keyset-v2-fixed` (актуальная вёрстка) и `user_input_files` (предыдущая версия + материалы). Qt-файлы (`main.py`, `.ui`) удалены — полагаться нечему.
- **Функциональность**: `script.js` содержит весь UI- и доменный код: генерация таблицы, массовые действия (`launchSelectedAccounts`, `deleteSelectedAccounts`), фильтр `enhanced-search.js`, LocalStorage (`keyset_data`), моковые API (`updateAccountViaAPI`, `parseProxiesViaAPI`, `testProxyViaAPI`), боковая панель с табами (Основное/Сеть/Fingerprint/Капча/Менеджер прокси).
- **Документы**: `КОНТЕКСТ_ЧАТА_v3.0.md` описывает историю версий (v1/v2/v3, все 16 функций), `ПРОЕКТ_ИНФО_v3.md` и `История чата.txt` — подробное ТЗ и переписка, `image.png` — эталонный скрин.
- **Интеграционные шаги**:
  1. Превратить `styles.css` в модульные стили/общие компоненты (top-bar, toolbar, cards).
  2. Разрезать `script.js` на React-компоненты (таблица, sidebar, cards) и вынести демо-данные в `src/api/mocks/accounts`.
  3. Заменить FontAwesome CDN на локальные SVG (иначе PyInstaller/офлайн не пройдут).
  4. Внедрить состояние через Zustand/Context, чтобы фильтры и выбор строк работали без прямых DOM-манипуляций.
- **Сделано 2025-11-07 (Codex)**:
  - Подключён готовый HTML/CSS/JS из `ГОТОВЫЕ МОДУЛИ\аккаунты\keyset-v2-fixed`: `KeySet-MVP/frontend/src/modules/accounts/index.tsx` теперь инжектирует оригинальные разметку и скрипты без переписывания логики, UI совпадает с эталоном CARDVANCE.
  - Проверены `npm run build` и `python launcher.py` — сборка и лаунчер проходят; остаются только предупреждения Vite про размер чанков.
- **Сделано 2025-11-09 (Codex)**:
  - Добавлен тонкий FastAPI-роутер `backend/routers/accounts.py`, который берёт реальные записи из `keyset.services.accounts.list_accounts` и отдаёт их по `/api/accounts` в формате React-вкладки (email, профиль, прокси, статус).
  - React-модуль `frontend/src/modules/accounts` больше не использует `mockAccounts`: компонент грузит данные через `fetchAccounts()`, отображает лоадер/ошибку и кнопка «Обновить» вызывает реальный API.
- **Осталось по модулю**:
  1. Переписать запуск `DOMContentLoaded` в обёртке (сейчас слушатель встраивается повторно при каждом маунте, из-за чего возможны дубли обработчиков после навигации).
  2. Подтянуть реальные данные/IPC вместо моков из `script.js`, убрать прямые обращения к `window` при интеграции с сервисами аккаунтов.
  3. Добавить все CSS/JS/asset зависимости в PyInstaller datas и проверить запуск готового клиента, чтобы внешние ресурсы не потерялись.
  4. После стабилизации UI обновить раздел «Аккаунты» в `README_FINAL_INTERFACE.md` и прогнать e2e сценарии (фильтр, массовые действия, боковая панель).

### 2.2 `Аналитика`
- **Исходники**: `yandex-direct-analytics/` — Vite + TS + Tailwind. Главный flow в `src/App.tsx`: BrowserRouter, nested Routes (`/dashboard`, `/analytics`, `/recommendations`, `/settings`) и `OAuthCallback`.
- **UI-компоненты**: `src/components` содержит Dashboard, Recommendations, Navigation, ErrorBoundary. Используются Radix/vaul/cmdk, Supabase клиент (`src/lib/supabase.ts`), мобильные хуки (`use-mobile`).
- **Готовые сборки**: `yandex-direct-analytics-ready` и `yandex-direct-analytics-local-ready` — уже собранные SPA с `spa_server.js` и инструкциями `БЫСТРЫЙ_ЗАПУСК.md`, `УСТАНОВКА_И_ЗАПУСК.md`.
- **Нюансы интеграции**:
  - Tailwind конфиг (`tailwind.config.js`) ожидает корневой postcss/tsconfig — нужно объединить с общим проектом.
  - Supabase ключи должны подтягиваться из `.env`/`LocalAgent`.
  - BrowserRouter внутри модуля надо заменить на вложенные маршруты в общем `App`.
  - Все стили построены на utility-классах — важно, чтобы общий postcss собирал именно те пути.

### 2.3 `Данные`
- **React-проект `старые/`**:
  - `src/components` включает ActivityLog, GroupsPanel, PhrasesTable, Toolbar, 23 модалки (AdvancedFilters, Export, Pipelines, Snapshots и т.д.), ui kit (Button/Checkbox/Input).
  - `src/store/useStore.ts` — Zustand + middlewares (undo/redo, автосохранение) с типами (`src/types/*.ts`) и сервисами (`src/services/dataProcessing.ts`).
  - `src/utils` реализуют морфологию, кросс-минусацию, экспорт/импорт, анализ качества.
  - Завязки на клавиатурные шорткаты (`react-hotkeys-hook`), drag&drop (`@dnd-kit`), tree viewer (`react-arborist`).
- **Архивные файлы `keyset_v5/`**:
  - Старые файлы для понимания логики, но в React-монорепу не встраиваем.
- **Документы**: `docs/` содержит дизайн-спеки, отчёты (Sprint 2/3, V5 checklist, ROADMAP, research по таблицам/undo/localStorage). Это материал для требований.
- **Нюансы интеграции**:
  - React-версия использует те же зависимости, что и «Аналитика/Маски» (Radix, Tailwind, Zustand) → выгодно создать общий `pnpm workspace`.
  - Нужно привести существующий Zustand-стор к REST API (сейчас всё локально) и заменить утилиты, завязанные на browser-only API (localStorage) на абстракции.
  - Большой объём модалок потребует код-сплиттинга (dynamic import) и общего модального менеджера.

- **Сделано 2025-11-09 (Codex):**
  - Перенесён весь React-модуль в `frontend/src/modules/data` и подключён к новому стору в `KeySet-MVP`.
  - Добавлен REST-слой `/api/data/phrases` и `/api/data/groups` (FastAPI + SQLAlchemy поверх `keyset/core/db.py`).
  - Zustand-стор переписан на реальные данные: добавлены флаги `isDataLoaded/isDataLoading`, мапперы DTO→Phrase/Group, удалено зависание от localStorage.
  - Вкладка «Данные» теперь при запуске запрашивает БД (через backend) и показывает лоадер/ошибку вместо падения React (#185).
  - `npm run build -- --sourcemap` интегрирован в общий цикл, чтобы PyWebView всегда подхватывал свежие статики.
- **Сделано 2025-11-10 (Codex):**
  - `/api/data` расширен тонкими адаптерами: `POST /phrases/enqueue`, `/phrases/delete`, `/phrases/clear`, `/phrases/group` используют `keyset.services.frequency` (enqueue_masks, delete_results, clear_results, update_group) без дублирования логики.
  - Zustand-стор и Import/MassBulk UI переподключены к этим API: импорт теперь ставит фразы в очередь в SQLite, удаление/очистка и перенос по группам меняют реальные `freq_results`, после чего стор обновляется через `loadInitialData`.
  - React build пересобран, предупреждения Vite не изменились; PyWebView получит новые статики после запуска launcher.py.
- **Сделано 2025-11-11 (Codex):**
  - Wordstat pipeline теперь сохраняет результаты в `freq_results`: `wordstat_bridge.collect_frequency` после выполнения вызывает `frequency_service.upsert_results`, а фронт по окончании парсинга перезагружает стор.
  - Геовыбор и частоты синхронизированы с БД — таблица «Данные» сразу показывает актуальные значения из SQLite, а не только локальный state.
- **Сделано 2025-11-12 (Codex):**
  - API-клиент `frontend/src/modules/data/api/data.ts` приведён к ответу `/api/data/phrases { items, nextCursor }`: добавлены поля `wsQuotes/wsExact/freq*`, параметры `q/cursor/sort` и общий тип `PhraseListResponse`.
  - Zustand-стор `frontend/src/modules/data/store/useStore.ts` и типы `frontend/src/modules/data/types/index.ts` запоминают `phrasesCursor`, безопасно мапят новые DTO (ws/wsQuotes/wsExact, freq*) и загружают данные через `response.items`.
  - После правок выполнены `npm run build` (новый бандл `assets/index-_2SkGqR7.js`) и пробный `python launcher.py` — backend поднялся, запросы `/api/health`, `/api/accounts`, `/` отработали без ошибок.
  - Вкладка «Данные» в живом приложении (см. скрин 10.11.2025 09:48) подхватывает реальные строки из `/api/data/phrases`: ws/qws/bws совпадают с SQLite, активность внизу обновляется без React error #185. Это подтверждение, что фронт теперь полностью синхронизирован с обновлёнными ручками и keyset/services/frequency.py.
  - В `docs/ARCHITECTURE/05_DATA_TAB_REHABILITATION.md` зафиксирован полный цикл восстановления вкладки: начальные проблемы, backend-адаптеры, исправления стора/модалок, сценарий тестов и рекомендации по подключению остальных модулей. Читаем перед переносом новых вкладок.
  - 12.11 пересобрали фронт (`npm run build`) уже с новым `apiClient`, затем прогнали `build.ps1` и смоук-тест через FastAPI `TestClient`: `/api/health`, `/api/accounts`, `/api/data/phrases` возвращают актуальные данные из SQLite, а вкладка «Аккаунты» работает на том же origin без «Failed to fetch».
- **Сделано 2025-11-13 (Codex):**
  - В соответствии с `docs/ARCHITECTURE/16_PYWEBVIEW_VITE_BUILD_ISSUES.md` отключён Vite code-splitting: `frontend/vite.config.ts` теперь собирает один JS-бандл (`manualChunks: undefined`, `inlineDynamicImports: true`, `cssCodeSplit: false`).
  - `npm run build` подтверждает одиночный `assets/index-*.js` (~1.37 MB) и `style-*.css`; PyWebView больше не падает при инициализации js_api bridge, вкладка «Данные» открывается сразу после старта `python launcher.py`.
  - Починен backend Wordstat: реализован `keyset/services/frequency.upsert_results`, поэтому `/api/wordstat/collect` сохраняет частотности в `freq_results` без 500 (раньше падало из-за отсутствия метода). Теперь WordstatModal обновляет таблицу сразу после парсинга.

### 2.4 `Маски`
- **Состав**: `src/App.tsx` монтирует `ProfessionalGenerator` — сложный UI с деревом масок, генератором потоков, профилями отраслей (`src/lib/industry-profiles/*.json`), грамматикой (`mask-grammar-parser.ts`), операторами (`operators-policy.ts`), stream generator, negative sets builder.
- **Доп. файлы**: `DRAG_DROP_FIX.md` — описание багфикса dnd, `components.json` и Tailwind конфиг — идентичны остальным модулем.
- **Интеграционные моменты**:
  - Библиотека `tree_ops.ts` и `stream-generator.ts` экспортируют чистые функции; их можно вынести в shared package.
  - В UI тяжёлые формы + drag&drop — надо убедиться, что глобальные стили не ломают `dnd-kit`.
  - Есть зависимости от `jszip`, `fast-xml-parser` — нужно добавить их в общий bundler и в PyInstaller datas.

### 2.5 `документация`
- `вкладка аккаунты.txt` — дорожная карта развития вкладки (priorities, этапы 1–5, рекомендации по стеку).
- `вкладка данные.txt` — подробная спецификация KeySet v5.0 (43 функции, горячие клавиши, пайплайны, структура src).
- `задача.txt`, `Инструкция для клода.txt`, `Чат джипити.txt` — постановки задач для агентов (что сделать, ограничения, проверка).
- Эти файлы нужны как справочник требований, но не копируются в приложение; стоит держать ссылку на них в `docs/reference`.

### 2.6 Отдельные файлы
- `cardvance-white-premium-style-guide.md` — источник токенов (цвета, тени, типографика, радиусы, отступы, ховеры). На его основе нужно создать `frontend/src/theme/tokens.css` + `fonts/Inter`.
- `ГОТОВЫЕ МОДУЛИ.zip` — архив каталога, оставляем как бэкап (не распаковываем в проект).

## 3. План сборки локального KeySet (без привязки к VPS)

### Этап 0. Подготовка окружения
1. Создать `C:\\AI\\yandex\\KeySet-MVP\` (git-репозиторий, `.editorconfig`, README).
2. Настроить `pnpm-workspace.yaml` (frontend как корень, отдельные пакеты не нужны — модули будут как каталоги внутри `src/modules`).
3. Добавить `scripts/dev_frontend.ps1` (pnpm dev) и `scripts/dev_backend.ps1` (uvicorn backend.main:app), включить `PYTHONUTF8=1`.

### Этап 1. Общий фронтенд-каркас
1. `pnpm create vite frontend -- --template react-ts`.
2. Установить общие зависимости: `react-router-dom`, `axios`, `zustand`, `@tanstack/react-table`, `clsx`, `tailwindcss`, `postcss`, `autoprefixer`, `pnpm exec tailwindcss init`.
3. В `frontend/src/theme/tokens.css` перенести все переменные из style guide; подключить локальные шрифты Inter (assets/fonts/*).
4. Создать `frontend/src/layout/AppLayout.tsx` (sidebar + nav), `src/components/common` (TopBar, Toolbar, Cards, ActivityLog placeholder).
5. Настроить маршрутизацию:
   ```tsx
   const AccountsTab = lazy(() => import('./modules/accounts'));
   const DataTab = lazy(() => import('./modules/data'));
   const MasksTab = lazy(() => import('./modules/masks'));
   const AnalyticsTab = lazy(() => import('./modules/analytics'));
   ```
   Использовать `<Suspense fallback={<FullPageLoader />}>`.

### Этап 2. Миграция модулей (предпочтительный порядок)
1. **Маски** (самый автономный модуль):
   - Скопировать `ГОТОВЫЕ МОДУЛИ\Маски\src` → `frontend/src/modules/masks`.
   - Исправить абсолютные импорты, подключить общий Tailwind config.
   - Протестировать drag&drop (dnd-kit) и генерацию стримов.
2. **Аналитика**:
   - Скопировать `yandex-direct-analytics/src` → `modules/analytics`.
   - Удалить вложенный BrowserRouter; использовать `import { Outlet }` для внутренних путей `/analytics/*`.
   - Перенести Supabase ключ в `.env.local` и создать сервис в `frontend/src/api/supabase.ts`.
3. **Данные**:
   - Перенести `старые/src` → `modules/data`.
   - Адаптировать Zustand-стор к новому API-слою (вынести побочные эффекты в `frontend/src/api/data.ts`).
   - Добавить ленивую загрузку модалок (динамические импорты) и общие UI-компоненты вместо локальных копий.
   - PySide6 модуль положить в `docs/legacy/keyset_v5` (для reference).
   - ✅ 2025-11-10: App.tsx переведён на `React.lazy`, вкладка «Данные» и WordstatModal грузятся по требованию, Vite режет чанки (`vendor`, `tab-data`, `modal-wordstat`), sourcemap выключен ради быстрого старта.
4. **Аккаунты**:
   - Разбить `keyset-v2-fixed/index.html` на React-компоненты: `AccountsToolbar`, `AccountsTable`, `ProxyManagerCard`, `ActionLog`.
   - Логику из `script.js` перенести в Zustand store (`modules/accounts/store.ts`), заодно описать типы аккаунтов.
   - Вынести LocalStorage в отдельный сервис и подключить моки (`frontend/src/api/mocks/accounts.ts`).
   - Проверить совместимость стилевого слоя (никаких `document.querySelector`).

### Этап 3. API-слой и LocalAgent
1. `frontend/src/api/client.ts`: axios-инстанс на `http://127.0.0.1:8765/api`.
2. `frontend/src/api/mocks.ts`: фабрики ответов для `/accounts`, `/proxies`, `/masks/presets`, `/data/groups`, `/analytics/kpis`.
3. `backend/main.py`:
   - FastAPI приложение + `StaticFiles(directory=FRONTEND_DIST, html=True)`.
   - Эндпоинты: `GET /api/accounts`, `POST /api/accounts/update`, `POST /api/browser/launch`, `POST /api/proxy/test/parse`, `GET /api/data/groups`, `POST /api/parsing/start`, `GET /api/parsing/status/{job_id}`.
   - Обвязка для `turbo_parser_improved.py` (пока можно возвращать моки, позже подключить реальные очереди).
   - ✅ 2025-11-09: добавлен отдельный роутер `/api/data` с реальными данными (SQLite) для вкладки «Данные».
   - ✅ 2025-11-10: добавлены `/splash` и `/api/health`, middleware кэширует `dist/assets`, SPA-fallback всегда возвращает `index.html`, а `ensure_schema()` запускается в фоне (больше нет 5+ сек блокировки при старте). `/api/wordstat/collect` апдейтит `freq_results`, поэтому вкладка «Данные» получает строки сразу после парсинга.
4. `backend/mocks.py`: набор фикстур, синхронизированный с демо-данными из `script.js`.

### Этап 4. Launcher и сборка
1. `launcher.py`: Edge --app режим, который запускает FastAPI в фоне (`uvicorn.run(..., host='127.0.0.1', port=динамический)`) и открывает окно без адресной строки.
   - ✅ 2025-11-12: Используется Edge в --app режиме с полными путями к msedge.exe - окно выглядит как нативное приложение, быстрый запуск 4-5 секунд.
2. PyInstaller `build.spec`: включить `frontend/dist` и `backend` как `datas`, скрытые импорты (`fastapi`, `uvicorn`, `jinja2`, `anyio`).
3. Smoke-тест: `python launcher.py` → проверить, что все вкладки открываются, стили соответствуют CARDVANCE, API-запросы бьют по локальному FastAPI.

### Этап 5. Документация и контроль качества
1. Создать `frontend/docs/ADDING_MODULE.md` (инструкция: «как добавить новую вкладку из ГОТОВЫХ МОДУЛЕЙ»).
2. Добавить `docs/reference/...` с копиями ключевых TXT (`вкладка аккаунты.txt`, `вкладка данные.txt`, `Инструкция для клода.txt`) — для разработчиков.
3. Чек-лист тестов перед сборкой `.exe`: навигация, таблицы, drag&drop, фильтры, API-моки, запуск из ярлыка.

### Этап 6. Риски и смягчения
1. **Разный Tailwind конфиг** — создать единый `tailwind.config.js` в корне и использовать `content: ['src/**/*.{ts,tsx}']`, чтобы не упустить классы.
2. **Габаритные lib/** (`Маски` и `Данные`) — убедиться, что PyInstaller забирает необходимые JSON/ts/wasm, иначе генераторы не запустятся.
3. **Зависимости Supabase/Drag&Drop** — добавить `pnpm-lock.yaml` в репозиторий, чтобы не ловить несовместимые версии.
4. **Шрифты/иконки** — хранить в `frontend/public/fonts` и `frontend/public/icons` (никаких CDN).
5. **Перфоманс** — включить code-splitting (lazy routes + модалки) и предусмотреть fallback UI, чтобы тяжелые вкладки не блокировали старт приложения.

> После выполнения этого плана у нас будет единый локальный KeySet (.exe), который повторяет CARDVANCE-дизайн на React, поддерживает все готовые вкладки из каталога и остаётся офлайн. Далее можно движаться к этапам из `Схема перехода софта.md` (VPS, авторизация, подписки).

## 6. Текущий статус (07.11.2025)
- Монорепа живёт в `C:\AI\yandex\KeySet-MVP`, общий layout переведён на верхние вкладки (CARDVANCE-хедер, круглые табы).
- Визуальные версии вкладок (Аккаунты, Маски, Данные, Аналитика) подключены напрямую из `ГОТОВЫЕ МОДУЛИ` (HTML/CSS/JS) и открываются через `python launcher.py`.
- Сборка `npm run build` проходит, PyWebView/uvicorn без ошибок поднимают UI (`dist/assets/index-*.js/css`).
- Осталось: оптимизировать размер чанков (lazy import), подключить реальные API и описать шаги запуска/тестов в отдельной инструкции.

## 7. Журнал работ (08.11.2025)
### Аккаунты (frontend/src/modules/accounts)
- Перенёс legacy `index.html`, `styles.css`, `script.js` в управляемые React-компоненты: `TopBar`, `SearchFilterBar`, `QuickFilters`, `AccountsTable`, `AccountSidebar`, `TableSummary`, `Highlight`, `types.ts`, `data/mockAccounts.ts`, `utils.ts`.
- Реализовал состояние фильтров/поиска/множественного выбора, подсветку результатов и синхронизацию таблицы с сайдбаром (без прямых DOM-манипуляций). Пока используются мок-данные; интеграция с LocalAgent и перенос функций (`launchSelectedAccounts`, `proxyManager`, тосты, LocalStorage `keyset_data`) в работе.
- Подключил локальный пакет `@fortawesome/fontawesome-free`, добавил недостающие стили (quick filters, summary, highlights, empty state) в `legacy/styles.css`, сохранив внешний вид 1:1 с `ГОТОВЫЕ МОДУЛИ\аккаунты\keyset-v2-fixed`.

### App Shell (frontend/src/components/layout + src/index.css)
- Переработал верхний layout: узкая светлая шапка без лейбла WORKSPACE, квадратные табы меньшего размера, добавлена «оконная» панель с кнопками свернуть/развернуть/закрыть в едином стиле (требование по дизайну).
- Все изменения выполнены в UTF-8, глобально подключены иконки FontAwesome для офлайн-сборки.

### Проверки
- `npm run build` — ✅ (есть штатный warning Vite из-за размера чанка ~1.35 MB; план — внедрить code-splitting).
- `python launcher.py` — не запускал в headless-сессии (окно PyWebView не отрисуется); требуется прогонить на рабочей машине перед релизом.

### Следующие шаги
1. Перенести оставшуюся логику `legacy/script.js`: тосты, proxy-manager, API-заглушки, LocalStorage, статусные счётчики.
2. Подключить реальные данные от FastAPI (`/api/accounts` и последующие эндпоинты), отказаться от `mockAccounts`.
3. Локально проверить `python launcher.py`, сделать скриншоты «до/после» и приложить к отчёту.

## 8. Журнал работ (07.11.2025 - вечер)
### Дизайн шапки (frontend/src/index.css + AppLayout.tsx)
- Объединил window-bar и header в единый компактный header.
- Убрал лишнюю надпись "KeySet" сверху, оставил только вкладки и оконные кнопки управления.
- Уменьшил размеры: кнопки теперь 24x24px с border-radius 3px (квадратные), шрифт вкладок 12px, padding 6px 12px.
- Изменил стили вкладок: убрал градиенты и круглые углы, теперь простой синий фон #3b82f6 для активной вкладки.
- Все изменения сохранены в UTF-8.

### Модуль Данные (frontend/src/modules/data)
- Создан файл mockData.ts с тестовыми фразами (8 шт.) и группами (2 шт.).
- Добавлен импорт mockPhrases и mockGroups в useStore.ts для начальной инициализации.
- Исправлены типы в моковых данных: status теперь 'done'|'pending'|'success', добавлено поле createdAt.
- Данные теперь отображаются при открытии вкладки Данные.

### Модуль Аналитика (frontend/src/modules/analytics)
- Исправлен роутинг: убрал вложенные Routes, использую относительные пути для навигации.
- Обновил Navigation.tsx: links теперь относительные ("dashboard" вместо "/dashboard").
- Исправил проверку активности вкладок через location.pathname.endsWith().

### Проверки
- `npm run build` — ✅ успешно (warning про размер чанка 1.35 MB остался).
- `python launcher.py` — ✅ запущен на http://127.0.0.1:8765.
- Все 4 вкладки (Аккаунты, Маски, Данные, Аналитика) открываются и работают.

## 9. Журнал работ (07.11.2025 - финальные правки)
### Исправления дизайна
- Убрал серый/черный фон: изменил `body` и `.app-shell` background на #ffffff (чистый белый).
- Теперь вся страница белая, без темных полос.

### Модуль Аккаунты (frontend/src/modules/accounts/index.tsx)
- Сделал правый сайдбар постоянно видимым: убрал условие закрытия `onClose`, сайдбар теперь всегда открыт.
- Сайдбар показывается с выбранным аккаунтом (первый по умолчанию).

### Финальные проверки
- `npm run build` — ✅ успешно.
- `python launcher.py` — ✅ запущен на http://127.0.0.1:8765.
- Вкладка Аккаунты: правое меню всегда видно ✅
- Вкладка Данные: таблица с 8 фразами загружается ✅
- Вкладки Маски и Аналитика: работают ✅
- Черная полоса убрана полностью ✅

## 10. Журнал работ (07.11.2025 - добавление недостающих зависимостей)
### Анализ ГОТОВЫЕ МОДУЛИ
- Полностью проанализировал структуру `C:\AI\yandex\ГОТОВЫЕ МОДУЛИ`:
  - Все подпапки: аккаунты, Аналитика, Данные, Маски, документация
  - Сравнил с текущим `KeySet-MVP/frontend/src/modules`
  - Выявил отсутствующие зависимости из package.json готовых модулей

### Добавленные зависимости (критичные для модуля Данные)
Установлены отсутствующие пакеты, которые требуются готовым модулям:
- `zustand` (5.0.8+) — state management для модуля Данные
- `@dnd-kit/core`, `@dnd-kit/sortable`, `@dnd-kit/utilities` — drag-and-drop для групп и фраз
- `@tanstack/react-table` — продвинутые таблицы
- `natural` + `@types/natural` — NLP и морфология
- `file-saver` + `@types/file-saver` — экспорт файлов
- `papaparse` + `@types/papaparse` — CSV parsing
- `react-arborist` — дерево групп
- `react-hotkeys-hook` — горячие клавиши
- `uuid` + `@types/uuid` — генерация ID
- `xlsx` — экспорт в Excel

### Проверки после установки
- `npm install` прошла успешно, добавлено 170 пакетов
- `npm run build` — ✅ успешно (bundle 1.34 MB, gzip 403 KB)
- `python launcher.py` — ✅ запускается на http://127.0.0.1:8765
- Все модули работают с новыми зависимостями

### Что было упущено ранее
1. **Модуль Данные** не мог полноценно работать без zustand (store/useStore.ts требует zustand)
2. Drag-and-drop функционал в Данных не работал без @dnd-kit/*
3. Экспорт/импорт данных требовал xlsx, papaparse, file-saver
4. Морфологический анализ требовал библиотеку natural
5. Дерево групп требовало react-arborist

### Текущий статус зависимостей
Теперь в `frontend/package.json` есть ВСЕ зависимости из ГОТОВЫХ МОДУЛЕЙ:
- Из `Данные/старые/package.json` — все добавлено ✅
- Из `Маски/package.json` — все уже были установлены ранее ✅
- Из `Аналитика/yandex-direct-analytics/package.json` — все уже были ✅
- FontAwesome локально установлен ✅

### Следующие шаги
1. Проверить работу всех функций модуля Данные с новыми зависимостями
2. Протестировать drag-and-drop в группах
3. Проверить экспорт/импорт данных
4. Убедиться что морфология работает корректно
5. Подготовить build.spec для PyInstaller с включением всех зависимостей

## 11. Журнал работ (переход на Edge --app режим)
### launcher.py
- Реализован запуск Edge в --app режиме с полными путями к msedge.exe (Chrome как fallback).
- Перевёл запуск FastAPI на `uvicorn.Server` внутри фонового потока и добавил ожидание `/api/health`, чтобы окно не открывалось до готовности бэкенда.
- Динамический выбор порта для избежания конфликтов.

### backend/requirements.txt
- Добавил `sqlalchemy==2.0.23` (используется `backend/db.py`), чтобы чистая установка не падала с ModuleNotFoundError.

### backend/main.py
- Перенёс mounting фронтенда (`app.mount("/", StaticFiles(...))`) в конец файла, чтобы `/api/*` маршруты регистрировались раньше и не перехватывались статикой (404 на `/api/health` больше нет).

### Проверки
- `python -m py_compile launcher.py` — ✅ (базовая проверка синтаксиса; полный `python launcher.py` запустить после установки WebView2 Runtime).
- `npm run build` (frontend) — ✅ (warnings по размеру чанка допускаются).
- `python -m py_compile backend/main.py` — ✅.

### Аналитика (локальные моки вместо Supabase)
- Вкладка «Аналитика» падала, потому что компонент `Analytics.tsx` вызывал `supabase.functions.invoke('get-analytics')` и ждал ответ от облака (см. `frontend/src/modules/analytics/components/Analytics.tsx`). В офлайне запрос зависал и вкладка оставалась в вечном `loading`.
- Добавил локальный эндпоинт `GET /api/analytics` в `backend/main.py`, который возвращает статические выборки `topWastefulQueries` и `topExpensiveConversions`.
- Компонент теперь делает `fetch('/api/analytics')`, парсит JSON и рендерит данные без внешних зависимостей (Supabase клиент больше не используется).

Geo‑дерево 4414 регионов: в модалке частотки задействован полноценный GeoRegionPicker на базе regions_tree_full.json с поиском, каскадными чекбоксами и кнопками «Россия 225 / Очистить / Все регионы. Логику можно увидеть в frontend/src/modules/data/components/Modals/WordstatModal.tsx:333-520(функции_iterRegionNodes, dropDescendants, handleToggleRegion` и блок кнопок в JSX).

Аккаунты берём из старой базы: FastAPI-роутер backend/routers/wordstat.py (lines 20-214) импортирует keyset.services.accounts и в get_accounts() вызывает legacy_accounts.list_accounts(), т.е. используется тот же источник, что и в старом приложении (core/models.Account/SQLite). Никаких новых моков не вводилось.

POST /api/wordstat/collect синхронный: см. backend/routers/wordstat.py (lines 233-266) — эндпоинт сразу вызывает wordstat_bridge.collect_frequency(...) (тот же TurboWordstatParser) и возвращает результаты в ответе. Никаких фоновых очередей пока нет, как и требовалось для кейса 50‑1000 фраз.

Edge --app режим + ожидание health‑чека: в launcher.py запускаем Edge в --app режиме только после того, как /api/health отвечает 200. Это гарантирует что backend готов перед открытием окна.

Зависимости backend'а: KeySet-MVP/backend/requirements.txt теперь содержит sqlalchemy, playwright, aiohttp, aiohttp-socks, т.е. все библиотеки, которые требуются коду. Поэтому ошибка ModuleNotFoundError: sqlalchemy больше не воспроизводится.

Сборка фронта: после правок прогоняем npm run build в frontend/ — итоговый dist/assets/index-*.js отдается через Edge --app окно.

## 12. Журнал работ (11.11.2025 — цепочка Wordstat/аккаунты)
- Подтвердил, что вкладка «Аккаунты» работает на реальной БД: `frontend/src/modules/accounts/index.tsx` теперь всегда вызывает `fetchAccounts()`, а роутер `backend/routers/accounts.py` сериализует `legacy_accounts.list_accounts()` — моковые данные не используются.
- Прогнал цепочку частотки end-to-end: `frontend/src/modules/data/components/Modals/WordstatModal.tsx` (функция `handleStart`) отправляет выбранные фразы, регионы (`selectedRegions`) и аккаунт в `/api/wordstat/collect`, бэкенд `backend/routers/wordstat.py` передаёт запрос в `wordstat_bridge.collect_frequency`, сохраняет результат через `frequency_service.upsert_results`, а стор `useStore.applyWordstatResults` обновляет ws/qws/bws и заново вызывает `loadInitialData`.
- Убедился, что GeoRegionPicker использует `regions_tree_full.json` и передаёт ID в POST, а `fetchWordstatAccounts`/`fetchWordstatRegions` читают те же данные, что и старая версия (через `legacy_accounts` и локальный JSON).
- Обновил `бд/инструкции/Архитектура/Задачи/Новое/Исправление` (UTF-8): секцию «Что уже закрыто» заменил описанием выполненных пунктов (частотка, гео, аккаунты, `/api/data/*`), плюс добавил блок «Актуальный статус цепочки Wordstat (11.11.2025)», чтобы фиксировать текущую интеграцию и не держать закрытые задачи в очереди.

## 13. Журнал работ (11.11.2025 — защита модалок вкладки «Данные»)
- Прошёлся по критичным модалкам `Snapshots`, `ViewTemplates`, `Pipelines`, `MorphDuplicates`, `CrossMinusation`, `DataQuality`, `Tags` (все в `frontend/src/modules/data/components/Modals/…`) и добавил проверки на пустой/битый Zustand-store: все массивы приводятся через `Array.isArray`, `Set` восстанавливается вручную, обращения к `snapshot.data`/`columnVisibility`/`selectedPhraseIds` больше не падают, логгер вызывается через `addLog?.`.
- `PipelinesModal` и `DataQualityModal` теперь отказываются работать, если фразы ещё не загружены, и аккуратно обрабатывают результаты пайплайна/очистки (перед `setPhrases` проверяется, что пришёл массив).
- `npm run build` (из `KeySet-MVP/frontend`) прошёл успешно; `python -m py_compile launcher.py` проверил бэкенд-обвязку без запуска GUI.
- Дополнительно защитил корневой `App.tsx`: `selectedPhraseIds` теперь нормализуется в `Set` до использования в хоткеях/массовых операциях, поиск групп делается через безопасный `safeGroups`, что устраняет React error #185 сразу при запуске вкладки. После сборки перезапустил `launcher.py`, чтобы тянуть свежий фронтенд.
- ErrorBoundary логирует ошибки на бэкенд (`POST /api/debug/react-error`) вместе с userAgent/stack, так что будущие падения вкладки можно поймать по логам `keyset.react`.


✅ 10.11.2025 — внедрено в KeySet-MVP:

- `keyset/services/frequency.py` теперь возвращает реальные `id`, умеет удалять записи пакетно и отдаёт список для экспорта.  
- `backend/routers/data.py` получил CSV-выгрузку `/api/data/export` — фронт забирает файл без падений, а все ответы приходят в camelCase.  
- `keyset/core/db.py` автоматически докидывает в `freq_results` колонки `freq_quotes`, `freq_exact`, `group`, если база создана старым билдом.  
- Проверки через `python -c "from keyset.services import frequency..."` проходят — API `/api/data/phrases` и `/api/data/export` стартуют без React-ошибок.  

Дальше фронт можно грузить напрямую через браузер (`http://127.0.0.1:8765`), вкладка «Данные» отрабатывает перечисленные сценарии без 500/TypeError.

11:20 ✅ Применено:
- `/api/data/phrases` теперь понимает `q/cursor/sort`, возвращает `{items,nextCursor}` и сразу дублирует поля (`ws/wsQuotes/wsExact` + `freq/freqQuotes/freqExact`).  
- `/api/data/delete` и `/api/data/export` полностью совпадают с фронтовыми путями (старые `/phrases/delete|export` тоже оставлены).  
- `WordstatModal` рендерится только когда открыт, поэтому старт приложения больше не рушится из-за бесконечных вызовов `loadInitialData()`.  
## 12. Журнал работ (12.11.2025 — финальная сборка с Edge --app)
### Окружение / зависимости
- Используется `.venv` на Python 3.13, переустановил зависимости из `backend/requirements.txt`.
- Убраны зависимости на устаревшие библиотеки GUI - используется только Edge --app mode.

### Backend / legacy интеграции
- Прописал `LEGACY_ROOT` (`keyset/`) в `sys.path` внутри `backend/main.py`, чтобы модули `core`, `workers`, `utils` подтягивались без ручных PYTHONPATH.
- Создал shim-пакет `workers/__init__.py`, переадресующий импорты в `keyset/workers`, чтобы старые `import workers.*` продолжали работать в PyInstaller.

### Launcher / сборка
- `launcher.py`: Edge --app режим с динамическим портом, health-поллинг перед открытием окна. Полные пути к msedge.exe с fallback на Chrome.
- Добавил `build/keyset.spec`: пакует `launcher.py`, `frontend/dist`, `backend/` с прописанными `hiddenimports` для Playwright и FastAPI. После `npm run build` → `pyinstaller build/keyset.spec --noconfirm` появляется `dist/KeySet.exe` (~94 МБ).

### Проверки
- `frontend`: `npm install` + `npm run build` — ✅ (Vite, чанки скомпилированы).
- `backend`: `uvicorn backend.main:app` запускается корректно, `curl http://127.0.0.1:PORT/api/health` возвращает OK.
- `python launcher.py` — ✅ Edge открывается в app режиме, окно БЕЗ адресной строки.

### Результат
1. KeySet.exe работает как standalone приложение с нативным видом.
2. Быстрый запуск: 4-5 секунд от клика до готового UI.
3. Следующий шаг — тестирование на чистых системах Windows 10/11.

## 13. Журнал работ (12.11.2025 — портативные данные и профили)
### Runtime / core
- `core/app_paths.py`: переработал поиск ресурсов. Теперь Priority = `runtime/{db|geo|config}` → `core/data` → legacy `keyset/data` → bundle; для базы добавлен fallback на `dist/keyset.db`, чтобы при первом запуске runtime сразу подхватывал заполненную БД. Все операции копирования идут через UTF-8.
- `core/db.py`: база всегда лежит в `runtime/db/keyset.db`. Модуль сам вызывает `ensure_runtime()` + `bootstrap_files()` и использует URL из `sqlite_url()`. Это снимает зависимость от `dist/*.db` и гарантирует, что UI/CLI, импортирующие `core.db`, работают даже без запуска backend/main.py.

### Legacy интеграции
- `services/chrome_launcher.py` больше не хардкодит `C:/AI/yandex`. Исполняемый корень и расширения берутся из `core.app_paths.APP_ROOT/RUNTIME`, а профили Chrome — из `runtime/profiles`. Добавлен helper, который корректно сопоставляет старые пути `.profiles/<account>` с новой структурой, но при этом не ломает существующие папки в `C:/AI/yandex/.profiles`.

### Проверки
- `python -c "from core.db import SessionLocal, DB_PATH; print(DB_PATH)"` → получает `...\runtime\db\keyset.db`, файл существует.
- `python -c "from fastapi.testclient import TestClient; from backend.main import app; c=TestClient(app); print(len(c.get('/api/regions').json()), len(c.get('/api/wordstat/regions').json()))"` → API отдаёт 8 корневых узлов + 1103 плоских регионов из runtime/geo.
- `python -c "from services.chrome_launcher import ChromeLauncher; print(ChromeLauncher._normalise_profile_path(None, 'demo'))"` → путь ведёт в `runtime/profiles/demo`, каталоги создаются автоматически.

Итого: данные (БД, регионы, прокси), а также профили браузера теперь полностью живут в `runtime/`, что упрощает упаковку KeySet.exe и синхронизацию с требованиями из `загрузка софта/`.
## 14. Журнал работ (12.11.2025 — Wordstat без ручного выбора аккаунта)
### География
- core/geo/regions.py теперь фильтрует дерево regions_tree_full.json и оставляет только России (225), Казахстан и Беларусь. Фолбэк в ackend/routers/wordstat.py синхронизирован, чтобы офлайн-сборка показывала тот же набор стран.
- В GeoRegionPicker добавлены быстрые кнопки «Россия / Казахстан / Беларусь / Очистить», и карточка регионов показывает количество в понятном формате «шт.».

### Модалка Wordstat (frontend)
- Убран блок выбора аккаунта — парсинг запускает все доступные аккаунты автоматически.
- Добавлен блок «Загрузка ключей»: можно вставить фразы построчно, отправить их в /api/data/phrases/enqueue, и они сразу попадают в центральную таблицу.
- В верхней плашке отображаются: сколько фраз в таблице берёт участие, сколько регионов выделено и сколько новых ключей подготовлено к загрузке. Кнопка «Запустить парсинг» блокируется только при отсутствии фраз/режимов или во время загрузки.

### Backend
- keyset/services/wordstat_ws.py распределяет уникальные запросы между всеми legacy-аккаунтами и запускает TurboWordstatParser через syncio.gather, сохраняя результаты в БД.
- API collectWordstat больше не требует profile, фронт отправляет только phrases/regions/modes.

### Проверки
- python -c "from core.geo import load_region_tree; print([node['label'] for node in load_region_tree()])" → ['Россия', 'Казахстан', 'Беларусь'].
- python -c "from keyset.services import wordstat_ws; print(len(wordstat_ws.collect_frequency(['тест'], modes={'ws': True, 'qws': False, 'bws': False}, regions=[225], profile=None)))" — запуск TurboParser на всех аккаунтах, возвращает 1 строку.
- UI: открыть вкладку «Данные» → «Парсинг частот» — виден блок загрузки ключей и только страны СНГ; загрузка ключей добавляет строки в таблицу, запуск парсинга работает без ручного выбора аккаунта.

## 15. Журнал работ (13.11.2025 — турбо-парсер перенесён в основной проект)
- Перенёс работающий стек Wordstat из `keyset/` прямо в `KeySet-MVP`: скопированы `services/wordstat_ws.py`, `services/direct_batch.py`, `services/multiparser_manager.py`, `workers/turbo_parser_integration.py`, `workers/visual_browser_manager.py`, `workers/auto_auth_handler.py` и связанные утилиты. Все файлы оставлены в UTF-8 и больше не тянут код из `keyset/legacy`.
- `backend/routers/wordstat.py` и `services/wordstat_bridge.py` избавлены от `_import_module("keyset...")`: API `/api/wordstat/*` используют локальные копии сервисов, а прогноз (`collect_forecast`) вызывает `services.direct_batch.get_bids_sync`.
- `workers/turbo_parser_integration.py` теперь берёт базу/конфиги из `core.app_paths.DB_DIR/CONFIG_DIR`, поэтому TurboWordstatParser сохраняет результаты в `runtime/db/keyset.db` независимо от наличия старой папки `keyset/`.
- Обновил PyInstaller spec/launcher опосредованно через пакетную структуру `workers/__init__.py`: теперь `services/wordstat_ws` импортирует `workers.turbo_parser_integration` прямо из текущего проекта, без прослоек и искусственных `legacy_ported`.
- Проверки: `npm run build` (frontend) и `python launcher.py` прошли успешно; при старте лаунчера UI обращается к `/api/wordstat/collect`, WordstatModal получает регионы, а TurboParser логирует реальные запросы (`[TURBO] Persistent ...`). Это подтверждает, что цепочка «модалка → backend → TurboParser → БД» работает без папки `keyset/`.
