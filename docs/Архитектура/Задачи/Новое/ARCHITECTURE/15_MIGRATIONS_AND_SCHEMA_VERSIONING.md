# 15. Migrations & Schema Versioning KeySet-MVP

> **Р”РѕРєСѓРјРµРЅС‚Р°С†РёСЏ РјРёРіСЂР°С†РёР№ Р±Р°Р·С‹ РґР°РЅРЅС‹С…: SQLite schema changes, Alembic, РІРµСЂСЃРёРѕРЅРёСЂРѕРІР°РЅРёРµ**

## рџ“‹ РЎРѕРґРµСЂР¶Р°РЅРёРµ

- [Р¦РµР»СЊ](#С†РµР»СЊ)
- [Р”Р»СЏ РєРѕРіРѕ](#РґР»СЏ-РєРѕРіРѕ)
- [РЎРІСЏР·Р°РЅРЅС‹Рµ РґРѕРєСѓРјРµРЅС‚С‹](#СЃРІСЏР·Р°РЅРЅС‹Рµ-РґРѕРєСѓРјРµРЅС‚С‹)
- [РђСЂС…РёС‚РµРєС‚СѓСЂР° РјРёРіСЂР°С†РёР№](#Р°СЂС…РёС‚РµРєС‚СѓСЂР°-РјРёРіСЂР°С†РёР№)
- [Р”РёР°РіСЂР°РјРјР° РІРµСЂСЃРёРѕРЅРёСЂРѕРІР°РЅРёСЏ](#РґРёР°РіСЂР°РјРјР°-РІРµСЂСЃРёРѕРЅРёСЂРѕРІР°РЅРёСЏ)
- [РЎС‚СЂР°С‚РµРіРёСЏ РјРёРіСЂР°С†РёР№](#СЃС‚СЂР°С‚РµРіРёСЏ-РјРёРіСЂР°С†РёР№)
- [РЎРЅРёРїРїРµС‚С‹](#СЃРЅРёРїРїРµС‚С‹)
- [РўРёРїРѕРІС‹Рµ РѕС€РёР±РєРё](#С‚РёРїРѕРІС‹Рµ-РѕС€РёР±РєРё)
- [Р‘С‹СЃС‚СЂС‹Р№ СЃС‚Р°СЂС‚](#Р±С‹СЃС‚СЂС‹Р№-СЃС‚Р°СЂС‚)
- [TL;DR](#tldr)
- [Р§РµРє-Р»РёСЃС‚ РїСЂРёРјРµРЅРµРЅРёСЏ](#С‡РµРє-Р»РёСЃС‚-РїСЂРёРјРµРЅРµРЅРёСЏ)

---

## Р¦РµР»СЊ

Р”РѕРєСѓРјРµРЅС‚Р°С†РёСЏ СЃРёСЃС‚РµРјС‹ РјРёРіСЂР°С†РёР№ KeySet-MVP: РёР·РјРµРЅРµРЅРёСЏ СЃС…РµРјС‹ Р‘Р”, РІРµСЂСЃРёРѕРЅРёСЂРѕРІР°РЅРёРµ, РѕС‚РєР°С‚ РёР·РјРµРЅРµРЅРёР№, СЃРѕРІРјРµСЃС‚РёРјРѕСЃС‚СЊ СЃС‚Р°СЂС‹С… РґР°РЅРЅС‹С….

## Р”Р»СЏ РєРѕРіРѕ

- Backend СЂР°Р·СЂР°Р±РѕС‚С‡РёРєРё РґР»СЏ РёР·РјРµРЅРµРЅРёСЏ СЃС…РµРјС‹
- DevOps РґР»СЏ deployment РјРёРіСЂР°С†РёР№
- Database Р°РґРјРёРЅРёСЃС‚СЂР°С‚РѕСЂС‹
- QA РґР»СЏ С‚РµСЃС‚РёСЂРѕРІР°РЅРёСЏ РјРёРіСЂР°С†РёР№

## РЎРІСЏР·Р°РЅРЅС‹Рµ РґРѕРєСѓРјРµРЅС‚С‹

- [01_DATABASE.md](./01_DATABASE.md) вЂ” СЃС‚СЂСѓРєС‚СѓСЂР° Р‘Р”
- [12_PRODUCTION_WINDOWS_BUILD.md](./12_PRODUCTION_WINDOWS_BUILD.md) вЂ” РјРёРіСЂР°С†РёРё РІ production
- [13_SECURITY_NOTES.md](./13_SECURITY_NOTES.md) вЂ” Р±РµР·РѕРїР°СЃРЅРѕСЃС‚СЊ РґР°РЅРЅС‹С…

---

## РђСЂС…РёС‚РµРєС‚СѓСЂР° РјРёРіСЂР°С†РёР№

```mermaid
graph TD
    A[Schema V1] -->|migration_001| B[Schema V2]
    B -->|migration_002| C[Schema V3]
    C -->|migration_003| D[Schema V4]
    
    E[Alembic] --> F[Version Table]
    F --> G[Current Version]
    
    G -->|upgrade| D
    G -->|downgrade| C
    
    D --> H[Backup Before Migrate]
    H --> I[Apply Migration]
    I --> J[Verify Schema]
```

---

## Р”РёР°РіСЂР°РјРјР° РІРµСЂСЃРёРѕРЅРёСЂРѕРІР°РЅРёСЏ

```mermaid
sequenceDiagram
    participant Dev as Developer
    participant Alembic as Alembic Tool
    participant DB as SQLite DB
    participant App as Application
    
    Dev->>Alembic: alembic revision -m "add column"
    Alembic->>Alembic: create migration file
    Dev->>Dev: edit migration file
    Dev->>Alembic: alembic upgrade head
    Alembic->>DB: ALTER TABLE ...
    DB-->>Alembic: success
    Alembic->>DB: UPDATE alembic_version
    App->>DB: use new schema
```

---

## РЎС‚СЂР°С‚РµРіРёСЏ РјРёРіСЂР°С†РёР№

### 1. РР·РјРµРЅРµРЅРёСЏ СЃС…РµРјС‹
- РСЃРїРѕР»СЊР·СѓРµРј Alembic РґР»СЏ РјРёРіСЂР°С†РёР№
- РљР°Р¶РґРѕРµ РёР·РјРµРЅРµРЅРёРµ вЂ” РѕС‚РґРµР»СЊРЅР°СЏ РјРёРіСЂР°С†РёСЏ
- Р’РµСЂСЃРёРѕРЅРёСЂРѕРІР°РЅРёРµ С‡РµСЂРµР· git

### 2. РЎРѕРІРјРµСЃС‚РёРјРѕСЃС‚СЊ
- Backward compatibility РґР»СЏ 1 РІРµСЂСЃРёРё РЅР°Р·Р°Рґ
- Deprecated РїРѕР»СЏ РїРѕРјРµС‡Р°РµРј РєРѕРјРјРµРЅС‚Р°СЂРёСЏРјРё
- Data migration РѕС‚РґРµР»СЊРЅРѕ РѕС‚ schema migration

### 3. РўРµСЃС‚РёСЂРѕРІР°РЅРёРµ
- РўРµСЃС‚РёСЂСѓРµРј upgrade Рё downgrade
- РџСЂРѕРІРµСЂСЏРµРј РЅР° С‚РµСЃС‚РѕРІРѕР№ РєРѕРїРёРё Р‘Р”
- Rollback РїР»Р°РЅ РґР»СЏ РєСЂРёС‚РёС‡РµСЃРєРёС… РёР·РјРµРЅРµРЅРёР№

### 4. Production deployment
- Backup Р‘Р” РїРµСЂРµРґ РјРёРіСЂР°С†РёРµР№
- РњРёРіСЂР°С†РёРё РІ maintenance window
- РњРѕРЅРёС‚РѕСЂРёРЅРі РїРѕСЃР»Рµ РїСЂРёРјРµРЅРµРЅРёСЏ

---

## РЎРЅРёРїРїРµС‚С‹

### РРЅРёС†РёР°Р»РёР·Р°С†РёСЏ Alembic

```bash
# С„Р°Р№Р»: TBD:TBD-TBD
```

### РЎРѕР·РґР°РЅРёРµ РјРёРіСЂР°С†РёРё

```python
# С„Р°Р№Р»: TBD:TBD-TBD
```

### РџСЂРёРјРµРЅРµРЅРёРµ РјРёРіСЂР°С†РёРё

```python
# С„Р°Р№Р»: backend/db.py:TBD-TBD
```

### Rollback РјРёРіСЂР°С†РёРё

```python
# С„Р°Р№Р»: TBD:TBD-TBD
```

### Data migration РїСЂРёРјРµСЂ

```python
# С„Р°Р№Р»: TBD:TBD-TBD
```

---

## РўРёРїРѕРІС‹Рµ РѕС€РёР±РєРё

### вќЊ РћС€РёР±РєР°: "Alembic version mismatch"

**РџСЂРёС‡РёРЅР°:** Р‘Р” РЅР° СЃС‚Р°СЂРѕР№ РІРµСЂСЃРёРё, РєРѕРґ С‚СЂРµР±СѓРµС‚ РЅРѕРІСѓСЋ.

**Р РµС€РµРЅРёРµ:**
```bash
alembic upgrade head
```

### вќЊ РћС€РёР±РєР°: "Migration failed halfway"

**РџСЂРёС‡РёРЅР°:** РћС€РёР±РєР° РІ migration СЃРєСЂРёРїС‚Рµ.

**Р РµС€РµРЅРёРµ:**
- РћС‚РєР°С‚РёС‚СЊ РЅР° backup
- РСЃРїСЂР°РІРёС‚СЊ migration С„Р°Р№Р»
- РџСЂРёРјРµРЅРёС‚СЊ СЃРЅРѕРІР° СЃ С‚РµСЃС‚Р°РјРё

### вќЊ РћС€РёР±РєР°: "SQLite locked during migration"

**РџСЂРёС‡РёРЅР°:** Р”СЂСѓРіРѕР№ РїСЂРѕС†РµСЃСЃ РґРµСЂР¶РёС‚ lock РЅР° Р‘Р”.

**Р РµС€РµРЅРёРµ:**
- РћСЃС‚Р°РЅРѕРІРёС‚СЊ РїСЂРёР»РѕР¶РµРЅРёРµ
- РЈР±РµРґРёС‚СЊСЃСЏ С‡С‚Рѕ connections Р·Р°РєСЂС‹С‚С‹
- Р’РєР»СЋС‡РёС‚СЊ WAL mode

---

## Р‘С‹СЃС‚СЂС‹Р№ СЃС‚Р°СЂС‚

### 1. РРЅРёС†РёР°Р»РёР·Р°С†РёСЏ Alembic

```bash
cd backend
alembic init alembic
```

### 2. РќР°СЃС‚СЂРѕР№РєР° alembic.ini

```ini
sqlalchemy.url = sqlite:///keyset.db
```

### 3. РЎРѕР·РґР°РЅРёРµ РїРµСЂРІРѕР№ РјРёРіСЂР°С†РёРё

```bash
alembic revision -m "initial schema"
```

### 4. Р РµРґР°РєС‚РёСЂРѕРІР°РЅРёРµ РјРёРіСЂР°С†РёРё

```python
def upgrade():
    op.create_table(
        'accounts',
        sa.Column('id', sa.Integer, primary_key=True),
        sa.Column('name', sa.String(255)),
    )

def downgrade():
    op.drop_table('accounts')
```

### 5. РџСЂРёРјРµРЅРµРЅРёРµ РјРёРіСЂР°С†РёРё

```bash
alembic upgrade head
```

### 6. РћС‚РєР°С‚ РјРёРіСЂР°С†РёРё

```bash
alembic downgrade -1
```

---

## TL;DR

- **Alembic** вЂ” РёРЅСЃС‚СЂСѓРјРµРЅС‚ РґР»СЏ РјРёРіСЂР°С†РёР№
- **Р’РµСЂСЃРёРѕРЅРёСЂРѕРІР°РЅРёРµ** вЂ” РєР°Р¶РґРѕРµ РёР·РјРµРЅРµРЅРёРµ СЃС…РµРјС‹
- **Backward compatibility** вЂ” 1 РІРµСЂСЃРёСЏ РЅР°Р·Р°Рґ
- **Backup** вЂ” РїРµСЂРµРґ РєР°Р¶РґРѕР№ РјРёРіСЂР°С†РёРµР№
- **РўРµСЃС‚РёСЂРѕРІР°РЅРёРµ** вЂ” upgrade Рё downgrade

---

## Р§РµРє-Р»РёСЃС‚ РїСЂРёРјРµРЅРµРЅРёСЏ

- [ ] Alembic РёРЅРёС†РёР°Р»РёР·РёСЂРѕРІР°РЅ РІ РїСЂРѕРµРєС‚Рµ
- [ ] alembic.ini РЅР°СЃС‚СЂРѕРµРЅ РєРѕСЂСЂРµРєС‚РЅРѕ
- [ ] Р’СЃРµ РёР·РјРµРЅРµРЅРёСЏ СЃС…РµРјС‹ С‡РµСЂРµР· РјРёРіСЂР°С†РёРё
- [ ] РњРёРіСЂР°С†РёРё РІРµСЂСЃРёРѕРЅРёСЂРѕРІР°РЅС‹ РІ git
- [ ] РўРµСЃС‚С‹ РґР»СЏ upgrade Рё downgrade
- [ ] Backup Р‘Р” РїРµСЂРµРґ РјРёРіСЂР°С†РёРµР№
- [ ] Rollback РїР»Р°РЅ Р·Р°РґРѕРєСѓРјРµРЅС‚РёСЂРѕРІР°РЅ
- [ ] Data migrations РѕС‚РґРµР»СЊРЅРѕ РѕС‚ schema
- [ ] Production РјРёРіСЂР°С†РёРё РІ maintenance window
- [ ] РњРѕРЅРёС‚РѕСЂРёРЅРі РїРѕСЃР»Рµ РјРёРіСЂР°С†РёРё РЅР°СЃС‚СЂРѕРµРЅ

---

**РџРѕСЃР»РµРґРЅРµРµ РѕР±РЅРѕРІР»РµРЅРёРµ:** 2024-11-10

**РЎР»РµРґСѓСЋС‰РёР№ С€Р°Рі:** Р’РµСЂРЅСѓС‚СЊСЃСЏ Рє [ARCHITECTURE_INDEX.md](./ARCHITECTURE_INDEX.md)
