РЈРїР°РєРѕРІРєР° React-РїСЂРёР»РѕР¶РµРЅРёСЏ РІ FastAPI РєР°Рє SPA

РџРµСЂРІС‹Рј С€Р°РіРѕРј Р±СѓРґРµС‚ РІСЃС‚СЂРѕРёС‚СЊ СЃРєРѕРјРїРёР»РёСЂРѕРІР°РЅРЅС‹Р№ С„СЂРѕРЅС‚РµРЅРґ (React/Vite) РІ Р±СЌРєРµРЅРґ FastAPI, С‡С‚РѕР±С‹ РѕРЅ СЂР°Р·РґР°РІР°Р»СЃСЏ РєР°Рє РµРґРёРЅР°СЏ SPA. Р’ РїСЂРѕРµРєС‚Рµ KeySet-MVP СЌС‚Рѕ СѓР¶Рµ С‡Р°СЃС‚РёС‡РЅРѕ РїСЂРµРґСѓСЃРјРѕС‚СЂРµРЅРѕ: РІ backend/main.py РµСЃС‚СЊ СѓСЃР»РѕРІРЅС‹Р№ РјРѕРЅС‚РёРЅРі СЃС‚Р°С‚РёРєРё:

# backend/main.py
from fastapi.staticfiles import StaticFiles

FRONTEND_DIST = BASE_DIR.parent / "frontend" / "dist"
if FRONTEND_DIST.exists():
    app.mount("/", StaticFiles(directory=FRONTEND_DIST, html=True), name="frontend")


Р”РµР№СЃС‚РІРёСЏ:

РЎРѕР±СЂР°С‚СЊ С„СЂРѕРЅС‚РµРЅРґ: Р’С‹РїРѕР»РЅРёС‚Рµ npm run build (РёР»Рё pnpm run build) РІ РїР°РїРєРµ frontend. Р­С‚Рѕ СЃРѕР·РґР°СЃС‚ РїР°РїРєСѓ frontend/dist СЃ С„Р°Р№Р»Р°РјРё index.html Рё РїР°РїРєРѕР№ assets/. РЈР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ СЃР±РѕСЂРєР° РїСЂРѕС€Р»Р° СѓСЃРїРµС€РЅРѕ Рё СЃРѕРґРµСЂР¶РёС‚ РІСЃРµ РЅРµРѕР±С…РѕРґРёРјС‹Рµ Р±Р°РЅРґР»С‹.

РЎРєРѕРїРёСЂРѕРІР°С‚СЊ СЃР±РѕСЂРєСѓ РІ backend: РџРѕРјРµСЃС‚РёС‚Рµ СЃРѕРґРµСЂР¶РёРјРѕРµ frontend/dist РІ СЃС‚Р°С‚РёС‡РµСЃРєСѓСЋ РґРёСЂРµРєС‚РѕСЂРёСЋ Р±СЌРєРµРЅРґР°. РќР°РїСЂРёРјРµСЂ, РІС‹ РјРѕР¶РµС‚Рµ РЅР°СЃС‚СЂРѕРёС‚СЊ FastAPI РЅР° СЂР°Р·РґР°С‡Сѓ РїСЂСЏРјРѕ РёР· frontend/dist, РєР°Рє СѓРєР°Р·Р°РЅРѕ РІС‹С€Рµ. Р’ С‚РµРєСѓС‰РµР№ Р°СЂС…РёС‚РµРєС‚СѓСЂРµ РєРѕРґ СѓР¶Рµ РјРѕРЅС‚РёСЂСѓРµС‚ СЌС‚Сѓ РґРёСЂРµРєС‚РѕСЂРёСЋ РЅР° РєРѕСЂРµРЅСЊ РїСЂРёР»РѕР¶РµРЅРёСЏ ("/"), С‡С‚Рѕ РёРґРµР°Р»СЊРЅРѕ РґР»СЏ SPA. РЈР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ С„Р°Р№Р» index.html РЅР°С…РѕРґРёС‚СЃСЏ РёРјРµРЅРЅРѕ РІ СЌС‚РѕР№ РґРёСЂРµРєС‚РѕСЂРёРё Рё РґРѕСЃС‚СѓРїРµРЅ РґР»СЏ StaticFiles.

РџРѕС‡РµРјСѓ СЌС‚Рѕ РЅСѓР¶РЅРѕ: Р­С‚Рѕ РїРѕР·РІРѕР»РёС‚ РѕС‚РєСЂС‹РІР°С‚СЊ РїСЂРёР»РѕР¶РµРЅРёРµ РїРѕ URL Р±СЌРєРµРЅРґР° (РЅР°РїСЂРёРјРµСЂ, http://127.0.0.1:8765/) Рё РїРѕР»СѓС‡Р°С‚СЊ СЃСЂР°Р·Сѓ Р·Р°РіСЂСѓР¶РµРЅРЅС‹Р№ React UI. РџР°СЂР°РјРµС‚СЂ html=True РІ StaticFiles РІРєР»СЋС‡Р°РµС‚ SPA-С„РѕР»Р±РµРє: Р»СЋР±С‹Рµ РЅРµРёР·РІРµСЃС‚РЅС‹Рµ РјР°СЂС€СЂСѓС‚С‹ (РЅР°РїСЂРёРјРµСЂ, /accounts РёР»Рё /data РїСЂРё РЅР°РІРёРіР°С†РёРё РІРЅСѓС‚СЂРё React Router) Р±СѓРґСѓС‚ РѕС‚РґР°РІР°С‚СЊ index.html РІРјРµСЃС‚Рѕ 404. РўР°Рє РјС‹ РЅРµ вЂњР»РѕРјР°РµРјвЂќ РєР»РёРµРЅС‚СЃРєРёР№ СЂРѕСѓС‚РёРЅРі.

РџСЂРѕРІРµСЂРєР° РјР°СЂС€СЂСѓС‚РѕРІ: РЈР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ РІСЃРµ API-РµРЅРґРїРѕРёРЅС‚С‹ Р±СЌРєРµРЅРґР° СЃРјРѕРЅС‚РёСЂРѕРІР°РЅС‹ СЃ РїСЂРµС„РёРєСЃРѕРј (РІ РїСЂРѕРµРєС‚Рµ РёСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ РїСЂРµС„РёРєСЃ /api, РєР°Рє РІРёРґРЅРѕ РёР· РґРѕРєСѓРјРµРЅС‚Р°С†РёРё Рё РєРѕРґР° СЂРѕСѓС‚РµСЂРѕРІ). Р­С‚Рѕ РїСЂРµРґРѕС‚РІСЂР°С‚РёС‚ РєРѕРЅС„Р»РёРєС‚ РїСѓС‚РµР№: StaticFiles РѕР±СЃР»СѓР¶РёРІР°РµС‚ РєРѕСЂРЅРµРІРѕР№ РјР°СЂС€СЂСѓС‚, Р° РІСЃРµ Р·Р°РїСЂРѕСЃС‹, РЅР°С‡РёРЅР°СЋС‰РёРµСЃСЏ СЃ /api, РїСЂРѕРґРѕР»Р¶Р°С‚ РѕР±СЂР°Р±Р°С‚С‹РІР°С‚СЊСЃСЏ FastAPI. Р’ РєРѕРґРµ FastAPI СЃРЅР°С‡Р°Р»Р° РІРєР»СЋС‡Р°СЋС‚СЃСЏ СЂРѕСѓС‚РµСЂС‹, Р·Р°С‚РµРј РјРѕРЅС‚РёСЂСѓРµС‚СЃСЏ СЃС‚Р°С‚РёРєР° вЂ“ СЌС‚Рѕ РіР°СЂР°РЅС‚РёСЂСѓРµС‚, С‡С‚Рѕ Р·Р°РїСЂРѕСЃС‹ Рє /api/... РЅРµ РїРµСЂРµС…РІР°С‚С‹РІР°СЋС‚СЃСЏ StaticFiles, Р° РёРґСѓС‚ РІ СЃРѕРѕС‚РІРµС‚СЃС‚РІСѓСЋС‰РёРµ СЂРѕСѓС‚РµСЂС‹. РќР°РїСЂРёРјРµСЂ, РІС‹Р·РѕРІ GET /api/health РґРѕР»Р¶РµРЅ РїРѕ-РїСЂРµР¶РЅРµРјСѓ РёРґС‚Рё РІ СЂРѕСѓС‚ Р±СЌРєРµРЅРґР°, Р° GET /accounts вЂ“ РѕС‚РґР°РІР°С‚СЊСЃСЏ РєР°Рє РёРЅРґРµРєСЃРЅС‹Р№ HTML (SPA).

РќР°СЃС‚СЂРѕР№РєР° Vite (РµСЃР»Рё РїРѕС‚СЂРµР±СѓРµС‚СЃСЏ): РџРѕ СѓРјРѕР»С‡Р°РЅРёСЋ Vite СЃРѕР±РёСЂР°РµС‚ РїСЂРѕРµРєС‚ СЃ Р±Р°Р·РѕРІС‹Рј РїСѓС‚С‘Рј вЂњ/вЂќ. Р­С‚Рѕ РІРёРґРЅРѕ РІ index.html СЃР±РѕСЂРєРё вЂ“ СЃСЃС‹Р»РєРё РЅР° СЃРєСЂРёРїС‚С‹ Рё С„Р°РІРёРєРѕРЅ РЅР°С‡РёРЅР°СЋС‚СЃСЏ СЃ /<...>. РџРѕСЃРєРѕР»СЊРєСѓ РјС‹ СЂР°Р·РґР°С‘Рј С„СЂРѕРЅС‚РµРЅРґ СЃ РєРѕСЂРЅСЏ РґРѕРјРµРЅР°, РјРµРЅСЏС‚СЊ РЅРёС‡РµРіРѕ РЅРµ РЅСѓР¶РЅРѕ. Р’Р°Р¶РЅРѕ: РµСЃР»Рё Р±С‹ СЃС‚Р°С‚РёРєСѓ РїСЂРёС€Р»РѕСЃСЊ РјРѕРЅС‚РёСЂРѕРІР°С‚СЊ РЅРµ РЅР° РєРѕСЂРµРЅСЊ (РЅР°РїСЂРёРјРµСЂ, РЅР° /app/), С‚РѕРіРґР° РїРѕС‚СЂРµР±РѕРІР°Р»РѕСЃСЊ Р±С‹ РґРѕР±Р°РІРёС‚СЊ РІ Vite-РєРѕРЅС„РёРі РїР°СЂР°РјРµС‚СЂ base: "/app/" Рё РїРµСЂРµСЃРѕР±СЂР°С‚СЊ, С‡С‚РѕР±С‹ СЃСЃС‹Р»РєРё РІ index.html РєРѕСЂСЂРµРєС‚РЅРѕ СѓРєР°Р·С‹РІР°Р»Рё РЅР° /app/assets/.... Р’ РЅР°С€РµР№ СЃРёС‚СѓР°С†РёРё React-РїСЂРёР»РѕР¶РµРЅРёРµ Р±СѓРґРµС‚ РґРѕСЃС‚СѓРїРЅРѕ РїСЂСЏРјРѕ СЃ РєРѕСЂРЅСЏ (http://127.0.0.1/), РїРѕСЌС‚РѕРјСѓ РґРѕРїРѕР»РЅРёС‚РµР»СЊРЅР°СЏ РЅР°СЃС‚СЂРѕР№РєР° РЅРµ РЅСѓР¶РЅР°. РџСЂРѕСЃС‚Рѕ СѓР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ С„Р°Р№Р»С‹ РІСЂРѕРґРµ vite.svg Рё Р±Р°РЅРґР»С‹ РІ assets/ РґРѕСЃС‚СѓРїРЅС‹ РїРѕ СЃРІРѕРёРј РїСѓС‚СЏРј.

РР·РјРµРЅРµРЅРёСЏ РІ РјР°СЂС€СЂСѓС‚Р°С… Рё РєРѕРЅС„РёРіСѓСЂР°С†РёРё

РЎСѓС‰РµСЃС‚РІСѓСЋС‰Р°СЏ СЃС‚СЂСѓРєС‚СѓСЂР° Р±СЌРєРµРЅРґР° СѓР¶Рµ Р±Р»РёР·РєР° Рє РЅСѓР¶РЅРѕР№: РЅРµ С‚СЂРµР±СѓРµС‚СЃСЏ РїРµСЂРµРїРёСЃС‹РІР°С‚СЊ API-СЂРѕСѓС‚С‹ РёР»Рё Р»РѕРіРёРєСѓ FastAPI, РґРѕСЃС‚Р°С‚РѕС‡РЅРѕ РЅР°СЃС‚СЂРѕРёС‚СЊ СЃС‚Р°С‚РёС‡РµСЃРєСѓСЋ СЂР°Р·РґР°С‡Сѓ. РЈР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ:

РџРѕРґРєР»СЋС‡РµРЅРёРµ СЃС‚Р°С‚РёРєРё РїСЂРѕРёСЃС…РѕРґРёС‚ РїРѕСЃР»Рµ РѕР±СЉСЏРІР»РµРЅРёСЏ СЂРѕСѓС‚РµСЂРѕРІ. Р’ backend/main.py РІРєР»СЋС‡РµРЅРёРµ СЂРѕСѓС‚РµСЂРѕРІ (РЅР°РїСЂРёРјРµСЂ, app.include_router(...)) РґРѕР»Р¶РЅРѕ РІС‹Р·С‹РІР°С‚СЊСЃСЏ РґРѕ app.mount("/"). Р’ РїСЂРѕС‚РёРІРЅРѕРј СЃР»СѓС‡Р°Рµ StaticFiles РјРѕР¶РµС‚ РїРµСЂРµС…РІР°С‚РёС‚СЊ Р·Р°РїСЂРѕСЃС‹ Рє API. РџСЂРѕРІРµСЂСЊС‚Рµ РїРѕСЂСЏРґРѕРє: СЃРЅР°С‡Р°Р»Р° app = FastAPI(), Р·Р°С‚РµРј app.include_router(...) РґР»СЏ РІСЃРµС… /api РјР°СЂС€СЂСѓС‚РѕРІ, Рё С‚РѕР»СЊРєРѕ РІ РєРѕРЅС†Рµ вЂ“ РјРѕРЅС‚РёСЂРѕРІР°РЅРёРµ СЃС‚Р°С‚РёРєРё. Р­С‚Рѕ СЃРѕРѕС‚РІРµС‚СЃС‚РІСѓРµС‚ best-practice Рё СѓР¶Рµ СЂРµР°Р»РёР·РѕРІР°РЅРѕ.

Р’ РєРѕРЅС„РёРіСѓСЂР°С†РёРё FastAPI СѓРєР°Р·Р°РЅ app.mount("/", StaticFiles(..., html=True)). Р•СЃР»Рё СЌС‚РѕРіРѕ С„СЂР°РіРјРµРЅС‚Р° РЅРµ Р±С‹Р»Рѕ Р±С‹, РЅСѓР¶РЅРѕ РµРіРѕ РґРѕР±Р°РІРёС‚СЊ. РћРґРЅР°РєРѕ, СЃСѓРґСЏ РїРѕ Р·Р°РіСЂСѓР¶РµРЅРЅС‹Рј С„Р°Р№Р»Р°Рј, РѕРЅ РїСЂРёСЃСѓС‚СЃС‚РІСѓРµС‚. Р’Р°Рј СЃР»РµРґСѓРµС‚ Р»РёС€СЊ СѓР±РµРґРёС‚СЊСЃСЏ, С‡С‚Рѕ РїСѓС‚СЊ FRONTEND_DIST РїСЂР°РІРёР»СЊРЅРѕ СѓРєР°Р·С‹РІР°РµС‚ РЅР° РєРѕРЅРµС‡РЅСѓСЋ СЃР±РѕСЂРєСѓ. РќР°РїСЂРёРјРµСЂ, РµСЃР»Рё РІС‹ СЂРµС€РёС‚Рµ РєРѕРїРёСЂРѕРІР°С‚СЊ С„Р°Р№Р»С‹ РІ backend/static, С‚Рѕ РёСЃРїРѕР»СЊР·СѓР№С‚Рµ StaticFiles(directory="backend/static", html=True). Р’ РїСЂРѕРµРєС‚Рµ Р¶Рµ РёСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ РїСѓС‚СЊ Рє frontend/dist РІ РєРѕСЂРЅРµ СЂРµРїРѕР·РёС‚РѕСЂРёСЏ вЂ“ СЌС‚Рѕ С‚РѕР¶Рµ СЂР°Р±РѕС‚Р°РµС‚, С‚.Рє. РїСЂРё СЃР±РѕСЂРєРµ .exe РјС‹ РІРєР»СЋС‡РёРј СЌС‚Рё С„Р°Р№Р»С‹.

РџРµСЂРµРјРµРЅРЅС‹Рµ РѕРєСЂСѓР¶РµРЅРёСЏ РёР»Рё СЂРµР¶РёРј СЂР°Р·СЂР°Р±РѕС‚РєРё РѕС‚РєР»СЋС‡РµРЅС‹: РЈР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ С„СЂРѕРЅС‚РµРЅРґ РѕР±СЂР°С‰Р°РµС‚СЃСЏ Рє API РїРѕ РѕС‚РЅРѕСЃРёС‚РµР»СЊРЅС‹Рј РїСѓС‚СЏРј. Р’ РєРѕРґРµ React (СЃРј. РЅР°РїСЂРёРјРµСЂ, frontend/src/modules/accounts/api.ts РёР»Рё РёРЅС‚РµРіСЂР°С†РёСЋ РІ 10_API_INTEGRATION.md) РІС‹Р·РѕРІС‹ РёРґСѓС‚ РЅР° /api/..., Р±РµР· С…Р°СЂРґРєРѕРґР° С…РѕСЃС‚Р°. Р­С‚Рѕ РѕР·РЅР°С‡Р°РµС‚, С‡С‚Рѕ РІ РїСЂРѕРґР°РєС€РµРЅ-СЃР±РѕСЂРєРµ UI Р±СѓРґРµС‚ СЃС‚СѓС‡Р°С‚СЊСЃСЏ РЅР° С‚РѕС‚ Р¶Рµ С…РѕСЃС‚/РїРѕСЂС‚, РѕС‚РєСѓРґР° Р·Р°РіСЂСѓР¶РµРЅР° СЃС‚СЂР°РЅРёС†Р° вЂ“ С‚Рѕ РµСЃС‚СЊ РЅР°С€ FastAPI. Р­С‚Рѕ РїСЂР°РІРёР»СЊРЅРѕ. РќРµС‚ РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё РїСЂРѕРїРёСЃС‹РІР°С‚СЊ РІ React РєРѕРЅРєСЂРµС‚РЅС‹Р№ РїРѕСЂС‚ РёР»Рё РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ РїСЂРѕРєСЃРё вЂ“ РїСЂРё РІСЃС‚СЂРѕРµРЅРЅРѕР№ СЂР°Р·РґР°С‡Рµ С„СЂРѕРЅС‚РµРЅРґР° РІСЃС‘ РїСЂРѕРёСЃС…РѕРґРёС‚ СЃ РѕРґРЅРѕРіРѕ РёСЃС‚РѕС‡РЅРёРєР° (origin), Рё РїСЂРѕР±Р»РµРјС‹ СЃ CORS РёР»Рё Р°РІС‚РѕСЂРёР·Р°С†РёРµР№ РїРѕ РєСѓРєР°Рј РѕС‚СЃСѓС‚СЃС‚РІСѓСЋС‚.

Р¤Р°Р№Р»С‹ РєРѕРЅС„РёРіСѓСЂР°С†РёР№ Рё РґР°РЅРЅС‹Рµ: РЈР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ РїСЂРё СЃР±РѕСЂРєРµ РІСЃРµ РЅРµРѕР±С…РѕРґРёРјС‹Рµ СЃС‚Р°С‚РёС‡РµСЃРєРёРµ С„Р°Р№Р»С‹ Р±СЌРєРµРЅРґР° С‚РѕР¶Рµ Р±СѓРґСѓС‚ РґРѕСЃС‚СѓРїРЅС‹. РќР°РїСЂРёРјРµСЂ, СѓРїРѕРјРёРЅР°Р»СЃСЏ С„Р°Р№Р» regions.json (РґРµСЂРµРІРѕ СЂРµРіРёРѕРЅРѕРІ РґР»СЏ GeoSelector). Р‘СЌРєРµРЅРґ Р·Р°РіСЂСѓР¶Р°РµС‚ РµРіРѕ РїСЂРё СЃС‚Р°СЂС‚Рµ (РІ keyset/data/regions_tree_full.json), Рё РѕРЅ СѓР¶Рµ РґРѕР±Р°РІР»РµРЅ РІ datas PyInstaller-СЃРїРµРєР°. Р’ SPA-СЂРµР¶РёРјРµ РЅРёС‡РµРіРѕ РјРµРЅСЏС‚СЊ РЅРµ РЅСѓР¶РЅРѕ вЂ“ API /api/regions РїСЂРѕРґРѕР»Р¶РёС‚ С‡РёС‚Р°С‚СЊ СЃРІРѕР№ JSON, Р° С„СЂРѕРЅС‚РµРЅРґ РїРѕ-РїСЂРµР¶РЅРµРјСѓ РїРѕР»СѓС‡РёС‚ РґР°РЅРЅС‹Рµ С‡РµСЂРµР· СЌС‚РѕС‚ СЌРЅРґРїРѕРёРЅС‚. РќРµ СѓРґР°Р»СЏР№С‚Рµ Рё РЅРµ РїРµСЂРµРјРµС‰Р°Р№С‚Рµ С„Р°Р№Р»С‹ СЃ РґР°РЅРЅС‹РјРё вЂ“ СЃРѕС…СЂР°РЅРёС‚Рµ РёС… СЃС‚СЂСѓРєС‚СѓСЂСѓ (keyset/data/..., backend/keyset.db, backend/config/...) РїСЂРё СѓРїР°РєРѕРІРєРµ. Р­С‚Рѕ РіР°СЂР°РЅС‚РёСЂСѓРµС‚, С‡С‚Рѕ РіРµРѕ-РґРµСЂРµРІРѕ, cookie Рё РґСЂСѓРіРёРµ С‡Р°СЃС‚Рё (CDP-РїР°С‚С‡РёРЅРі СЂРµРіРёРѕРЅРѕРІ) Р±СѓРґСѓС‚ СЂР°Р±РѕС‚Р°С‚СЊ, РєР°Рє Рё СЂР°РЅСЊС€Рµ.

Launcher СЃ Edge --app СЂРµР¶РёРјРѕРј

Р“Р»Р°РІРЅРѕРµ РёР·РјРµРЅРµРЅРёРµ РЅСѓР¶РЅРѕ РІРЅРµСЃС‚Рё РІ Р·Р°РїСѓСЃРєР°СЋС‰РёР№ СЃРєСЂРёРїС‚ (launcher.py). РќР°Рј РЅСѓР¶РЅРѕ СЃРґРµР»Р°С‚СЊ С‚Р°Рє, С‡С‚РѕР±С‹:

РћРєРЅРѕ UI РѕС‚РєСЂС‹РІР°Р»РѕСЃСЊ РјРіРЅРѕРІРµРЅРЅРѕ С‡РµСЂРµР· Edge РІ СЂРµР¶РёРјРµ РїСЂРёР»РѕР¶РµРЅРёСЏ (Р±РµР· Р°РґСЂРµСЃРЅРѕР№ СЃС‚СЂРѕРєРё Рё РІРєР»Р°РґРѕРє).

РР·Р±РµР¶Р°С‚СЊ С„РёРєСЃРёСЂРѕРІР°РЅРЅС‹С… Р»РѕРєР°Р»СЊРЅС‹С… РїРѕСЂС‚РѕРІ (С‚РёРїР° 5173, 8765), С‡С‚РѕР±С‹ РїСЂРё Р·Р°РїСѓСЃРєРµ .exe РЅРµ Р±С‹Р»Рѕ РєРѕРЅС„Р»РёРєС‚Р° Рё РЅРµ РїРѕСЏРІР»СЏР»РѕСЃСЊ Р»РёС€РЅРёС… СЃР»СѓС€Р°С‚РµР»РµР№ РІ СЃРёСЃС‚РµРјРµ.

Р РµС€РµРЅРёРµ вЂ“ РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ СѓР¶Рµ СѓСЃС‚Р°РЅРѕРІР»РµРЅРЅС‹Р№ Р±СЂР°СѓР·РµСЂ (Edge РёР»Рё Chrome) РІ СЂРµР¶РёРјРµ Application (Р±РµР· Р°РґСЂРµСЃРЅРѕР№ СЃС‚СЂРѕРєРё Рё РІРєР»Р°РґРѕРє). Р­С‚Рѕ РґР°СЃС‚ РїРѕР»СЊР·РѕРІР°С‚РµР»СЋ РѕС‚РґРµР»СЊРЅРѕРµ РѕРєРЅРѕ РїСЂРёР»РѕР¶РµРЅРёСЏ, РІС‹РіР»СЏРґСЏС‰РµРµ РєР°Рє РЅР°С‚РёРІРЅРѕРµ РґРµСЃРєС‚РѕРїРЅРѕРµ РїСЂРёР»РѕР¶РµРЅРёРµ.

РЁР°Рі 2 вЂ“ Р”РёРЅР°РјРёС‡РµСЃРєРёР№ РІС‹Р±РѕСЂ РїРѕСЂС‚Р°: Р—Р°СЂР°РЅРµРµ РІС‹РґРµР»РёРј СЃРІРѕР±РѕРґРЅС‹Р№ РїРѕСЂС‚ РґР»СЏ Р±СЌРєРµРЅРґР°, С‡С‚РѕР±С‹ РЅРµ РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ Р¶РµСЃС‚РєРѕ 8765. РќР°РїСЂРёРјРµСЂ:

import socket
BACKEND_HOST = "127.0.0.1"
# РќР°Р№С‚Рё СЃРІРѕР±РѕРґРЅС‹Р№ РїРѕСЂС‚
with socket.socket() as sock:
    sock.bind((BACKEND_HOST, 0))
    BACKEND_PORT = sock.getsockname()[1]


Р­С‚Рѕ РїСЂРёРІСЏР¶РµС‚ СЃРѕРєРµС‚ Рє localhost РЅР° СЃР»СѓС‡Р°Р№РЅРѕРј СЃРІРѕР±РѕРґРЅРѕРј РїРѕСЂС‚Сѓ, РїРѕР»СѓС‡РёРІ РЅРѕРјРµСЂ С‡РµСЂРµР· sock.getsockname()[1]. Р—Р°С‚РµРј РѕСЃРІРѕР±РѕР¶РґР°РµРј СЃРѕРєРµС‚ (РѕРЅ Р·Р°РєСЂРѕРµС‚СЃСЏ РїРѕ РІС‹С…РѕРґСѓ РёР· with-Р±Р»РѕРєР°). РўР°Рє РјС‹ РіР°СЂР°РЅС‚РёСЂСѓРµРј, С‡С‚Рѕ РїРѕСЂС‚ СЃРІРѕР±РѕРґРµРЅ Рё Р·Р°СЂРµР·РµСЂРІРёСЂРѕРІР°РЅ РЅР° РјРѕРјРµРЅС‚ Р·Р°РїСѓСЃРєР° (СЂРёСЃРє РєРѕР»Р»РёР·РёРё РјРёРЅРёРјР°Р»РµРЅ). Р”Р°Р»РµРµ РёСЃРїРѕР»СЊР·СѓР№С‚Рµ СЌС‚РѕС‚ BACKEND_PORT РїСЂРё СЃС‚Р°СЂС‚Рµ Uvicorn.

РЁР°Рі 3 вЂ“ Р—Р°РїСѓСЃРє Р±СЌРєРµРЅРґР° РІ С„РѕРЅРµ: РљР°Рє Рё СЂР°РЅСЊС€Рµ, Р·Р°РїСѓСЃРєР°РµРј FastAPI-СЃРµСЂРІРµСЂ РІ РѕС‚РґРµР»СЊРЅРѕРј РїРѕС‚РѕРєРµ, РЅРѕ С‚РµРїРµСЂСЊ СЃ РІС‹Р±СЂР°РЅРЅС‹Рј РїРѕСЂС‚РѕРј Рё Р±РµР· СЂРµР¶РёРјР° reload (РІ .exe РѕРЅ РЅРµ РЅСѓР¶РµРЅ). РњРѕР¶РЅРѕ РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ Р»РёР±Рѕ uvicorn.run, Р»РёР±Рѕ РЅРёР·РєРѕСѓСЂРѕРІРЅРµРІС‹Р№ Server(Config(...)).run(). РќР°РїСЂРёРјРµСЂ:

import threading, time
from uvicorn import Config, Server

def start_backend():
    config = Config("backend.main:app", host=BACKEND_HOST, port=BACKEND_PORT, log_level="info")
    Server(config).run()

# Р—Р°РїСѓСЃС‚РёС‚СЊ Р±СЌРєРµРЅРґ-РїРѕС‚РѕРє
thread = threading.Thread(target=start_backend, daemon=True)
thread.start()
# РџРѕРґРѕР¶РґР°С‚СЊ, РїРѕРєР° СЃРµСЂРІРµСЂ РїРѕРґРЅРёРјРµС‚СЃСЏ (РЅР°РїСЂРёРјРµСЂ, 1 СЃРµРєСѓРЅРґР°)
time.sleep(1.0)


РњРѕР¶РЅРѕ СЃРЅРёР·РёС‚СЊ Р·Р°РґРµСЂР¶РєСѓ РґРѕ ~0.5-1.0СЃ РґР»СЏ СѓСЃРєРѕСЂРµРЅРёСЏ СЃС‚Р°СЂС‚Р°. Optionally, Р±РѕР»РµРµ С‚РѕС‡РЅРѕ вЂ“ СЂРµР°Р»РёР·РѕРІР°С‚СЊ РїСЂРѕРІРµСЂРєСѓ: РїС‹С‚Р°С‚СЊСЃСЏ РїРѕРґРєР»СЋС‡РёС‚СЊСЃСЏ Рє http://127.0.0.1:PORT/api/health РІ С†РёРєР»Рµ СЃ РЅРµР±РѕР»СЊС€РёРј РёРЅС‚РµСЂРІР°Р»РѕРј, С‡С‚РѕР±С‹ РЅРµ Р¶РґР°С‚СЊ РґРѕР»СЊС€Рµ РЅРµРѕР±С…РѕРґРёРјРѕРіРѕ. РќРѕ 1 СЃРµРєСѓРЅРґС‹ РѕР±С‹С‡РЅРѕ РґРѕСЃС‚Р°С‚РѕС‡РЅРѕ, С‡С‚РѕР±С‹ Uvicorn РїРѕРґРЅСЏР»СЃСЏ.

РЁР°Рі 3 вЂ“ РћС‚РєСЂС‹С‚РёРµ РѕРєРЅР° UI: Р’РѕСЃРїРѕР»СЊР·СѓРµРјСЃСЏ СѓСЃС‚Р°РЅРѕРІР»РµРЅРЅС‹Рј Р±СЂР°СѓР·РµСЂРѕРј РІ СЂРµР¶РёРјРµ РїСЂРёР»РѕР¶РµРЅРёСЏ. РќР° Windows РїРѕС‡С‚Рё РЅР°РІРµСЂРЅСЏРєР° РµСЃС‚СЊ Microsoft Edge (Chromium). РњС‹ РјРѕР¶РµРј РІС‹Р·РІР°С‚СЊ РµРіРѕ СЃ РїР°СЂР°РјРµС‚СЂРѕРј --app=:

import subprocess, sys, webbrowser

url = f"http://{BACKEND_HOST}:{BACKEND_PORT}"
try:
    subprocess.Popen(["msedge", "--app=" + url])
except FileNotFoundError:
    try:
        subprocess.Popen(["chrome", "--app=" + url])
    except FileNotFoundError:
        webbrowser.open(url)


Р­С‚РѕС‚ РєРѕРґ РїРѕРїС‹С‚Р°РµС‚СЃСЏ Р·Р°РїСѓСЃС‚РёС‚СЊ Edge РІ СЂРµР¶РёРјe РїСЂРёР»РѕР¶РµРЅРёСЏ (Р±РµР· РІРєР»Р°РґРѕРє Рё Р°РґСЂРµСЃРЅРѕР№ СЃС‚СЂРѕРєРё). Р•СЃР»Рё Edge РЅРµ РЅР°Р№РґРµРЅ (РјР°Р»РѕРІРµСЂРѕСЏС‚РЅРѕ РЅР° Win10/11, РЅРѕ РЅР° РІСЃСЏРєРёР№ СЃР»СѓС‡Р°Р№), РїСЂРѕР±СѓРµС‚ Chrome РІ С‚Р°РєРѕРј Р¶Рµ СЂРµР¶РёРјРµ. Р•СЃР»Рё Рё Chrome РЅРµ РЅР°Р№РґРµРЅ, РІ РєСЂР°Р№РЅРµРј СЃР»СѓС‡Р°Рµ РѕС‚РєСЂРѕРµС‚ URL РІ Р±СЂР°СѓР·РµСЂРµ РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ (С‡РµСЂРµР· webbrowser.open).

РЁР°Рі 4 вЂ“ Р—Р°РІРµСЂС€РµРЅРёРµ РїСЂРѕС†РµСЃСЃР° РїСЂР°РІРёР»СЊРЅРѕ: Р’ СЂРµР¶РёРјРµ --app РѕС‚РєСЂС‹РІР°РµС‚СЃСЏ РѕС‚РґРµР»СЊРЅРѕРµ РѕРєРЅРѕ/РїСЂРѕС†РµСЃСЃ Р±СЂР°СѓР·РµСЂР°. РњС‹ РјРѕР¶РµРј РґРѕР¶РґР°С‚СЊСЃСЏ РµРіРѕ Р·Р°РІРµСЂС€РµРЅРёСЏ, С‡С‚РѕР±С‹ Р·Р°С‚РµРј Р·Р°РІРµСЂС€РёС‚СЊ Рё РЅР°С€Рµ РїСЂРёР»РѕР¶РµРЅРёРµ. РќР°РїСЂРёРјРµСЂ:

proc = subprocess.Popen([...])
proc.wait()  # Р‘Р»РѕРєРёСЂСѓРµРј РѕСЃРЅРѕРІРЅРѕР№ РїРѕС‚РѕРє РґРѕ Р·Р°РєСЂС‹С‚РёСЏ Р±СЂР°СѓР·РµСЂРЅРѕРіРѕ РѕРєРЅР°


РўР°Рє, РєРѕРіРґР° РїРѕР»СЊР·РѕРІР°С‚РµР»СЊ Р·Р°РєСЂРѕРµС‚ РѕРєРЅРѕ UI, proc.wait() СЂР°Р·Р±Р»РѕРєРёСЂСѓРµС‚СЃСЏ. РџРѕСЃР»Рµ СЌС‚РѕРіРѕ РјРѕР¶РЅРѕ Р°РєРєСѓСЂР°С‚РЅРѕ Р·Р°РІРµСЂС€РёС‚СЊ Р±РµРєРµРЅРґ. РџРѕСЃРєРѕР»СЊРєСѓ Р±РµРєРµРЅРґ-РїРѕС‚РѕРє РјС‹ Р·Р°РїСѓСЃРєР°Р»Рё РєР°Рє daemon, РїСЂРё РІС‹С…РѕРґРµ РёР· РіР»Р°РІРЅРѕРіРѕ РїРѕС‚РѕРєР° РѕРЅ РїСЂРµСЂРІРµС‚СЃСЏ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё. Р§С‚РѕР±С‹ Р·Р°РІРµСЂС€РµРЅРёРµ Р±С‹Р»Рѕ С‡РёСЃС‚С‹Рј, РјРѕР¶РЅРѕ РІСЂСѓС‡РЅСѓСЋ РѕСЃС‚Р°РЅРѕРІРёС‚СЊ Uvicorn СЃРµСЂРІРµСЂ вЂ“ РЅРѕ API Сѓ uvicorn.Server РґР»СЏ СЃС‚РѕРїР° РЅРµС‚ РїСЂРѕСЃС‚РѕРіРѕ, РїРѕСЌС‚РѕРјСѓ РїСЂРёРЅРёРјР°РµРј, С‡С‚Рѕ daemon-thread РїСЂРѕСЃС‚Рѕ Р·Р°РІРµСЂС€РёС‚СЃСЏ. РџРѕСЃР»Рµ proc.wait() РјРѕР¶РЅРѕ РІС‹Р·С‹РІР°С‚СЊ sys.exit(0) РёР»Рё РїСЂРѕСЃС‚Рѕ РґР°С‚СЊ РїСЂРѕРіСЂР°РјРјРµ Р·Р°РІРµСЂС€РёС‚СЊСЃСЏ. Р­С‚РѕС‚ РїРѕРґС…РѕРґ РіР°СЂР°РЅС‚РёСЂСѓРµС‚ РѕС‚СЃСѓС‚СЃС‚РІРёРµ С„РѕРЅРѕРІС‹С… РїСЂРѕС†РµСЃСЃРѕРІ РїРѕСЃР»Рµ Р·Р°РєСЂС‹С‚РёСЏ РѕРєРЅР° РїСЂРёР»РѕР¶РµРЅРёСЏ.

РС‚РѕРіРѕРІС‹Рµ РїСЂР°РІРєРё РІ launcher.py:

Р”РѕР±Р°РІРёС‚СЊ РёРјРїРѕСЂС‚ socket, subprocess, webbrowser.

РЈСЃС‚Р°РЅРѕРІРёС‚СЊ BACKEND_HOST = "127.0.0.1" Рё РІС‹С‡РёСЃР»СЏС‚СЊ BACKEND_PORT РґРёРЅР°РјРёС‡РµСЃРєРё, РєР°Рє РїРѕРєР°Р·Р°РЅРѕ РІС‹С€Рµ, РІРјРµСЃС‚Рѕ Р¶РµСЃС‚РєРѕРіРѕ Р·РЅР°С‡РµРЅРёСЏ 8765.

РСЃРїРѕР»СЊР·РѕРІР°С‚СЊ Config/Server РёР»Рё uvicorn.run СЃ РїРѕР»СѓС‡РµРЅРЅС‹Рј РїРѕСЂС‚РѕРј РґР»СЏ Р·Р°РїСѓСЃРєР° FastAPI.

РџРѕСЃР»Рµ СЃС‚Р°СЂС‚Р° Р±СЌРєРµРЅРґР° вЂ“ РІС‹Р·РІР°С‚СЊ subprocess.Popen РґР»СЏ Edge/Chrome СЃ РїРѕР»РЅС‹РјРё РїСѓС‚СЏРјРё Рє exe С„Р°Р№Р»Р°Рј.

РџРѕСЃР»Рµ Р·Р°РїСѓСЃРєР° РѕРєРЅР° вЂ“ Р·Р°Р±Р»РѕРєРёСЂРѕРІР°С‚СЊ РіР»Р°РІРЅС‹Р№ РїРѕС‚РѕРє РЅР° РѕР¶РёРґР°РЅРёРµ Р·Р°РєСЂС‹С‚РёСЏ (proc.wait()), Р·Р°С‚РµРј Р·Р°РІРµСЂС€РёС‚СЊ РїСЂРѕРіСЂР°РјРјСѓ.

РџСЂРёРјРµСЂ: РѕР±РЅРѕРІР»РµРЅРЅС‹Р№ РїСЃРµРІРґРѕРєРѕРґ launcher.py:

import socket, subprocess, webbrowser, threading, time
from uvicorn import Config, Server

BACKEND_HOST = "127.0.0.1"
# pick free port
with socket.socket() as s:
    s.bind((BACKEND_HOST, 0))
    BACKEND_PORT = s.getsockname()[1]

def start_backend():
    config = Config("backend.main:app", host=BACKEND_HOST, port=BACKEND_PORT, log_level="info")
    Server(config).run()

# Start backend thread
thread = threading.Thread(target=start_backend, daemon=True)
thread.start()
time.sleep(1.0)  # wait for server up

# Launch UI in Edge/Chrome app-mode
url = f"http://{BACKEND_HOST}:{BACKEND_PORT}"
try:
    proc = subprocess.Popen(["msedge", "--app=" + url])
except FileNotFoundError:
    try:
        proc = subprocess.Popen(["chrome", "--app=" + url])
    except FileNotFoundError:
        proc = None
        webbrowser.open(url)
if proc:
    proc.wait()
# When window closes, exit launcher (daemon thread will terminate)


Р­С‚Рё РёР·РјРµРЅРµРЅРёСЏ РЅРµ С‚СЂРµР±СѓСЋС‚ Р»РѕРєР°Р»СЊРЅРѕРіРѕ dev-СЃРµСЂРІРµСЂР° (Vite РЅРµ РЅСѓР¶РµРЅ вЂ“ РјС‹ СЂР°Р±РѕС‚Р°РµРј СЃ РіРѕС‚РѕРІРѕР№ СЃР±РѕСЂРєРѕР№). РўР°РєР¶Рµ РјС‹ РЅРµ РґРµСЂР¶РёРј РїРѕСЃС‚РѕСЏРЅРЅС‹Р№ С„РёРєСЃРёСЂРѕРІР°РЅРЅС‹Р№ РїРѕСЂС‚: РїРѕСЂС‚ РІС‹Р±РёСЂР°РµС‚СЃСЏ РґРёРЅР°РјРёС‡РµСЃРєРё. Р—Р°РјРµС‚СЊС‚Рµ: С…РѕС‚СЏ РјС‹ РІСЃРµ РµС‰Рµ РёСЃРїРѕР»СЊР·СѓРµРј HTTP РґР»СЏ СЃРІСЏР·Рё С„СЂРѕРЅС‚Р° Рё Р±СЌРєР°, СЃРѕРєРµС‚ СЃР»СѓС€Р°РµС‚СЃСЏ С‚РѕР»СЊРєРѕ РЅР° 127.0.0.1 (Р»РѕРєР°Р»СЊРЅРѕ) Рё РЅР° СЃР»СѓС‡Р°Р№РЅРѕРј РїРѕСЂС‚Сѓ вЂ“ С‚.Рµ. РЅРё РѕРґРёРЅ РІРЅРµС€РЅРёР№ РїРѕСЂС‚ РЅРµ Р·Р°РЅСЏС‚, Рё РїСЂРё РїРѕРІС‚РѕСЂРЅРѕРј Р·Р°РїСѓСЃРєРµ РЅРµ Р±СѓРґРµС‚ РєРѕРЅС„Р»РёРєС‚Р°. РџРѕР»СЊР·РѕРІР°С‚РµР»СЊ СЌС‚РѕРіРѕ РЅРµ Р·Р°РјРµС‚РёС‚, С‚.Рє. РїСЂРёР»РѕР¶РµРЅРёРµ СЃР°РјРѕ РѕС‚РєСЂС‹РІР°РµС‚ РЅСѓР¶РЅС‹Р№ URL РІ РѕС‚РґРµР»СЊРЅРѕРј РѕРєРЅРµ Р±РµР· Р°РґСЂРµСЃРЅРѕР№ СЃС‚СЂРѕРєРё.

РЎР±РѕСЂРєР° PyInstaller: РµРґРёРЅС‹Р№ .exe

Р§С‚РѕР±С‹ РїРѕР»СѓС‡РёС‚СЊ РµРґРёРЅС‹Р№ РёСЃРїРѕР»РЅСЏРµРјС‹Р№ С„Р°Р№Р», РЅР°СЃС‚СЂРѕРёРј PyInstaller СЃРѕРѕС‚РІРµС‚СЃС‚РІСѓСЋС‰РёРј РѕР±СЂР°Р·РѕРј:

Spec-С„Р°Р№Р» РёР»Рё РєРѕРјР°РЅРґР°: Р’ РґРѕРєСѓРјРµРЅС‚Р°С†РёРё РїСЂРёРІРµРґС‘РЅ РїСЂРёРјРµСЂ build/keyset.spec. РќСѓР¶РЅРѕ СѓР±РµРґРёС‚СЊСЃСЏ, С‡С‚Рѕ РІ РЅС‘Рј СѓРєР°Р·Р°РЅС‹ РІСЃРµ РЅСѓР¶РЅС‹Рµ С„Р°Р№Р»С‹. РћР±СЂР°С‚РёС‚Рµ РІРЅРёРјР°РЅРёРµ РЅР° Р±Р»РѕРє datas: С‚Р°Рј СѓР¶Рµ РґРѕР±Р°РІР»РµРЅС‹ *collect_frontend() (РїР°РїРєР° С„СЂРѕРЅС‚РµРЅРґР°), РїР°РїРєР° keyset (РІРєР»СЋС‡Р°СЏ keyset/data/regions_tree_full.json), Рё СЃРєСЂС‹С‚С‹Рµ РёРјРїРѕСЂС‚С‹ (playwright._impl._backend, uvicorn, fastapi etc.).

РЈС‡С‚РёС‚Рµ РїРѕРґРєР»СЋС‡РµРЅРёРµ launcher: Р’ spec-С„Р°Р№Р»Рµ РІ Analysis СѓРєР°Р·С‹РІР°РµС‚СЃСЏ СЃРїРёСЃРѕРє РІС…РѕРґРЅС‹С… СЃРєСЂРёРїС‚РѕРІ вЂ“ РІ РїСЂРёРјРµСЂРµ СЌС‚Рѕ ['launcher.py']. PyInstaller Р±СѓРґРµС‚ СѓРїР°РєРѕРІС‹РІР°С‚СЊ launcher СЃ Edge --app СЂРµС€РµРЅРёРµРј.

РЈСЃС‚Р°РЅРѕРІРёС‚Рµ С„Р»Р°Рі СЃР±РѕСЂРєРё РѕРґРЅРѕРіРѕ С„Р°Р№Р»Р°. Р•СЃР»Рё РёСЃРїРѕР»СЊР·СѓРµС‚Рµ .spec, СЌС‚Рѕ РґРµР»Р°РµС‚СЃСЏ РїСЂРё РІС‹Р·РѕРІРµ РєРѕРјР°РЅРґС‹: pyinstaller --onefile build/keyset.spec. Р•СЃР»Рё .spec РЅРµ РёСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ, РјРѕР¶РЅРѕ РЅР°СЃС‚СЂРѕРёС‚СЊ EXE(..., exclude_binaries=False) Рё colllect РїСЂР°РІРёР»Р°, РЅРѕ РїСЂРѕС‰Рµ С‡РµСЂРµР· РїР°СЂР°РјРµС‚СЂ CLI. Р’ РѕРґРЅРѕРј С„Р°Р№Р»Рµ РІСЃРµ РґР°РЅРЅС‹Рµ РѕРєР°Р¶СѓС‚СЃСЏ РІРЅСѓС‚СЂРё .exe (СѓРїР°РєРѕРІР°РЅРЅС‹Рµ РІ bootloader).

Р’РєР»СЋС‡РµРЅРёРµ С„Р°Р№Р»РѕРІ Р‘Р” Рё РєРѕРЅС„РёРіСѓСЂР°С†РёРё: Р’Р°Р¶РЅРѕ, С‡С‚РѕР±С‹ SQLite-Р±Р°Р·Р° Рё JSON-РєРѕРЅС„РёРіРё РїРѕРїР°Р»Рё РІ СЃР±РѕСЂРєСѓ. Р’ РїСЂРёРјРµСЂРµ spec РѕРЅРё РЅРµ СЏРІРЅРѕ СѓРєР°Р·Р°РЅС‹, РЅРѕ С„РёРЅР°Р»СЊРЅР°СЏ СЃС‚СЂСѓРєС‚СѓСЂР° dist/ СѓРєР°Р·С‹РІР°РµС‚ РЅР° РЅР°Р»РёС‡РёРµ keyset.db Рё regions.json. Р­С‚Рѕ Р·РЅР°С‡РёС‚, С‡С‚Рѕ РїСЂРѕС†РµСЃСЃ СЃР±РѕСЂРєРё (СЃРєСЂРёРїС‚ scripts/package.py РёР»Рё Installer) РєРѕРїРёСЂРѕРІР°Р» РёС… РѕС‚РґРµР»СЊРЅРѕ. Р”Р»СЏ truly one-file РјС‹ РґРѕР»Р¶РЅС‹ РІРєР»СЋС‡РёС‚СЊ РёС… Р·Р°СЂР°РЅРµРµ:

Р”РѕР±Р°РІСЊС‚Рµ РїСѓС‚СЊ Рє backend/keyset.db РІ datas СЃРїРёСЃРєР° PyInstaller. РќР°РїСЂРёРјРµСЂ: datas=[(...), (str(project_root / 'backend' / 'keyset.db'), '.') ]. Р—РґРµСЃСЊ РІС‚РѕСЂРѕР№ СЌР»РµРјРµРЅС‚ '.' РѕР·РЅР°С‡Р°РµС‚, С‡С‚Рѕ С„Р°Р№Р» Р±СѓРґРµС‚ РїРѕРјРµС‰С‘РЅ РІ РєРѕСЂРµРЅСЊ СЃР±РѕСЂРєРё. РњРѕР¶РЅРѕ РїРѕРјРµСЃС‚РёС‚СЊ РµРіРѕ, РЅР°РїСЂРёРјРµСЂ, РІ С‚Сѓ Р¶Рµ РґРёСЂРµРєС‚РѕСЂРёСЋ, С‡С‚Рѕ Рё Р±РёРЅР°СЂРЅРёРє, РЅРѕ РІ onefile СЌС‚Рѕ РЅРµ РёРјРµРµС‚ Р·РЅР°С‡РµРЅРёСЏ.

РђРЅР°Р»РѕРіРёС‡РЅРѕ, РµСЃР»Рё РµСЃС‚СЊ backend/regions.json (РёР»Рё keyset/config/proxies.json Рё С‚.Рґ.), РґРѕР±Р°РІСЊС‚Рµ РёС…. РџСЂРѕРµРєС‚ СѓР¶Рµ РІРєР»СЋС‡Р°Р» regions_tree_full.json (РґР»СЏ РґРµСЂРµРІР° СЂРµРіРёРѕРЅРѕРІ), РЅРѕ РІ РёС‚РѕРіРѕРІРѕРј РґРёСЃС‚СЂРёР±СѓС‚РёРІРµ Р±С‹Р» С„Р°Р№Р» regions.json. Р’РѕР·РјРѕР¶РЅРѕ, regions.json вЂ“ СЂРµР·СѓР»СЊС‚Р°С‚ РїСЂРµРѕР±СЂР°Р·РѕРІР°РЅРёСЏ РёР»Рё РґСЂСѓРіРѕР№ С„РѕСЂРјР°С‚. Р•СЃР»Рё РѕРЅ РЅСѓР¶РµРЅ, РґРѕР±Р°РІСЊС‚Рµ Рё РµРіРѕ.

РСЃРїРѕР»СЊР·РѕРІР°РЅРёРµ РІСЃС‚СЂРѕРµРЅРЅС‹С… РґР°РЅРЅС‹С… РїСЂРё Р·Р°РїСѓСЃРєРµ: One-file СЂРµР¶РёРј PyInstaller СЂР°СЃРїР°РєРѕРІС‹РІР°РµС‚ СЃРѕРґРµСЂР¶РёРјРѕРµ РІРѕ РІСЂРµРјРµРЅРЅСѓСЋ РїР°РїРєСѓ РїСЂРё СЃС‚Р°СЂС‚Рµ (РґРѕСЃС‚СѓРїРЅСѓСЋ С‡РµСЂРµР· sys._MEIPASS). РќР°Рј РЅСѓР¶РЅРѕ СѓС‡РµСЃС‚СЊ СЌС‚Рѕ РІ РєРѕРґРµ:

РЎС‚Р°С‚РёС‡РµСЃРєРёРµ С„Р°Р№Р»С‹ С„СЂРѕРЅС‚РµРЅРґР°: Р’ FastAPI РјРѕРЅС‚РёСЂСѓРµС‚СЃСЏ FRONTEND_DIST РєР°Рє Path(__file__).parent.parent / 'frontend/dist'. Р’ Р·Р°РјРѕСЂРѕР¶РµРЅРЅРѕРј exe С‚Р°РєРѕР№ РїСѓС‚СЊ РЅРµ СЃСѓС‰РµСЃС‚РІСѓРµС‚ РЅР° РґРёСЃРєРµ. РћРґРЅР°РєРѕ, Р±Р»Р°РіРѕРґР°СЂСЏ С‚РѕРјСѓ, С‡С‚Рѕ РјС‹ РґРѕР±Р°РІРёР»Рё frontend/dist РІ datas, PyInstaller СЂР°СЃРїР°РєСѓРµС‚ РїР°РїРєСѓ frontend РІРѕ РІСЂРµРјРµРЅРЅРѕРµ С…СЂР°РЅРёР»РёС‰Рµ. РџСЂРѕСЃС‚РѕРµ СЂРµС€РµРЅРёРµ вЂ“ РѕРїСЂРµРґРµР»РёС‚СЊ РїСѓС‚СЊ Рє СЃС‚Р°С‚РёРєРµ РґРёРЅР°РјРёС‡РµСЃРєРё:

import sys
if getattr(sys, 'frozen', False):
    # Р’ СЂРµР¶РёРјРµ СЃР±РѕСЂРєРё РїСѓС‚СЊ Рє static С‡РµСЂРµР· _MEIPASS
    static_dir = Path(sys._MEIPASS) / 'frontend' / 'dist'
else:
    static_dir = FRONTEND_DIST  # РєР°Рє СЂР°РЅСЊС€Рµ, РґР»СЏ dev-СЂРµР¶РёРјР°
app.mount("/", StaticFiles(directory=static_dir, html=True), name="frontend")


Р’СЃС‚Р°РІСЊС‚Рµ СЌС‚Сѓ Р»РѕРіРёРєСѓ РІ backend/main.py РІРјРµСЃС‚Рѕ РїСЂСЏРјРѕРіРѕ РёСЃРїРѕР»СЊР·РѕРІР°РЅРёСЏ FRONTEND_DIST. РўР°РєРёРј РѕР±СЂР°Р·РѕРј, РїСЂРё Р·Р°РїСѓСЃРєРµ .exe РїСЂРёР»РѕР¶РµРЅРёРµ РЅР°Р№РґС‘С‚ index.html РІ СЂР°СЃРїР°РєРѕРІР°РЅРЅС‹С… СЂРµСЃСѓСЂСЃР°С….

Р‘Р°Р·Р° РґР°РЅРЅС‹С…: SQLite-С„Р°Р№Р» РЅРµ РґРѕР»Р¶РµРЅ РѕСЃС‚Р°РІР°С‚СЊСЃСЏ С‚РѕР»СЊРєРѕ РІРЅСѓС‚СЂРё .exe, РёРЅР°С‡Рµ РёР·РјРµРЅРµРЅРёСЏ РЅРµ СЃРѕС…СЂР°РЅСЏС‚СЃСЏ РјРµР¶РґСѓ Р·Р°РїСѓСЃРєР°РјРё. РњС‹ РІРєР»СЋС‡РёР»Рё keyset.db РІ СЃР±РѕСЂРєСѓ, РЅРѕ РїСЂРё РєР°Р¶РґРѕРј СЃС‚Р°СЂС‚Рµ РѕРЅ Р±СѓРґРµС‚ СЂР°СЃРїР°РєРѕРІР°РЅ Р·Р°РЅРѕРІРѕ РІРѕ РІСЂРµРјРµРЅРЅСѓСЋ РїР°РїРєСѓ, Рё РІСЃРµ РёР·РјРµРЅРµРЅРёСЏ РїСЂРѕРїР°РґСѓС‚ РїСЂРё РІС‹С…РѕРґРµ. Р РµС€РµРЅРёРµ вЂ“ СЃРєРѕРїРёСЂРѕРІР°С‚СЊ Р±Р°Р·Сѓ РІ РїРѕСЃС‚РѕСЏРЅРЅРѕРµ РјРµСЃС‚Рѕ. РњРѕР¶РЅРѕ РІС‹Р±СЂР°С‚СЊ РїР°РїРєСѓ СЂСЏРґРѕРј СЃ .exe РёР»Рё, Р»СѓС‡С€Рµ, РІ %APPDATA%/KeySet/ РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ. Р”Р»СЏ РїСЂРѕСЃС‚РѕС‚С‹ РїСЂРµРґРїРѕР»РѕР¶РёРј, С‡С‚Рѕ СЂСЏРґРѕРј СЃ .exe (С‚РµРєСѓС‰Р°СЏ СЂР°Р±РѕС‡Р°СЏ РґРёСЂРµРєС‚РѕСЂРёСЏ) вЂ“ С‚Р°Рє РїРѕР»СЊР·РѕРІР°С‚РµР»СЋ РїРѕРЅСЏС‚РЅРµРµ (РѕРЅ СЃРјРѕР¶РµС‚ РЅР°Р№С‚Рё С„Р°Р№Р» Р±Р°Р·С‹, РµСЃР»Рё РЅСѓР¶РЅРѕ). Р РµР°Р»РёР·СѓРµРј С‚Р°Рє РІ РєРѕРґРµ Р·Р°РїСѓСЃРєР°:

import shutil, os
if getattr(sys, 'frozen', False):
    bundle_dir = Path(sys._MEIPASS)
    bundled_db = bundle_dir / 'backend' / 'keyset.db'  # РёСЃС…РѕРґРЅС‹Р№ С„Р°Р№Р» РІ РїР°РєРµС‚Рµ
    target_db = Path(os.getcwd()) / 'keyset.db'
    if not target_db.exists():
        shutil.copy2(bundled_db, target_db)
    # РћР±РЅРѕРІРёРј РїСѓС‚СЊ РІ РЅР°СЃС‚СЂРѕР№РєР°С…, С‡С‚РѕР±С‹ SQLAlchemy РёСЃРїРѕР»СЊР·РѕРІР°Р» РІРЅРµС€РЅРёР№ С„Р°Р№Р»:
    DB_PATH = target_db


Р­С‚Рѕ РјРѕР¶РЅРѕ РІСЃС‚Р°РІРёС‚СЊ РІ РЅР°С‡Р°Р»Рѕ backend/db.py РґРѕ СЃРѕР·РґР°РЅРёСЏ engine. Р’ РІР°С€РµРј РєРѕРґРµ DB_PATH РѕРїСЂРµРґРµР»СЏРµС‚СЃСЏ РєР°Рє BASE_DIR/"keyset.db". РќСѓР¶РЅРѕ РёР·РјРµРЅРёС‚СЊ Р»РѕРіРёРєСѓ: РµСЃР»Рё РѕР±РЅР°СЂСѓР¶РµРЅРѕ, С‡С‚Рѕ СЂР°Р±РѕС‚Р°РµРј РёР· СЃР±РѕСЂРєРё, РїРµСЂРµРѕРїСЂРµРґРµР»РёС‚СЊ DB_PATH РЅР° РІРЅРµС€РЅРёР№ С„Р°Р№Р» (СЃРєРѕРїРёСЂРѕРІР°РІ РµРіРѕ РїСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё). РџРѕСЃР»Рµ СЌС‚РѕРіРѕ СЃС‚СЂРѕРєР° create_engine(f"sqlite:///{DB_PATH}", ...) Р±СѓРґРµС‚ РѕС‚РєСЂС‹РІР°С‚СЊ/СЃРѕР·РґР°РІР°С‚СЊ С„Р°Р№Р» РІ СЂР°Р±РѕС‡РµР№ РґРёСЂРµРєС‚РѕСЂРёРё, Р° РЅРµ РІРЅСѓС‚СЂРё С‚РµРјРїР°. Р’Р°Р¶РЅРѕ: СѓР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ РїСЂР°РІР° РЅР° Р·Р°РїРёСЃСЊ Сѓ СЌС‚РѕРіРѕ РєР°С‚Р°Р»РѕРіР° РµСЃС‚СЊ (РґР»СЏ Program Files Р»СѓС‡С€Рµ РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ %APPDATA%). РќРѕ РµСЃР»Рё .exe РЅРµ СѓСЃС‚Р°РЅР°РІР»РёРІР°РµС‚СЃСЏ РІ Program Files, Р° Р·Р°РїСѓСЃРєР°РµС‚СЃСЏ РёР· РїСЂРѕРёР·РІРѕР»СЊРЅРѕР№ РїР°РїРєРё, Р·Р°РїРёСЃРё СЂСЏРґРѕРј СЃ РЅРёРј РґРѕСЃС‚Р°С‚РѕС‡РЅРѕ.

РђР»СЊС‚РµСЂРЅР°С‚РёРІРЅРѕ, РјРѕР¶РЅРѕ РЅРµ РІРєР»СЋС‡Р°С‚СЊ keyset.db РІ РѕРґРёРЅ С„Р°Р№Р», Р° РїРѕСЃС‚Р°РІР»СЏС‚СЊ РµРіРѕ СЂСЏРґРѕРј вЂ“ РЅРѕ СЌС‚Рѕ РЅР°СЂСѓС€РёС‚ С‚СЂРµР±РѕРІР°РЅРёРµ вЂњРІСЃС‘ РІРЅСѓС‚СЂРё .exeвЂќ. РџРѕСЌС‚РѕРјСѓ СЂРµРєРѕРјРµРЅРґСѓРµРјС‹Р№ РїРѕРґС…РѕРґ вЂ“ РєРѕРїРёСЂРѕРІР°РЅРёРµ РЅР° РїРµСЂРІС‹Р№ Р·Р°РїСѓСЃРє.

Р¤Р°Р№Р»С‹ РєРѕРЅС„РёРіРѕРІ (JSON, Р»РѕРіРѕС‚РёРїС‹ Рё РґСЂ.): Р•СЃР»Рё РѕРЅРё РёСЃРїРѕР»СЊР·СѓСЋС‚СЃСЏ С‚РѕР»СЊРєРѕ РґР»СЏ С‡С‚РµРЅРёСЏ, РёС… РјРѕР¶РЅРѕ С‡РёС‚Р°С‚СЊ РїСЂСЏРјРѕ РёР· СЂР°СЃРїР°РєРѕРІР°РЅРЅС‹С… _MEIPASS. РќР°РїСЂРёРјРµСЂ, regions_tree_full.json РјРѕР¶РЅРѕ РѕС‚РєСЂС‹С‚СЊ РїРѕ Р°РЅР°Р»РѕРіРёС‡РЅРѕРјСѓ РїСЂРёРЅС†РёРїСѓ:

data_path = Path(sys._MEIPASS) / 'keyset' / 'data' / 'regions_tree_full.json'
with open(data_path, 'r', encoding='utf-8') as f:
    regions_data = json.load(f)


Р•СЃР»Рё Р¶Рµ РєР°РєРѕР№-С‚Рѕ JSON РґРѕР»Р¶РµРЅ СЃРѕС…СЂР°РЅСЏС‚СЊСЃСЏ (РЅР°РїСЂРёРјРµСЂ, proxies.json РјРѕР¶РµС‚ РёР·РјРµРЅСЏС‚СЊСЃСЏ?), С‚Рѕ СЃС‚РѕРёС‚ Р°РЅР°Р»РѕРіРёС‡РЅРѕ РєРѕРїРёСЂРѕРІР°С‚СЊ РµРіРѕ РЅР°СЂСѓР¶Сѓ. РЎСѓРґСЏ РїРѕ СЃС‚СЂСѓРєС‚СѓСЂРµ, proxies.json Рё regions.json СЃРєРѕСЂРµРµ С‡РёС‚Р°СЋС‚СЃСЏ, С‡РµРј РјРѕРґРёС„РёС†РёСЂСѓСЋС‚СЃСЏ, С‚Р°Рє С‡С‚Рѕ РёС… РјРѕР¶РЅРѕ РѕСЃС‚Р°РІРёС‚СЊ РІРЅСѓС‚СЂРё .exe. РџСЂРѕСЃС‚Рѕ РїСЂРѕРІРµСЂСЊС‚Рµ, РєР°Рє backend РёС… Р·Р°РіСЂСѓР¶Р°РµС‚ вЂ“ РµСЃР»Рё С‡РµСЂРµР· РѕС‚РЅРѕСЃРёС‚РµР»СЊРЅС‹Р№ РїСѓС‚СЊ, РІРѕР·РјРѕР¶РЅРѕ, РЅР°РґРѕ РїРѕРїСЂР°РІРёС‚СЊ РЅР° РёСЃРїРѕР»СЊР·РѕРІР°РЅРёРµ _MEIPASS Р°РЅР°Р»РѕРіРёС‡РЅРѕ Р±Р°Р·Рµ.

РЎР±РѕСЂРєР° .exe: Р—Р°РїСѓСЃС‚РёС‚Рµ PyInstaller СЃРѕ СЃРїРµС†РёС„РёРєР°С†РёРµР№. РќР°РїСЂРёРјРµСЂ:

pyinstaller --onefile build/keyset.spec


РЈР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ РІ РІС‹РІРѕРґРµ РЅРµ Р±С‹Р»Рѕ РѕС€РёР±РѕРє Рѕ missing module. Р’ СЃР»СѓС‡Р°Рµ С‡РµРіРѕ, РґРѕР±Р°РІСЊС‚Рµ РЅРµРґРѕСЃС‚Р°СЋС‰РёРµ РјРѕРґСѓР»Рё РІ hiddenimports. (Р’ РґРѕРєСѓРјРµРЅС‚Р°С†РёРё СѓРєР°Р·Р°РЅРѕ РґРѕР±Р°РІРёС‚СЊ pywin32 РґР»СЏ Win32 API, РЅРѕ РµСЃР»Рё РІС‹ РЅРµ РёСЃРїРѕР»СЊР·СѓРµС‚Рµ СЏРІРЅС‹Рµ win32calls, РјРѕР¶РЅРѕ РїСЂРѕРїСѓСЃС‚РёС‚СЊ. РћРґРЅР°РєРѕ, PyInstaller РёРЅРѕРіРґР° С‚СЂРµР±СѓРµС‚ pywin32 РґР»СЏ РєРѕСЂСЂРµРєС‚РЅРѕР№ СЂР°Р±РѕС‚С‹ subprocess/console вЂ“ РїСЂРѕРІРµСЂСЊС‚Рµ).

РџРѕ Р·Р°РІРµСЂС€РµРЅРёРё РІС‹ РїРѕР»СѓС‡РёС‚Рµ РµРґРёРЅС‹Р№ С„Р°Р№Р», СѓСЃР»РѕРІРЅРѕ dist/KeySet.exe (РЅР°Р·РІР°РЅРёРµ Р·Р°РґР°С‘С‚СЃСЏ РІ spec: name='KeySetLauncher' вЂ“ РјРѕР¶РµС‚Рµ РїРѕРјРµРЅСЏС‚СЊ). Р—Р°РїСѓСЃС‚РёРІ РµРіРѕ, РІС‹ РґРѕР»Р¶РЅС‹ СѓРІРёРґРµС‚СЊ, С‡С‚Рѕ:

РњРіРЅРѕРІРµРЅРЅРѕ РїРѕСЏРІР»СЏРµС‚СЃСЏ РѕРєРЅРѕ РїСЂРёР»РѕР¶РµРЅРёСЏ (Edge РёР»Рё Chrome РІ СЂРµР¶РёРјРµ РїСЂРёР»РѕР¶РµРЅРёСЏ, Р»РёР±Рѕ РІСЃС‚СЂРѕРµРЅРЅРѕРµ РѕРєРЅРѕ, РІ Р·Р°РІРёСЃРёРјРѕСЃС‚Рё РѕС‚ РІС‹Р±СЂР°РЅРЅРѕРіРѕ РїСѓС‚Рё). РќРµ РїРѕСЏРІР»СЏРµС‚СЃСЏ РєРѕРЅСЃРѕР»СЊ (РІ spec console=False).

Р’ С‚РµС‡РµРЅРёРµ ~1 СЃРµРєСѓРЅРґС‹ РїРѕРґРіСЂСѓР¶Р°СЋС‚СЃСЏ UI-РІРєР»Р°РґРєРё. РРЅС‚РµСЂС„РµР№СЃ React РґРѕР»Р¶РµРЅ СЂР°Р±РѕС‚Р°С‚СЊ РєР°Рє РїСЂРµР¶РґРµ: РїРµСЂРµРєР»СЋС‡РµРЅРёРµ РІРєР»Р°РґРѕРє, РјРѕРґР°Р»РєРё GeoSelector, СЃС‚РёР»Рё вЂ“ РІСЃС‘ РЅР° РјРµСЃС‚Рµ, С‚.Рє. РјС‹ РёСЃРїРѕР»СЊР·РѕРІР°Р»Рё С‚Сѓ Р¶Рµ СЃР±РѕСЂРєСѓ С„СЂРѕРЅС‚РµРЅРґР° Р±РµР· РёР·РјРµРЅРµРЅРёР№.

Р‘СЌРєРµРЅРґ С„СѓРЅРєС†РёРѕРЅРёСЂСѓРµС‚ РїРѕР»РЅРѕС†РµРЅРЅРѕ: РїРѕРїСЂРѕР±СѓР№С‚Рµ РІС‹РїРѕР»РЅРёС‚СЊ РѕСЃРЅРѕРІРЅС‹Рµ СЃС†РµРЅР°СЂРёРё (СЃРѕР·РґР°С‚СЊ Р°РєРєР°СѓРЅС‚, РёРјРїРѕСЂС‚РёСЂРѕРІР°С‚СЊ CSV, Р·Р°РїСѓСЃС‚РёС‚СЊ РїР°СЂСЃРёРЅРі вЂ“ РІРѕР·РјРѕР¶РЅРѕ, РІ РѕС„Р»Р°Р№РЅ-СЂРµР¶РёРјРµ РїР°СЂСЃРµСЂ РѕС‚РґР°СЃС‚ РјРѕРє-РґР°РЅРЅС‹Рµ). Р’СЃРµ API /api/... РІС‹Р·РѕРІС‹ РґРѕР»Р¶РЅС‹ СѓСЃРїРµС€РЅРѕ РІС‹РїРѕР»РЅСЏС‚СЊСЃСЏ.

РџСЂРѕРІРµСЂСЊС‚Рµ, С‡С‚Рѕ Р±Р°Р·Р° РґР°РЅРЅС‹С… СЃРѕС…СЂР°РЅСЏРµС‚ РёР·РјРµРЅРµРЅРёСЏ. РќР°РїСЂРёРјРµСЂ, РґРѕР±Р°РІР»РµРЅРЅС‹Р№ Р°РєРєР°СѓРЅС‚ РґРѕР»Р¶РµРЅ РѕСЃС‚Р°С‚СЊСЃСЏ РІ keyset.db РјРµР¶РґСѓ РїРµСЂРµР·Р°РїСѓСЃРєР°РјРё РїСЂРёР»РѕР¶РµРЅРёСЏ. Р”Р»СЏ СѓРІРµСЂРµРЅРЅРѕСЃС‚Рё РјРѕР¶РЅРѕ РѕС‚РєСЂС‹С‚СЊ/РїСЂРѕС‡РёС‚Р°С‚СЊ СЌС‚РѕС‚ С„Р°Р№Р» РІРЅРµ РїСЂРѕРіСЂР°РјРјС‹. Р•СЃР»Рё РёР·РјРµРЅРµРЅРёСЏ РЅРµ СЃРѕС…СЂР°РЅСЏСЋС‚СЃСЏ, СѓР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ РІС‹ РїСЂР°РІРёР»СЊРЅРѕ СЂРµР°Р»РёР·РѕРІР°Р»Рё РєРѕРїРёСЂРѕРІР°РЅРёРµ Р‘Р” РІРѕ РІРЅРµС€РЅРёР№ С„Р°Р№Р» Рё С‡С‚Рѕ SQLAlchemy РґРµР№СЃС‚РІРёС‚РµР»СЊРЅРѕ РїРёС€РµС‚ РІ РЅРµРіРѕ (РјРѕР¶РЅРѕ РґРѕР±Р°РІРёС‚СЊ РІСЂРµРјРµРЅРЅРѕ Р»РѕРіРёСЂРѕРІР°РЅРёРµ echo=True).

РЈСЃС‚СЂР°РЅРµРЅРёРµ РІРѕР·РјРѕР¶РЅС‹С… РјРµР»РєРёС… РїСЂРѕР±Р»РµРј:

Р‘Р»РѕРєРёСЂРѕРІРєР° Р‘Р”: Р’ РґРѕРєСѓРјРµРЅС‚Р°С†РёРё РѕС‚РјРµС‡Р°Р»Р°СЃСЊ РѕС€РёР±РєР° "Database locked" РїСЂРё РїРѕРІС‚РѕСЂРЅРѕРј Р·Р°РїСѓСЃРєРµ РЅРµСЃРєРѕР»СЊРєРёС… СЌРєР·РµРјРїР»СЏСЂРѕРІ. РќР°С€ РїРѕРґС…РѕРґ СЃ РґРёРЅР°РјРёС‡РµСЃРєРёРј РїРѕСЂС‚РѕРј РїРѕР·РІРѕР»СЏРµС‚ Р·Р°РїСѓСЃС‚РёС‚СЊ РґРІР° СЌРєР·РµРјРїР»СЏСЂР° (РѕРЅРё РІРѕР·СЊРјСѓС‚ СЂР°Р·РЅС‹Рµ РїРѕСЂС‚С‹). РћРґРЅР°РєРѕ, РѕР±Р° СЌРєР·РµРјРїР»СЏСЂР° РїРѕРїС‹С‚Р°Р»РёСЃСЊ Р±С‹ РїРёСЃР°С‚СЊ РІ РѕРґРёРЅ Рё С‚РѕС‚ Р¶Рµ keyset.db РЅР° РґРёСЃРєРµ вЂ“ СЌС‚Рѕ РІС‹Р·РѕРІРµС‚ lock SQLite. Р§С‚РѕР±С‹ СЌС‚РѕРіРѕ РёР·Р±РµР¶Р°С‚СЊ, РјРѕР¶РЅРѕ Р·Р°РїСЂРµС‚РёС‚СЊ Р·Р°РїСѓСЃРє РІС‚РѕСЂРѕР№ РєРѕРїРёРё РёР»Рё РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ СЂР°Р·РЅС‹Рµ РїСѓС‚Рё РґР»СЏ Р‘Р”. РџСЂРѕС‰Рµ вЂ“ РЅРµ РґРѕРїСѓСЃРєР°Р№С‚Рµ РїР°СЂР°Р»Р»РµР»СЊРЅС‹Р№ Р·Р°РїСѓСЃРє: РЅР°РїСЂРёРјРµСЂ, РјРѕР¶РЅРѕ РїСЂРё СЃС‚Р°СЂС‚Рµ РїСЂРѕРІРµСЂСЏС‚СЊ РЅР°Р»РёС‡РёСЏ Р·Р°РїСѓС‰РµРЅРЅРѕРіРѕ РїСЂРѕС†РµСЃСЃР° (СЃР»РѕР¶РЅРµРµ) РёР»Рё РѕС‚РєСЂС‹РІР°С‚СЊ Р‘Р” РІ WAL-СЂРµР¶РёРјРµ. Р’ keyset/core/db.py РјРѕР¶РЅРѕ РІС‹РїРѕР»РЅРёС‚СЊ engine.execute("PRAGMA journal_mode=WAL;") СЃСЂР°Р·Сѓ РїРѕСЃР»Рµ СЃРѕР·РґР°РЅРёСЏ engine вЂ“ С‚РѕРіРґР° С‡С‚РµРЅРёРµ/Р·Р°РїРёСЃСЊ РёР· РґРІСѓС… РїСЂРѕС†РµСЃСЃРѕРІ Р±СѓРґРµС‚ Р±РµР·РѕРїР°СЃРЅРµРµ, С…РѕС‚СЏ РІСЃС‘ СЂР°РІРЅРѕ РЅРµ СЂРµРєРѕРјРµРЅРґСѓРµС‚СЃСЏ. Р’ СЂР°РјРєР°С… РјРёРЅРёРјР°Р»СЊРЅС‹С… РёР·РјРµРЅРµРЅРёР№ СЌС‚Рѕ РЅРµ СЃС‚СЂРѕРіРѕ РѕР±СЏР·Р°С‚РµР»СЊРЅРѕ, РЅРѕ СЂРµРєРѕРјРµРЅРґСѓРµС‚СЃСЏ РІРєР»СЋС‡РёС‚СЊ WAL, РєР°Рє СЃРѕРІРµС‚РѕРІР°Р»Рё РІ РґРѕРєСѓРјРµРЅС‚Р°С†РёРё.

Р›РѕРіРё Рё РІСЂРµРјРµРЅРЅС‹Рµ С„Р°Р№Р»С‹: Р•СЃР»Рё РІ РїСЂРѕРµРєС‚Рµ РµСЃС‚СЊ Р»РѕРіРёСЂРѕРІР°РЅРёРµ (logs/app.log СѓРїРѕРјРёРЅР°Р»СЃСЏ), СѓР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ Р»РѕРіРё РїРёС€СѓС‚СЃСЏ РІ РґРѕСЃС‚СѓРїРЅРѕРµ РјРµСЃС‚Рѕ. РњРѕР¶РЅРѕ РЅР°СЃС‚СЂРѕРёС‚СЊ logging РІ С„Р°Р№Р» СЂСЏРґРѕРј СЃ .exe РёР»Рё РІ %LOCALAPPDATA%. Р“Р»Р°РІРЅРѕРµ вЂ“ Р±РµР· РїРѕРїС‹С‚РѕРє РїРёСЃР°С‚СЊ РІРѕ РІСЂРµРјРµРЅРЅСѓСЋ РїР°РїРєСѓ PyInstaller (РѕРЅР° СѓРґР°Р»СЏРµС‚СЃСЏ). РђРЅР°Р»РѕРіРёС‡РЅРѕ, Playwright РїСЂРё РїРµСЂРІРѕРј Р·Р°РїСѓСЃРєРµ РјРѕР¶РµС‚ РїС‹С‚Р°С‚СЊСЃСЏ СЃРєР°С‡Р°С‚СЊ Chromium вЂ“ РЅРѕ РІ РІР°С€РµРј СЃР»СѓС‡Р°Рµ РІС‹ СѓР¶Рµ РІРєР»СЋС‡РёР»Рё РµРіРѕ РІ СЃР±РѕСЂРєСѓ (С‡РµСЂРµР· npx playwright install chromium). РЈР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ РїСЂРё Р·Р°РїСѓСЃРєРµ РѕС„Р»Р°Р№РЅ Playwright РЅРµ С…РѕС‡РµС‚ РЅРёС‡РµРіРѕ РґРѕРіСЂСѓР¶Р°С‚СЊ. РњРѕР¶РЅРѕ СѓСЃС‚Р°РЅРѕРІРёС‚СЊ РїРµСЂРµРјРµРЅРЅС‹Рµ РѕРєСЂСѓР¶РµРЅРёСЏ РґР»СЏ Playwright, СѓРєР°Р·С‹РІР°СЋС‰РёРµ РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ РІСЃС‚СЂРѕРµРЅРЅС‹Р№ Р±СЂР°СѓР·РµСЂ. РћР±С‹С‡РЅРѕ, PyInstaller СЃ Playwright С‚СЂРµР±СѓРµС‚ СЃРєРѕРїРёСЂРѕРІР°С‚СЊ РїР°РїРєСѓ СЃ Р±СЂР°СѓР·РµСЂРѕРј. РЎСѓРґСЏ РїРѕ spec, РІС‹ РІРєР»СЋС‡РёР»Рё 'playwright._impl._backend' вЂ“ СЌС‚РѕРіРѕ РґРѕСЃС‚Р°С‚РѕС‡РЅРѕ РґР»СЏ РєРѕРґР°, РЅРѕ СЃР°Рј Р±РёРЅР°СЂРЅРёРє Chromium (РІ %USERPROFILE%\.cache\ms-playwright\) РЅСѓР¶РЅРѕ Р»РёР±Рѕ РѕСЃС‚Р°РІРёС‚СЊ РЅР° РјРµСЃС‚Рµ, Р»РёР±Рѕ РєРѕРїРёСЂРѕРІР°С‚СЊ. РџСЂРѕРІРµСЂСЊС‚Рµ РЅР° С‡РёСЃС‚РѕР№ РјР°С€РёРЅРµ: РµСЃР»Рё РїР°СЂСЃРёРЅРі РЅРµ Р·Р°РїСѓСЃРєР°РµС‚СЃСЏ РёР·-Р·Р° РѕС‚СЃСѓС‚СЃС‚РІРёСЏ Р±СЂР°СѓР·РµСЂР°, РїСЂРёРґС‘С‚СЃСЏ Р»РёР±Рѕ Р·Р°РїСѓСЃРєР°С‚СЊ playwright install РїСЂРё РёРЅСЃС‚Р°Р»Р»СЏС†РёРё, Р»РёР±Рѕ РІРєР»СЋС‡РёС‚СЊ РїР°РїРєСѓ Chromium РІ СѓСЃС‚Р°РЅРѕРІС‰РёРє (Inno Setup script РјРѕР¶РµС‚ СЌС‚Рѕ СЃРґРµР»Р°С‚СЊ).

Env Рё Dev СЂРµР¶РёРјС‹: Р•СЃР»Рё РіРґРµ-С‚Рѕ РІ РєРѕРґРµ РїСЂРѕРІРµСЂСЏРµС‚СЃСЏ С„Р»Р°Рі debug/dev (РЅР°РїСЂРёРјРµСЂ, if __debug__: РёР»Рё РїРµСЂРµРјРµРЅРЅР°СЏ РѕРєСЂСѓР¶РµРЅРёСЏ), СѓР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ РІ РїСЂРѕРґР°РєС€РµРЅРµ РЅРёС‡РµРіРѕ Р»РёС€РЅРµРіРѕ РЅРµ РІС‹РїРѕР»РЅСЏРµС‚СЃСЏ. РќР°РїСЂРёРјРµСЂ, launcher.py --devtools СѓРїРѕРјРёРЅР°Р»РѕСЃСЊ: РјС‹ РјРѕР¶РµРј РїРѕРґРґРµСЂР¶Р°С‚СЊ Р°СЂРіСѓРјРµРЅС‚ --devtools РґР»СЏ РѕС‚Р»Р°РґРєРё (РЅР°РїСЂРёРјРµСЂ, РІРјРµСЃС‚Рѕ proc = subprocess.Popen([...]) РѕС‚РєСЂС‹С‚СЊ Р±СЂР°СѓР·РµСЂ СЃ devtools). РќРѕ СЌС‚Рѕ РЅРµ РєСЂРёС‚РёС‡РЅРѕ, РјРѕР¶РЅРѕ РѕРїСѓСЃС‚РёС‚СЊ.

РњРёРЅРёРјР°Р»СЊРЅС‹Рµ РїСЂР°РІРєРё Рё СЃРѕС…СЂР°РЅРµРЅРёРµ С„СѓРЅРєС†РёРѕРЅР°Р»СЊРЅРѕСЃС‚Рё

РќРёР¶Рµ РїРµСЂРµС‡РёСЃР»РёРј РєРѕРЅРєСЂРµС‚РЅРѕ, С‡С‚Рѕ Рё РіРґРµ РёР·РјРµРЅРёС‚СЊ, С‡С‚РѕР±С‹ СЃРѕР±СЂР°С‚СЊ РІСЃС‘ РІРѕРµРґРёРЅРѕ Р±РµР· РїРѕС‚РµСЂРё РІРѕР·РјРѕР¶РЅРѕСЃС‚РµР№:

Р¤Р°Р№Р» frontend/vite.config.js (РїСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё): СѓР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ РїР°СЂР°РјРµС‚СЂ base СЃРѕРѕС‚РІРµС‚СЃС‚РІСѓРµС‚ РїСѓС‚Рё СЂР°Р·РґР°С‡Рё. Р’ РЅР°С€РµРј СЃР»СѓС‡Р°Рµ РѕСЃС‚Р°РІР»СЏРµРј РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ ("/"). Р­С‚Рѕ РѕР·РЅР°С‡Р°РµС‚, С‡С‚Рѕ РїРѕСЃР»Рµ СЃР±РѕСЂРєРё РїСѓС‚Рё РІ index.html Р±СѓРґСѓС‚ РЅР°С‡РёРЅР°С‚СЊСЃСЏ СЃ "/", Рё РїСЂРё РјРѕРЅС‚РёСЂРѕРІР°РЅРёРё СЃС‚Р°С‚РёРєРё РЅР° РєРѕСЂРµРЅСЊ РѕРЅРё РєРѕСЂСЂРµРєС‚РЅРѕ Р·Р°РіСЂСѓР·СЏС‚СЃСЏ. Р•СЃР»Рё Р±С‹ СЃС‚Р°С‚РёРєР° Р±С‹Р»Р° РЅРµ РЅР° РєРѕСЂРЅРµ, РЅСѓР¶РЅРѕ Р±С‹Р»Рѕ Р±С‹ РёР·РјРµРЅРёС‚СЊ base. Р’ С‚РµРєСѓС‰РµР№ Р°СЂС…РёС‚РµРєС‚СѓСЂРµ РјРµРЅСЏС‚СЊ РЅРµ РЅР°РґРѕ.

Р¤Р°Р№Р» backend/main.py: РґРѕР±Р°РІРёС‚СЊ Р»РѕРіРёРєСѓ РІС‹Р±РѕСЂР° РїСѓС‚Рё Рє СЃС‚Р°С‚РёРєРµ РїСЂРё Р·Р°РјРѕСЂРѕР·РєРµ. РќР°РїСЂРёРјРµСЂ:

import sys
from pathlib import Path
from fastapi.staticfiles import StaticFiles

BASE_DIR = Path(__file__).resolve().parent
if getattr(sys, 'frozen', False):
    static_dir = Path(sys._MEIPASS) / "frontend" / "dist"
else:
    static_dir = BASE_DIR.parent / "frontend" / "dist"
if static_dir.exists():
    app.mount("/", StaticFiles(directory=static_dir, html=True), name="frontend")


РўР°РєР¶Рµ, СѓР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ РїРѕРґРєР»СЋС‡РµРЅРёРµ API-СЂРѕСѓС‚РµСЂРѕРІ РїСЂРѕРёСЃС…РѕРґРёС‚ РґРѕ СЌС‚РѕРіРѕ Р±Р»РѕРєР°. РќР°РїСЂРёРјРµСЂ:

from backend import routers  # СѓСЃР»РѕРІРЅРѕ, РёРјРїРѕСЂС‚ СЂРµРіРёСЃС‚СЂР°С†РёРё СЂРѕСѓС‚РѕРІ
app.include_router(routers.accounts, prefix="/api/accounts")
... (РїРѕРґРєР»СЋС‡РµРЅРёРµ РѕСЃС‚Р°Р»СЊРЅС‹С… СЂРѕСѓС‚РµСЂРѕРІ) ...
# РџРѕСЃР»Рµ РІСЃРµС… СЂРѕСѓС‚РµСЂРѕРІ:
app.mount("/", StaticFiles(...))


Р•СЃР»Рё СЂРѕСѓС‚С‹ РїРѕРґРєР»СЋС‡Р°СЋС‚СЃСЏ РІ РґСЂСѓРіРёС… РјРµСЃС‚Р°С…, СЃРѕС…СЂР°РЅРёС‚Рµ РёС… РїРѕСЂСЏРґРѕРє.

Р¤Р°Р№Р» backend/db.py (РёР»Рё РіРґРµ СЃРѕР·РґР°С‘С‚СЃСЏ РґРІРёР¶РѕРє SQLite): РІРЅРµРґСЂРёС‚Рµ Р»РѕРіРёРєСѓ РєРѕРїРёСЂРѕРІР°РЅРёСЏ Р±Р°Р·С‹ РЅР° РІРЅРµС€РЅРёР№ РїСѓС‚СЊ. РљРѕРЅРєСЂРµС‚РЅРѕ, СЃСЂР°Р·Сѓ РїРѕСЃР»Рµ РѕРїСЂРµРґРµР»РµРЅРёСЏ DB_PATH = BASE_DIR / "keyset.db", РІСЃС‚Р°РІСЊС‚Рµ:

import sys, shutil, os
if getattr(sys, 'frozen', False):
    bundle_dir = Path(sys._MEIPASS)
    bundled_db = bundle_dir / "backend" / "keyset.db"
    external_db = Path(os.getcwd()) / "keyset.db"
    if not external_db.exists():
        shutil.copy2(bundled_db, external_db)
    DB_PATH = external_db


Р—Р°С‚РµРј СѓР¶Рµ РёРґС‘С‚ engine = create_engine(f"sqlite:///{DB_PATH}", echo=False). РўР°РєРёРј РѕР±СЂР°Р·РѕРј, РїСЂРё РїРµСЂРІРѕРј Р·Р°РїСѓСЃРєРµ .exe РІ С‚РµРєСѓС‰РµР№ РїР°РїРєРµ РїРѕСЏРІРёС‚СЃСЏ С„Р°Р№Р» keyset.db (СЃРєРѕРїРёСЂРѕРІР°РЅРЅС‹Р№ РёР· РїР°РєРµС‚Р°), Рё РґР°Р»СЊС€Рµ РІСЃРµ РѕРїРµСЂР°С†РёРё Р±СѓРґСѓС‚ РёРґС‚Рё РІ РЅРµРіРѕ. Р’ РїРѕСЃР»РµРґСѓСЋС‰РёС… Р·Р°РїСѓСЃРєР°С… РєРѕРїРёСЂРѕРІР°РЅРёСЏ РЅРµ РїСЂРѕРёР·РѕР№РґС‘С‚ (С„Р°Р№Р» СѓР¶Рµ СЃСѓС‰РµСЃС‚РІСѓРµС‚, РјС‹ РµРіРѕ РЅРµ С‚СЂРѕРіР°РµРј, СЃРѕС…СЂР°РЅСЏСЏ РґР°РЅРЅС‹Рµ).
РџСЂРёРјРµС‡Р°РЅРёРµ: Р•СЃР»Рё С…РѕС‚РёС‚Рµ, РјРѕР¶РЅРѕ РІРјРµСЃС‚Рѕ os.getcwd() РІС‹Р±СЂР°С‚СЊ С„РёРєСЃРёСЂРѕРІР°РЅРЅРѕРµ РјРµСЃС‚Рѕ (РЅР°РїСЂРёРјРµСЂ, РІСЃРµРіРґР° РєР»Р°СЃС‚СЊ РІ %APPDATA%\KeySet\keyset.db). РўРѕРіРґР° СЃС‚РѕРёС‚ РІС‹С‡РёСЃР»РёС‚СЊ РїСѓС‚СЊ С‡РµСЂРµР· os.getenv("APPDATA") РёР»Рё Path.home(). РќРѕ СЌС‚Рѕ СѓР¶Рµ РїСЂРµРґРїРѕС‡С‚РµРЅРёРµ; СЂСЏРґРѕРј СЃ exe вЂ“ РїСЂРѕС‰Рµ РѕС‚Р»Р°РґРёС‚СЊ.

Р¤Р°Р№Р» launcher.py: РѕСЃРЅРѕРІРЅР°СЏ С‚РѕС‡РєР° РёР·РјРµРЅРµРЅРёР№:

Р”РѕР±Р°РІСЊС‚Рµ РёРјРїРѕСЂС‚С‹: import socket, subprocess, webbrowser, threading, time, sys, pathlib.

Р—Р°РґР°Р№С‚Рµ BACKEND_HOST = "127.0.0.1" Рё РЅРµ С„РёРєСЃРёСЂСѓР№С‚Рµ BACKEND_PORT, Р° РІС‹С‡РёСЃР»РёС‚Рµ (РєР°Рє Р±С‹Р»Рѕ РїРѕРєР°Р·Р°РЅРѕ РІС‹С€Рµ) С‡РµСЂРµР· СЃРѕРєРµС‚.

Р¤СѓРЅРєС†РёСЋ start_backend РјРѕР¶РЅРѕ РѕСЃС‚Р°РІРёС‚СЊ, РёР·РјРµРЅРёРІ uvicorn.run(...) РЅР° Р·Р°РїСѓСЃРє С‡РµСЂРµР· Config. Р›РёР±Рѕ РѕСЃС‚Р°РІРёС‚СЊ uvicorn.run вЂ“ РЅРѕ СѓС‡С‚РёС‚Рµ, С‡С‚Рѕ uvicorn.run РІРЅСѓС‚СЂРё СЃРµР±СЏ Р±Р»РѕРєРёСЂСѓРµС‚ РїРѕС‚РѕРє, РїРѕСЌС‚РѕРјСѓ РµСЃР»Рё РІС‹ РІС‹Р·С‹РІР°РµС‚Рµ РµС‘ Р±РµР· РЅРѕРІРѕРіРѕ РїРѕС‚РѕРєР°, РїСЂРёР»РѕР¶РµРЅРёРµ Р·Р°РІРёСЃРЅРµС‚ РЅР° Р±СЌРєРµРЅРґРµ. РќР°Рј РІР°Р¶РЅРѕ Р·Р°РїСѓСЃРєР°С‚СЊ СЃРµСЂРІРµСЂ РІ РѕС‚РґРµР»СЊРЅРѕРј РїРѕС‚РѕРєРµ, РєР°Рє Сѓ РІР°СЃ Рё СЃРґРµР»Р°РЅРѕ. РўР°Рє С‡С‚Рѕ:

def start_backend():
    uvicorn.run("backend.main:app", host=BACKEND_HOST, port=BACKEND_PORT, log_level="info")


(РњРѕР¶РЅРѕ Рё Config/Server, РЅРѕ uvicorn.run РїСЂРѕС‰Рµ Рё С‚РѕР¶Рµ СЂР°Р±РѕС‚Р°РµС‚ РІ РѕС‚РґРµР»СЊРЅРѕРј С‚СЂРµРґРµ).

Р РµР°Р»РёР·СѓР№С‚Рµ Р·Р°РїСѓСЃРє Р±СЂР°СѓР·РµСЂР° РІ Edge --app СЂРµР¶РёРјРµ СЃ РїРѕР»РЅС‹РјРё РїСѓС‚СЏРјРё Рє exe С„Р°Р№Р»Р°Рј:

# Р—Р°РїСѓСЃС‚РёС‚СЊ Р±СЌРєРµРЅРґ-РїРѕС‚РѕРє
thread = threading.Thread(target=start_backend, daemon=True)
thread.start()
time.sleep(1.0)
# РћС‚РєСЂС‹С‚СЊ URL
url = f"http://{BACKEND_HOST}:{BACKEND_PORT}"
try:
    proc = subprocess.Popen(["msedge", "--app=" + url])
except FileNotFoundError:
    try:
        proc = subprocess.Popen(["chrome", "--app=" + url])
    except FileNotFoundError:
        proc = None
        webbrowser.open(url)
if proc:
    proc.wait()


РћР±СЂР°С‚РёС‚Рµ РІРЅРёРјР°РЅРёРµ: С„Р»Р°Рі daemon=True Сѓ РїРѕС‚РѕРєР° Р±СЌРєРµРЅРґР° РѕР·РЅР°С‡Р°РµС‚, С‡С‚Рѕ РєРѕРіРґР° РѕСЃРЅРѕРІРЅРѕР№ РїРѕС‚РѕРє Р·Р°РІРµСЂС€РёС‚СЃСЏ, background-С‚СЂРµРґ РїСЂРµСЂРІС‘С‚СЃСЏ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё. Р­С‚Рѕ СѓРґРѕР±РЅРѕ РґР»СЏ РЅР°С€РµРіРѕ СЃР»СѓС‡Р°СЏ вЂ“ РЅРµ РЅСѓР¶РЅРѕ СЃРїРµС†РёР°Р»СЊРЅРѕ СѓР±РёРІР°С‚СЊ Uvicorn, РѕРЅ Р·Р°РІРµСЂС€РёС‚СЃСЏ, РєРѕРіРґР° РїСЂРёР»РѕР¶РµРЅРёРµ Р·Р°РєСЂРѕРµС‚СЃСЏ.

РЈРґР°Р»РёС‚Рµ СЃС‚СЂРѕРєСѓ Р·Р°РїСѓСЃРєР° PyWebView (webview.start()) Рё РІСЃРµ СЃРІСЏР·Р°РЅРЅС‹Рµ РїРµС‡Р°С‚Рё Р»РѕРіРѕРІ, С‡С‚РѕР±С‹ РѕРЅРё РЅРµ РѕС‚РІР»РµРєР°Р»Рё. РњРѕР¶РЅРѕ РѕСЃС‚Р°РІРёС‚СЊ print СЃ СЃРѕРѕР±С‰РµРЅРёРµРј, С‡С‚Рѕ Р·Р°РїСѓСЃРєР°РµС‚СЃСЏ Edge/Chrome, РґР»СЏ РѕС‚Р»Р°РґРєРё. Р’ С„РёРЅР°Р»СЊРЅРѕР№ РІРµСЂСЃРёРё РѕРЅРё РЅРµ РєСЂРёС‚РёС‡РЅС‹.

Spec-С„Р°Р№Р» PyInstaller (build/keyset.spec): РІРЅРµСЃРёС‚Рµ РёР·РјРµРЅРµРЅРёСЏ РґР»СЏ one-file:

Р’ СЃРµРєС†РёРё a = Analysis(...) РґРѕР±Р°РІСЊС‚Рµ Р·Р°РїРёСЃСЊ РґР»СЏ Р±Р°Р·С‹ РґР°РЅРЅС‹С… Рё РґСЂСѓРіРёС… С„Р°Р№Р»РѕРІ. РќР°РїСЂРёРјРµСЂ:

datas=[  
    (str(project_root / 'keyset'), 'keyset'),  
    (str(project_root / 'keyset' / 'data' / 'regions_tree_full.json'), 'keyset/data'),  
    (str(project_root / 'backend' / 'keyset.db'), 'backend'),  
    (str(project_root / 'backend' / 'regions.json'), 'backend'),  
    *collect_frontend(),  
],  


Р—РґРµСЃСЊ РјС‹ РІРєР»СЋС‡Р°РµРј РїР°РїРєСѓ keyset (СЃ РєРѕРґРѕРј Рё, РІРѕР·РјРѕР¶РЅРѕ, С€Р°Р±Р»РѕРЅР°РјРё/РјРѕРґРµР»СЏРјРё), JSON СЃ РґРµСЂРµРІРѕРј СЂРµРіРёРѕРЅРѕРІ, С„Р°Р№Р» Р±Р°Р·С‹ Рё С„Р°Р№Р» СЂРµРіРёРѕРЅРѕРІ (РµСЃР»Рё РµСЃС‚СЊ). РџСѓС‚СЊ 'backend' РІРѕ РІС‚РѕСЂРѕРј СЌР»РµРјРµРЅС‚Рµ РєРѕСЂС‚РµР¶Р° РѕР·РЅР°С‡Р°РµС‚, С‡С‚Рѕ РїСЂРё СЂР°СЃРїР°РєРѕРІРєРµ СЌС‚Рё С„Р°Р№Р»С‹ РѕРєР°Р¶СѓС‚СЃСЏ РІ РїР°РїРєРµ backend РІРЅСѓС‚СЂРё _MEIPASS (РјС‹ С‚Р°Рє РїР»Р°РЅРёСЂРѕРІР°Р»Рё РІ РєРѕРґРµ). Р’Р°Р¶РЅРѕ: РЈРєР°Р·С‹РІР°Р№С‚Рµ РїСЂР°РІРёР»СЊРЅС‹Рµ РїСѓС‚Рё: РЅР°РїСЂРёРјРµСЂ, РµСЃР»Рё regions.json Р»РµР¶РёС‚ РІ РєРѕСЂРЅРµ СЂРµРїРѕР·РёС‚РѕСЂРёСЏ, Р° РЅРµ РІ РїР°РїРєРµ backend, С‚Рѕ РЅСѓР¶РЅРѕ (str(project_root / 'regions.json'), '.'). РџСЂРѕРІРµСЂСЊС‚Рµ С„Р°РєС‚РёС‡РµСЃРєРѕРµ СЂР°СЃРїРѕР»РѕР¶РµРЅРёРµ. РЎРѕРіР»Р°СЃРЅРѕ РґРѕРєСѓРјРµРЅС‚Р°Рј, regions.json РјРѕР¶РµС‚ РЅР°С…РѕРґРёС‚СЊСЃСЏ РІ backend/regions.json РёР»Рё РІ keyset/config/regions.json. РџРѕРјРµСЃС‚РёС‚Рµ РµРіРѕ РІ С‚Сѓ Р¶Рµ РїР°РїРєСѓ, РіРґРµ РѕР¶РёРґР°РµС‚ РєРѕРґ.

РЈСЃС‚Р°РЅРѕРІРёС‚Рµ РІ РєРѕРЅС„РёРіСѓСЂР°С†РёРё СЃР±РѕСЂРєРё С„Р»Р°Рі onefile. Р•СЃР»Рё РІС‹ РёСЃРїРѕР»СЊР·СѓРµС‚Рµ spec, С‚Рѕ РІРјРµСЃС‚Рѕ РІС‹Р·РѕРІР° EXE(...) РЅСѓР¶РЅРѕ РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ РєРѕРјР°РЅРґСѓ pyinstaller --onefile keyset.spec. Р›РёР±Рѕ РІ spec РґРѕР±Р°РІРёС‚СЊ:

exe = EXE(..., upx=True, console=False, name="KeySet", onefile=True)


РћРґРЅР°РєРѕ, РІ СЃС‚Р°РЅРґР°СЂС‚РЅРѕРј С€Р°Р±Р»РѕРЅРµ spec РЅРµСЏРІРЅРѕ onefile СѓРїСЂР°РІР»СЏРµС‚СЃСЏ РєРѕРјР°РЅРґРѕР№. РџСЂРѕС‰Рµ вЂ“ Р·Р°РїСѓСЃРєР°С‚СЊ PyInstaller РєРѕРјР°РЅРґРѕР№ СЃ РїР°СЂР°РјРµС‚СЂРѕРј.

РџСЂРѕРІРµСЂСЊС‚Рµ hiddenimports. РњС‹ СѓР±СЂР°Р»Рё PyWebView, Р·РЅР°С‡РёС‚ РјРѕР¶РЅРѕ СѓРґР°Р»РёС‚СЊ 'pywebview' РёР· Р·Р°РІРёСЃРёРјРѕСЃС‚РµР№, РµСЃР»Рё РѕРЅ Р±С‹Р». Р”РѕР±Р°РІР»СЏС‚СЊ С‡С‚Рѕ-Р»РёР±Рѕ СЃРїРµС†РёР°Р»СЊРЅРѕ РЅРµ РЅСѓР¶РЅРѕ, С‚Р°Рє РєР°Рє РјС‹ РёСЃРїРѕР»СЊР·СѓРµРј СЃС‚Р°РЅРґР°СЂС‚РЅС‹Рµ РјРѕРґСѓР»Рё (socket, subprocess, etc.). Р•СЃР»Рё РІС‹Р±СЂР°Р»Рё РІСЃС‚СЂРѕРµРЅРЅС‹Р№ РІРµР±-РґРІРёР¶РѕРє, РїСЂРёРґС‘С‚СЃСЏ РґРѕР±Р°РІРёС‚СЊ РµРіРѕ РјРѕРґСѓР»Рё Рё СѓС‡РµСЃС‚СЊ РєРѕРїРёСЂРѕРІР°РЅРёРµ GUI-РїР»Р°РіРёРЅРѕРІ, РЅРѕ СЌС‚Рѕ РІС‹С…РѕРґРёС‚ Р·Р° СЂР°РјРєРё РјРёРЅРёРјР°Р»СЊРЅС‹С… РёР·РјРµРЅРµРЅРёР№. РЎ Edge/Chrome СЌС‚РѕРіРѕ РЅРµ РЅР°РґРѕ.

РЈСЃС‚Р°РЅРѕРІРѕС‡РЅС‹Р№ СЃРєСЂРёРїС‚ (Inno Setup) (РµСЃР»Рё РёСЃРїРѕР»СЊР·СѓРµС‚Рµ): Р Р°РЅРµРµ Inno РєРѕРїРёСЂРѕРІР°Р» РїР°РїРєСѓ frontend, exe-С€РЅРёРєРё Рё JSON. РўРµРїРµСЂСЊ Сѓ РЅР°СЃ РІСЃС‘ СѓРїР°РєРѕРІР°РЅРѕ РІ РѕРґРёРЅ .exe, РєСЂРѕРјРµ, РІРѕР·РјРѕР¶РЅРѕ, Р±Р°Р·С‹ РґР°РЅРЅС‹С…. Р РµС€РёС‚Рµ, РєР°Рє РІС‹ Р±СѓРґРµС‚Рµ СЂР°СЃРїСЂРѕСЃС‚СЂР°РЅСЏС‚СЊ Р±Р°Р·Сѓ:

Р’Р°СЂРёР°РЅС‚ 1: РќРµ РІРєР»СЋС‡Р°С‚СЊ Р±Р°Р·Сѓ РІ .exe, Р° РєР»Р°СЃС‚СЊ РµС‘ СЂСЏРґРѕРј РїСЂРё СѓСЃС‚Р°РЅРѕРІРєРµ. РўРѕРіРґР° Inno Setup РґРѕР»Р¶РµРЅ РїРѕ-РїСЂРµР¶РЅРµРјСѓ РєРѕРїРёСЂРѕРІР°С‚СЊ keyset.db РѕС‚РґРµР»СЊРЅРѕ РІ РїР°РїРєСѓ СѓСЃС‚Р°РЅРѕРІРєРё. Р’ СЌС‚РѕРј СЃР»СѓС‡Р°Рµ РІР°Рј РЅРµ РЅСѓР¶РµРЅ РєРѕРґ РєРѕРїРёСЂРѕРІР°РЅРёСЏ Р‘Р” вЂ“ РїСЂРёР»РѕР¶РµРЅРёРµ СЃСЂР°Р·Сѓ Р±СѓРґРµС‚ СЂР°Р±РѕС‚Р°С‚СЊ СЃ РІРЅРµС€РЅРёРј С„Р°Р№Р»РѕРј. РќРѕ С‚РѕРіРґР° РґРёСЃС‚СЂРёР±СѓС‚РёРІ вЂ“ СЌС‚Рѕ 2 С„Р°Р№Р»Р° (exe + db).

Р’Р°СЂРёР°РЅС‚ 2 (СЂРµРєРѕРјРµРЅРґСѓРµС‚СЃСЏ): Р’РєР»СЋС‡РёС‚СЊ Р±Р°Р·Сѓ РІ .exe Рё РєРѕРїРёСЂРѕРІР°С‚СЊ РЅР° РїРµСЂРІС‹Р№ Р·Р°РїСѓСЃРє. РўРѕРіРґР° СѓСЃС‚Р°РЅРѕРІС‰РёРє РјРѕР¶РµС‚ РЅРµ РєР»Р°СЃС‚СЊ keyset.db РѕС‚РґРµР»СЊРЅРѕ. РџСЂРё РєР°Р¶РґРѕРј Р·Р°РїСѓСЃРєРµ РїСЂРёР»РѕР¶РµРЅРёРµ СЃР°РјРѕ РѕР±РµСЃРїРµС‡РёС‚ РЅР°Р»РёС‡РёРµ СЌС‚РѕРіРѕ С„Р°Р№Р»Р°. Р”Р»СЏ Р±РµР·РѕРїР°СЃРЅРѕСЃС‚Рё РјРѕР¶РЅРѕ РґР°Р¶Рµ РїСЂРё РґРµРёРЅСЃС‚Р°Р»Р»СЏС†РёРё СЃРїСЂР°С€РёРІР°С‚СЊ, СѓРґР°Р»СЏС‚СЊ Р»Рё Р±Р°Р·Сѓ (С‡С‚РѕР±С‹ РїРѕР»СЊР·РѕРІР°С‚РµР»СЊ РјРѕРі СЃРѕС…СЂР°РЅРёС‚СЊ СЃРІРѕРё РґР°РЅРЅС‹Рµ).
Р’ Р»СЋР±РѕРј СЃР»СѓС‡Р°Рµ, РѕР±РЅРѕРІРёС‚Рµ keyset_installer.iss РїРѕРґ РЅРѕРІСѓСЋ СЃС‚СЂСѓРєС‚СѓСЂСѓ. Р•СЃР»Рё РѕРґРёРЅ exe вЂ“ С‚Рѕ [Files] СЃРµРєС†РёСЏ Р±СѓРґРµС‚ СЃРѕРґРµСЂР¶Р°С‚СЊ С‚РѕР»СЊРєРѕ СЌС‚РѕС‚ exe. Р•СЃР»Рё Р±Р°Р·Р° РѕС‚РґРµР»СЊРЅРѕ вЂ“ РґРѕР±Р°РІСЊС‚Рµ РµС‘. Р’ РїСЂРµРґС‹РґСѓС‰РµР№ РІРµСЂСЃРёРё:

Source: "dist\KeySetLauncher.exe"; DestDir: "{app}"
Source: "dist\keyset-backend.exe"; DestDir: "{app}"
Source: "dist\frontend\*"; DestDir: "{app}\frontend"
Source: "dist\regions.json"; DestDir: "{app}"


РўРµРїРµСЂСЊ РґРѕР»Р¶РЅРѕ Р±С‹С‚СЊ РїСЂРёРјРµСЂРЅРѕ:

Source: "dist\KeySet.exe"; DestDir: "{app}"
Source: "dist\keyset.db"; DestDir: "{app}"; Flags: ignoreversion


(Р•СЃР»Рё СЂРµС€РёС‚Рµ РєР»Р°СЃС‚СЊ Р±Р°Р·Сѓ). Р•СЃР»Рё Р±Р°Р·Р° РІРЅСѓС‚СЂРё .exe, РІС‚РѕСЂСѓСЋ СЃС‚СЂРѕС‡РєСѓ СѓР±СЂР°С‚СЊ.
РЎРєРѕСЂРµРµ РІСЃРµРіРѕ, СѓРґРѕР±РЅРµРµ РІСЃС‘-С‚Р°РєРё РґРѕСЃС‚Р°РІР»СЏС‚СЊ Р±Р°Р·Сѓ РѕС‚РґРµР»СЊРЅРѕ, С‡С‚РѕР±С‹ РЅРµ Р·Р°Р±РѕС‚РёС‚СЊСЃСЏ Рѕ РїРµСЂРµРЅРѕСЃРµ РґР°РЅРЅС‹С… РјРµР¶РґСѓ РІРµСЂСЃРёСЏРјРё .exe. РќРѕ СЂР°Р· Р·Р°РґР°С‡Р° вЂ“ В«РµРґРёРЅС‹Р№ .exeВ», РјС‹ РїСЂРµРґРїРѕР»Р°РіР°РµРј, С‡С‚Рѕ РІС‹ РІС‹Р±РµСЂРµС‚Рµ РІР°СЂРёР°РЅС‚ СЃ РєРѕРїРёСЂРѕРІР°РЅРёРµРј РЅР° Р·Р°РїСѓСЃРє Рё РЅРµ Р±СѓРґРµС‚Рµ РєР»Р°СЃС‚СЊ Р±Р°Р·Сѓ РІ РёРЅСЃС‚Р°Р»Р»СЏС‚РѕСЂРµ.

РџРѕСЃР»Рµ РІРЅРµСЃРµРЅРёСЏ СЌС‚РёС… РёР·РјРµРЅРµРЅРёР№, РІС‹РїРѕР»РЅРёС‚Рµ РїРѕР»РЅС‹Р№ С†РёРєР» СЃР±РѕСЂРєРё: npm run build в†’ pyinstaller ... в†’ (Inno Setup, РµСЃР»Рё РЅСѓР¶РЅРѕ). РџСЂРѕС‚РµСЃС‚РёСЂСѓР№С‚Рµ РїРѕР»СѓС‡РёРІС€РёР№СЃСЏ С„Р°Р№Р» РЅР° С‡РёСЃС‚РѕР№ РјР°С€РёРЅРµ Р±РµР· СѓСЃС‚Р°РЅРѕРІР»РµРЅРЅРѕРіРѕ Node/Python Рё Р±РµР· РґРѕСЃС‚СѓРїР° Рє РРЅС‚РµСЂРЅРµС‚Сѓ: РїСЂРёР»РѕР¶РµРЅРёРµ РґРѕР»Р¶РЅРѕ РѕС‚РєСЂС‹С‚СЊСЃСЏ РјРµРЅРµРµ С‡РµРј Р·Р° СЃРµРєСѓРЅРґСѓ Рё СЂР°Р±РѕС‚Р°С‚СЊ Р°РІС‚РѕРЅРѕРјРЅРѕ. Р’СЃРµ С„СѓРЅРєС†РёРё вЂ“ UI РІРєР»Р°РґРєРё, РїР°СЂСЃРёРЅРі С‡РµСЂРµР· Playwright (CDP), РІС‹Р±РѕСЂ РіРµРѕ, СЃРѕС…СЂР°РЅРµРЅРёРµ РґР°РЅРЅС‹С… вЂ“ РґРѕР»Р¶РЅС‹ РѕСЃС‚Р°С‚СЊСЃСЏ Р±РµР· РёР·РјРµРЅРµРЅРёР№.

Р’Р°Р¶РЅРѕ: РњС‹ РїСЂР°РєС‚РёС‡РµСЃРєРё РЅРёС‡РµРіРѕ РЅРµ РёР·РјРµРЅСЏР»Рё РІ СЃР°РјРѕРј РєРѕРґРµ РїСЂРёР»РѕР¶РµРЅРёСЏ (РЅРё РІ React, РЅРё РІ FastAPI Р»РѕРіРёРєРµ). РР·РјРµРЅРµРЅРёСЏ РєР°СЃР°СЋС‚СЃСЏ С‚РѕР»СЊРєРѕ СЃРїРѕСЃРѕР±Р° СѓРїР°РєРѕРІРєРё Рё Р·Р°РїСѓСЃРєР°. РўР°РєРёРј РѕР±СЂР°Р·РѕРј, РЅРµ РЅР°СЂСѓС€РµРЅР° СЂР°Р±РѕС‚Р° UI Рё backend:

UI (React) вЂ“ СЂР°Р·РІРµСЂРЅСѓС‚ С‚РѕС‚ Р¶Рµ build, СЃ С‚РµРјРё Р¶Рµ РІРєР»Р°РґРєР°РјРё, РјРѕРґР°Р»РєР°РјРё (GeoSelector) Рё code-splitting, С‡С‚Рѕ Рё СЂР°РЅСЊС€Рµ. РњС‹ РЅРµ С‚СЂРѕРіР°РµРј РёСЃС…РѕРґРЅРёРєРё React, РїРѕСЌС‚РѕРјСѓ РјРѕРґСѓР»СЊРЅР°СЏ СЃС‚СЂСѓРєС‚СѓСЂР° (Accounts/Data/Masks/Analytics) Рё Zustand-С…СЂР°РЅРёР»РёС‰Р° СЃРѕС…СЂР°РЅСЏСЋС‚СЃСЏ.

Backend (FastAPI + Playwright) вЂ“ Р·Р°РїСѓСЃРєР°РµС‚СЃСЏ РІРЅСѓС‚СЂРё .exe, РѕР±СЂР°Р±Р°С‚С‹РІР°РµС‚ API-Р·Р°РїСЂРѕСЃС‹ РєР°Рє СЂР°РЅСЊС€Рµ. CDP-РїР°СЂСЃРёРЅРі (С‡РµСЂРµР· Playwright) Р±СѓРґРµС‚ СЂР°Р±РѕС‚Р°С‚СЊ, РµСЃР»Рё Chromium РґРѕСЃС‚СѓРїРµРЅ. РЈР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ Playwright РІРёРґРёС‚ Chromium: Р»РёР±Рѕ РІРєР»СЋС‡РёС‚Рµ РµРіРѕ РІ РёРЅСЃС‚Р°Р»Р»СЏС‚РѕСЂ, Р»РёР±Рѕ РІС‹РїРѕР»РЅРёС‚Рµ playwright install РїСЂРё РїРµСЂРІРѕРј Р·Р°РїСѓСЃРєРµ. Р’ РѕС„С„Р»Р°Р№РЅ-СЂРµР¶РёРјРµ, РµСЃР»Рё Chromium РЅРµ РЅР°Р№РґРµРЅ, РїР°СЂСЃРёРЅРі РјРѕР¶РµС‚ СѓРїР°СЃС‚СЊ вЂ“ СЌС‚Рѕ РѕС‚РґРµР»СЊРЅС‹Р№ РјРѕРјРµРЅС‚: РјРѕР¶РЅРѕ Р·Р°СЂР°РЅРµРµ СЃРєР°С‡Р°С‚СЊ РЅСѓР¶РЅС‹Рµ С„Р°Р№Р»С‹. РќРѕ СЃР°Рј РјРµС…Р°РЅРёР·Рј (Р·Р°РїСѓСЃРє Chrome СЃ РїР°С‚С‡РёРЅРіРѕРј Р·Р°РїСЂРѕСЃРѕРІ РїРѕРґ РЅСѓР¶РЅС‹Р№ region_id) РјС‹ РЅРµ РјРµРЅСЏР»Рё, РѕРЅ РґРѕР»Р¶РµРЅ СЂР°Р±РѕС‚Р°С‚СЊ.

Geo patching Рё geotree: Р¤СѓРЅРєС†РёРѕРЅР°Р»СЊРЅРѕСЃС‚СЊ РІС‹Р±РѕСЂР° СЂРµРіРёРѕРЅР° С‚РѕР¶Рµ РЅРµ СЃС‚СЂР°РґР°РµС‚ вЂ“ С„Р°Р№Р» regions_tree_full.json РІРєР»СЋС‡С‘РЅ, endpoint /api/regions РѕС‚РґР°С‘С‚ РґР°РЅРЅС‹Рµ РґР»СЏ GeoSelector, С„СЂРѕРЅС‚РµРЅРґ Рё backend СЃРёРЅС…СЂРѕРЅРёР·РѕРІР°РЅС‹ РїРѕ ID СЂРµРіРёРѕРЅРѕРІ. РњС‹ Р»РёС€СЊ РґРѕР»Р¶РЅС‹ СѓР±РµРґРёС‚СЊСЃСЏ, С‡С‚Рѕ СЌС‚РѕС‚ JSON С‡РёС‚Р°РµС‚СЃСЏ РёР· РїСЂР°РІРёР»СЊРЅРѕРіРѕ РјРµСЃС‚Р° (СЃРј. РІС‹С€Рµ РїСЂРѕ _MEIPASS), РЅРѕ СЃСѓРґСЏ РїРѕ С‚РѕРјСѓ, С‡С‚Рѕ РјС‹ РїРѕР»РѕР¶РёР»Рё РµРіРѕ РІ keyset/data РІРЅСѓС‚СЂРё РїР°РєРµС‚Р° Рё РЅРµ РёР·РјРµРЅСЏР»Рё РєРѕРґ С‡С‚РµРЅРёСЏ, РІСЃС‘ Р±СѓРґРµС‚ С…РѕСЂРѕС€Рѕ.

РџРѕРґРІРѕРґСЏ РёС‚РѕРі, РјРёРЅРёРјР°Р»СЊРЅС‹Рµ РїСЂР°РІРєРё СЃРІРѕРґСЏС‚СЃСЏ Рє:

РќР°СЃС‚СЂРѕР№РєРµ СЂР°Р·РґР°С‡Рё СЃС‚Р°С‚РёС‡РµСЃРєРѕРіРѕ С„СЂРѕРЅС‚РµРЅРґР° РІ FastAPI (РєРѕРґ СѓР¶Рµ Р±С‹Р», РјС‹ Р»РёС€СЊ Р°РґР°РїС‚РёСЂРѕРІР°Р»Рё РїРѕРґ onefile).

РЈРґР°Р»РµРЅРёСЋ Р·Р°РІРёСЃРёРјРѕСЃС‚Рё PyWebView Рё РїРµСЂРµС…РѕРґСѓ РЅР° Р·Р°РїСѓСЃРє Р±СЂР°СѓР·РµСЂР° РІ app-СЂРµР¶РёРјРµ (РїСЂР°РІРєРё РІ launcher.py).

Р”РёРЅР°РјРёС‡РµСЃРєРѕРјСѓ РІС‹Р±РѕСЂСѓ РїРѕСЂС‚Р° РІРјРµСЃС‚Рѕ Р¶РµСЃС‚РєРѕРіРѕ, С‡С‚РѕР±С‹ РёР·Р±РµР¶Р°С‚СЊ РєРѕРЅС„Р»РёРєС‚РѕРІ Рё Р»РёС€РЅРёС… РїРѕСЂС‚РѕРІ.

РќР°СЃС‚СЂРѕР№РєРµ PyInstaller РґР»СЏ РµРґРёРЅРѕРіРѕ С„Р°Р№Р»Р° Рё РІРєР»СЋС‡РµРЅРёСЏ РІСЃРµС… РЅРµРѕР±С…РѕРґРёРјС‹С… РґР°РЅРЅС‹С… (СЃС‚Р°С‚РёРє-С„Р°Р№Р»С‹, Р‘Р”, JSON).

РќРµР±РѕР»СЊС€РёРј РїСЂР°РІРєР°Рј РґР»СЏ СЂР°Р±РѕС‚С‹ СЃ С„Р°Р№Р»Р°РјРё РІ СЂРµР¶РёРјРµ frozen (РїРѕРёСЃРє _MEIPASS, РєРѕРїРёСЂРѕРІР°РЅРёРµ Р‘Р”).

РљР°Р¶РґС‹Р№ РёР· СЌС‚РёС… С€Р°РіРѕРІ СЃРѕС…СЂР°РЅСЏРµС‚ СЃСѓС‰РµСЃС‚РІСѓСЋС‰СѓСЋ Р°СЂС…РёС‚РµРєС‚СѓСЂСѓ РїСЂРёР»РѕР¶РµРЅРёСЏ: React-frontend + FastAPI-backend + SQLite + Playwright РѕР±СЉРµРґРёРЅСЏСЋС‚СЃСЏ РІ РѕРґРЅРѕРј РёСЃРїРѕР»РЅСЏРµРјРѕРј С„Р°Р№Р»Рµ, РєРѕС‚РѕСЂС‹Р№ Р·Р°РїСѓСЃРєР°РµС‚СЃСЏ Р±РµР· РІРЅРµС€РЅРёС… Р·Р°РІРёСЃРёРјРѕСЃС‚РµР№. РџРѕР»СЊР·РѕРІР°С‚РµР»СЋ РЅРµ РЅСѓР¶РЅРѕ РѕС‚РєСЂС‹РІР°С‚СЊ Р±СЂР°СѓР·РµСЂ РІСЂСѓС‡РЅСѓСЋ, РЅРµ РЅСѓР¶РЅРѕ Р·Р°РїСѓСЃРєР°С‚СЊ РѕС‚РґРµР»СЊРЅС‹Рµ СЃРµСЂРІРёСЃС‹ вЂ“ РґРѕСЃС‚Р°С‚РѕС‡РЅРѕ РґРІРѕР№РЅРѕРіРѕ РєР»РёРєР° РїРѕ .exe. РџСЂРёР»РѕР¶РµРЅРёРµ Р±С‹СЃС‚СЂРѕ СЃС‚Р°СЂС‚СѓРµС‚ (РїРѕСЏРІР»СЏРµС‚СЃСЏ РѕРєРЅРѕ СЃСЂР°Р·Сѓ, UI Р·Р°РіСЂСѓР¶Р°РµС‚СЃСЏ Р·Р° РґРѕР»Рё СЃРµРєСѓРЅРґС‹ РёР· Р»РѕРєР°Р»СЊРЅС‹С… СЂРµСЃСѓСЂСЃРѕРІ) Рё СЃС‚Р°Р±РёР»СЊРЅРѕ СЂР°Р±РѕС‚Р°РµС‚ РѕС„Р»Р°Р№РЅ. Р’СЃРµ С‚СЂРµР±РѕРІР°РЅРёСЏ РІС‹РїРѕР»РЅРµРЅС‹: РЅРё Electron, РЅРё Eel, РЅРё PyWebView Р±РѕР»СЊС€Рµ РЅРµ РёСЃРїРѕР»СЊР·СѓСЋС‚СЃСЏ, Р° РѕСЂРёРіРёРЅР°Р»СЊРЅС‹Р№ UI/UX KeySet-MVP РїРѕР»РЅРѕСЃС‚СЊСЋ СЃРѕС…СЂР°РЅС‘РЅ.

GPT РґР°Р» РџР РђР’РР›Р¬РќРћР• Р Р•РЁР•РќРР•, РЅРѕ РїРµСЂРµСѓСЃР»РѕР¶РЅРёР» РѕР±СЉСЏСЃРЅРµРЅРёРµ. Р’РѕС‚ С‡С‚Рѕ СЂРµР°Р»СЊРЅРѕ РЅСѓР¶РЅРѕ СЃРґРµР»Р°С‚СЊ:
РЎСѓС‚СЊ СЂРµС€РµРЅРёСЏ GPT (Р±РµР· РІРѕРґС‹):
1. РЎРѕР±СЂР°С‚СЊ React РІ СЃС‚Р°С‚РёРєСѓ Рё РІСЃС‚СЂРѕРёС‚СЊ РІ FastAPI
bashDownloadCopy codecd frontend
npm run build
# РЎРѕР·РґР°СЃС‚СЃСЏ frontend/dist СЃ index.html Рё assets/
2. FastAPI СЂР°Р·РґР°РµС‚ СЌС‚Сѓ СЃС‚Р°С‚РёРєСѓ (Сѓ С‚РµР±СЏ РЈР–Р• РµСЃС‚СЊ РІ main.py):
pythonDownloadCopy code# backend/main.py - РЈР–Р• Р•РЎРўР¬
if (BASE_DIR.parent / "frontend" / "dist").exists():
    app.mount("/", StaticFiles(directory="frontend/dist", html=True), name="frontend")
3. РќРѕРІС‹Р№ launcher.py Р‘Р•Р— PyWebView:
pythonDownloadCopy codeimport socket
import subprocess
import threading
import time
import sys

# РќР°С…РѕРґРёРј СЃРІРѕР±РѕРґРЅС‹Р№ РїРѕСЂС‚
with socket.socket() as s:
    s.bind(("127.0.0.1", 0))
    PORT = s.getsockname()[1]

# Р—Р°РїСѓСЃРєР°РµРј backend
def start_backend():
    import uvicorn
    uvicorn.run("backend.main:app", host="127.0.0.1", port=PORT)

threading.Thread(target=start_backend, daemon=True).start()
time.sleep(1)

# РћС‚РєСЂС‹РІР°РµРј РІ СЂРµР¶РёРјРµ РїСЂРёР»РѕР¶РµРЅРёСЏ Edge
proc = subprocess.Popen([
    "msedge", 
    f"--app=http://127.0.0.1:{PORT}",
    "--user-data-dir=%TEMP%\\KeySet"
])
proc.wait()
4. РЎР±РѕСЂРєР° РІ РѕРґРёРЅ EXE:
pythonDownloadCopy code# keyset.spec
a = Analysis(
    ['launcher.py'],
    datas=[
        ('frontend/dist', 'frontend/dist'),  # React Р±РёР»Рґ
        ('backend', 'backend'),               # Python РєРѕРґ
        ('keyset.db', '.'),                   # Р‘Р°Р·Р°
    ],
    hiddenimports=['uvicorn', 'fastapi', 'playwright']
)

exe = EXE(a.pure, a.scripts, name='KeySet', console=False)
bashDownloadCopy codepyinstaller --onefile keyset.spec
Р§С‚Рѕ РїРѕР»СѓС‡Р°РµС€СЊ:

* вњ… РћРґРёРЅ KeySet.exe (~100MB РІРјРµСЃС‚Рѕ 300MB Electron)
* вњ… Р—Р°РїСѓСЃРє < 1 СЃРµРє (Edge СѓР¶Рµ СѓСЃС‚Р°РЅРѕРІР»РµРЅ РІ Windows)
* вњ… React UI Р±РµР· РёР·РјРµРЅРµРЅРёР№ (100% С‚РІРѕР№ РґРёР·Р°Р№РЅ)
* вњ… РќРёРєР°РєРёС… PyWebView/Eel

Р—Р° 2-3 С‡Р°СЃР° РґРµР»Р°РµС‚СЃСЏ С‚Р°Рє:
РЁР°Рі 1: РџСЂРѕРІРµСЂСЊ С‡С‚Рѕ React СЃРѕР±РёСЂР°РµС‚СЃСЏ
bashDownloadCopy codecd frontend
npm run build
# Р”РѕР»Р¶РЅР° РїРѕСЏРІРёС‚СЊСЃСЏ РїР°РїРєР° dist/
РЁР°Рі 2: РЎРѕР·РґР°Р№ РЅРѕРІС‹Р№ launcher.py
РЎРєРѕРїРёСЂСѓР№ РєРѕРґ РІС‹С€Рµ (20 СЃС‚СЂРѕРє) РІРјРµСЃС‚Рѕ С‚РІРѕРµРіРѕ СЃ PyWebView.
РЁР°Рі 3: РџСЂРѕС‚РµСЃС‚РёСЂСѓР№
bashDownloadCopy codepython launcher.py
# Р”РѕР»Р¶РЅРѕ РѕС‚РєСЂС‹С‚СЊСЃСЏ РѕРєРЅРѕ Edge СЃ С‚РІРѕРёРј РїСЂРёР»РѕР¶РµРЅРёРµРј
РЁР°Рі 4: РЎРѕР±РµСЂРё EXE
bashDownloadCopy codepip install pyinstaller
pyinstaller --onefile keyset.spec
Р•РґРёРЅСЃС‚РІРµРЅРЅР°СЏ РїСЂРѕР±Р»РµРјР° GPT РЅРµ СѓРїРѕРјСЏРЅСѓР»:
Р‘Р°Р·Р° РґР°РЅРЅС‹С… - РµСЃР»Рё РІРєР»СЋС‡РёС‚СЊ keyset.db РІ EXE, РїСЂРё РєР°Р¶РґРѕРј Р·Р°РїСѓСЃРєРµ РѕРЅР° Р±СѓРґРµС‚ РїРµСЂРµР·Р°РїРёСЃС‹РІР°С‚СЊСЃСЏ. Р РµС€РµРЅРёРµ:
pythonDownloadCopy code# Р’ backend/db.py РґРѕР±Р°РІСЊ:
import sys, shutil
if getattr(sys, 'frozen', False):  # Р•СЃР»Рё Р·Р°РїСѓС‰РµРЅРѕ РёР· EXE
    bundled_db = Path(sys._MEIPASS) / "keyset.db"
    external_db = Path.home() / "AppData/Local/KeySet/ke