РѕРЅ РјРЅРµ СѓР¶Рµ СЃРґРµР»Р°Р» СЃР±РѕСЂРєСѓ, РјРЅРµ РЅСѓР¶РЅРѕ С‡С‚РѕР±С‹ Сѓ РјРµРЅСЏ Р±С‹Р»Рѕ СЃСЂР°Р·Сѓ РІ СЃРѕС„С‚Рµ, С‡С‚РѕР±С‹ СЏ РЅРµ РїР°СЂРёР»СЃСЏ РїРѕС‚РѕРј СЃ РїРѕРґРєР»СЋС‡РµРЅРёРµРј. РЈ РјРµРЅСЏ РЅРµ РїРѕРґРіСЂСѓР¶Р°СЋС‚СЃСЏ РґР°РЅРЅС‹Рµ Рё Р°РєРєР°СѓРЅС‚С‹ Рё С‡РµС‚Рѕ С‚Р°Рј РґРѕС„РёРіР° РµС‰Рµ РїРѕС…РѕР¶Рµ, РЅРѕ РїСЂРёР»РѕР¶РµРЅРёРµ Р·Р°РїСѓСЃРєР°РµС‚СЃСЏ - РІРѕС‚ СЃРєСЂРёРЅ. РћР±СЏР·Р°С‚РµР»СЊРЅРѕ PySide6 Qt WebEngine РµСЃР»Рё РѕРЅ СѓР¶Рµ СЃРѕР±СЂР°Р» СЃРѕС„С‚, РјРѕР¶РµС‚ РѕР±РѕР№РґРµРјСЃСЏ Р±РµР· РІСЃСЏРєРѕР№ РґРѕРї РґРёС‡Рё РєРѕС‚РѕСЂР°СЏ СѓСЃР»РѕР¶РЅР°СЏРµС‚ Р»РѕРіРёРєСѓ Рё Р»РѕРјР°РµС‚ РІСЃРµ - РѕРЅ С‚Р°Рє РЅР° СЂР°Р·РЅС‹С… РѕСЃ РЅРµ Р·Р°РїСѓСЃС‚РёС‚СЃСЏ?

РџСЂРёРЅСЏР». Р‘РµР· Р»РёС€РЅРµР№ С‚РµРѕСЂРёРё вЂ” С‡РёРЅРёС‚СЊ В«Failed to fetchВ» Рё РїСѓСЃС‚С‹Рµ РІРєР»Р°РґРєРё С‚Р°Рє, С‡С‚РѕР±С‹ .exe В«РєР°Рє СЃРѕС„С‚В» СЃС‚Р°СЂС‚РѕРІР°Р» Р·Р° СЃРµРєСѓРЅРґСѓ Рё РІСЃС‘ СЃРІСЏР·Р°Р»РѕСЃСЊ.

 РїРёС€Рё РїРѕ СЂСѓСЃСЃРєРё, РЅСѓ Сѓ РЅР°СЃ Р¶Рµ С„Р°Р№Р»С‹ РЅР°С…РѕРґСЏС‚СЃСЏ РІ СЌС‚РѕР№ РїР°РїРєРµ C:\AI\yandex\KeySet-MVP, РґРµР»Р°Р№ Р·РґРµСЃСЊ СЃР±РѕСЂРєСѓ Р±РµР· РІСЃСЏРєРёС… 
РїРµСЂРµРґРµР»РѕРє РЅР° РґСЂСѓРіРёРµ РґРёСЂРµРєС‚РѕСЂРёРё. РџСЂРѕСЃС‚Рѕ Р·РґРµСЃСЊ Сѓ РјРµРЅСЏ СЃС‚Р°СЂС‹Р№ СЃРѕС„С‚ РЅР° РїРёС‚РѕРЅРµ СЃРѕ РІСЃРµРјРё СЂР°Р±РѕС‡РёРјРё РїР°СЂСЃРµСЂР°РјРё 
C:\AI\yandex\KeySet-MVP\keyset, РјРЅРµ РЅСѓР¶РЅРѕ С‡С‚РѕР±С‹ С‚С‹ РІРµСЃСЊ СЂР°Р±РѕС‡РёР№ СЃРѕС„С‚ РґРµР»Р°Р» Р·РґРµСЃСЊ C:\AI\yandex\KeySet-MVP. РќРµ РѕР±СЏР·Р°С‚РµР»СЊРЅРѕ    
 СЃСЂР°Р·Сѓ РґРµР»Р°С‚СЊ СЃР±РѕСЂРєСѓ - СЃР±РѕСЂРєР° СЌС‚Рѕ РїРѕРґРіРѕС‚РѕРІРєР° РІСЃРµРіРѕ СЂР°Р±РѕС‡РµРіРѕ РёРЅСЃС‚СЂСѓРјРµРЅС‚Р°Р»Р°, РїРѕС‚РѕРј СѓР¶Рµ Р±СѓРґРµРј РґРµР»Р°С‚СЊ РµРєСЃРµ С„Р°Р№Р»С‹ Рё РїСЂРѕС‡РµРµ,      
РєРѕРіРґР° СЃРѕС„С‚ Р±СѓРґРµС‚ РїРѕР»РЅРѕСЃС‚СЊСЋ СЂР°Р±РѕС‡РёРј. 
РЎРѕС„С‚ РґРѕР»Р¶РµРЅ РЅР°С…РѕРґРёС‚СЊСЃСЏ РІ 1 РјРµСЃС‚Рµ, С‚С‹ РµРіРѕ СѓР¶Рµ      
  СЃРґРµР»Р°Р» С‡Р°СЃС‚РёС‡РЅРѕ, РѕРЅ СѓР¶Рµ Р·Р°РїСѓСЃРєР°РµС‚СЃСЏ РѕС‚ СЃСЋРґР° C:\AI\yandex\KeySet-MVP\dist. РЎРµР№С‡Р°СЃ С‚РІРѕСЏ Р·Р°РґР°С‡Р° СЃРѕР±СЂР°С‚СЊ РІСЃРµ РІРјРµСЃС‚Рµ Рё РІСЃРµ     
  РїРѕРґРєР»СЋС‡РёС‚СЊ. Р’РєР»Р°РґРєР° Р°РєРєР°СѓРЅС‚С‹ Рё РґР°РЅРЅС‹Рµ РЅРµ РіСЂСѓР·СЏС‚СЃСЏ, РёС… РЅСѓР¶РЅРѕ РїРѕРґРєР»СЋС‡РёС‚СЊ Рё СЃРІСЏР·Р°С‚СЊ С„СѓРЅРєС†РёРѕРЅР°Р» С‡С‚РѕР±С‹ РІСЃРµ СЂР°Р±РѕС‚Р°Р»Рѕ, СЌС‚Рѕ С‚РѕР¶Рµ  
  РІСЃРµ Сѓ РЅР°СЃ РµСЃС‚СЊ, РїРѕС‡С‚Рё РІСЃРµ РіРѕС‚РѕРІС‹Рµ РјРѕРґСѓР»Рё, РґР°РЅРЅС‹Рµ, РїСЂРѕС„РёР»Рё Рё.С‚.Рґ - С‚РІРѕСЏ Р·Р°РґР°С‡Р° СЌС‚Рѕ РІСЃРµ СЃРІСЏР·Р°С‚СЊ , РЅРµ СѓРґР°Р»СЏСЏ Рё РЅРµ Р»РѕРјР°СЏ С‚Рѕ    
  С‡С‚Рѕ СѓР¶Рµ СЂР°Р±РѕС‚Р°РµС‚, РЅРµРЅР°РґРѕ РІСЂРµРјСЏ С‚СЂР°С‚РёС‚СЊ РЅР° РїРµСЂРµСЃР±РѕСЂРєСѓ СЂР°Р±РѕС‡РµРіРѕ СЃРѕС„С‚Р°, РїРѕСЃС‚Р°СЂР°Р№СЃСЏ С‚СЂР°С‚РёС‚СЊ РјРµРЅСЊС€Рµ С‚РѕРєРµРЅРѕРІ. 




Р’ С‚РІРѕРµР№ СЃР±РѕСЂРєРµ UI РѕС‚РєСЂС‹РІР°РµС‚СЃСЏ, РЅРѕ С„СЂРѕРЅС‚ РЅРµ РІРёРґРёС‚ API Рё Р‘Р”. РўРёРїРёС‡РЅС‹Рµ РїСЂРёС‡РёРЅС‹ (Рё РѕРЅРё РєР°Рє СЂР°Р· РґР°СЋС‚ В«Failed to fetchВ»):

UI РѕС‚РєСЂС‹С‚ РЅРµ СЃ С‚РѕРіРѕ Р¶Рµ origin, С‡С‚Рѕ API (РґСЂСѓРіРѕР№ РїРѕСЂС‚/URL) в†’ /api/* СѓС…РѕРґРёС‚ РІ РЅРёРєСѓРґР°.

SPA РЅРµ СЃРјРѕРЅС‚РёСЂРѕРІР°РЅР° С‡РµСЂРµР· FastAPI (РЅРµС‚ СЂР°Р·РґР°С‡Рё frontend/dist РёР· Р±СЌРєР°) в†’ UI/API Р¶РёРІСѓС‚ РЅР° СЂР°Р·РЅС‹С… РёСЃС‚РѕС‡РЅРёРєР°С….

Р‘Р°Р·Р° РЅРµ РІС‹РЅРµСЃРµРЅР° РЅР°СЂСѓР¶Сѓ Рё/РёР»Рё РЅРµ СЃРєРѕРїРёСЂРѕРІР°РЅР° РЅР° РїРµСЂРІС‹Р№ Р·Р°РїСѓСЃРє в†’ РїСЂРё РґРѕСЃС‚СѓРїРµ Рє С‚Р°Р±Р»РёС†Р°Рј РІР°Р»РёС‚СЃСЏ 500, С„СЂРѕРЅС‚ РїРѕРєР°Р·С‹РІР°РµС‚ В«Failed to fetchВ».

Р’ С„СЂРѕРЅС‚Рµ Р¶С‘СЃС‚РєРѕ РїСЂРѕРїРёСЃР°РЅ baseURL (РЅР°РїСЂРёРјРµСЂ, http://127.0.0.1:5173/8765) в†’ РїСЂРё РґСЂСѓРіРѕРј РїРѕСЂС‚Рµ СЃСЂР°Р·Сѓ СЃРµС‚РµРІС‹Рµ РѕС€РёР±РєРё.

РќРё PySide/CEF/WebView2 С‚СѓС‚ РЅРµ РЅСѓР¶РЅС‹. Р›РµС‡РёРј СЃРІСЏР·РєСѓ.

РџР»Р°РЅ С„РёРєСЃР° (РјРёРЅРёРјСѓРј РїСЂР°РІРѕРє, Р±С‹СЃС‚СЂРѕ)
РЁР°Рі 1 вЂ” РћРґРёРЅ РїРѕСЂС‚ Рё РѕРґРёРЅ origin

Р¤РёРєСЃРёСЂСѓРµРј РїРѕСЂС‚, С‡С‚РѕР±С‹ С„СЂРѕРЅС‚ Рё Р±СЌРє РІСЃРµРіРґР° Р±С‹Р»Рё РІРјРµСЃС‚Рµ:

РІ Р»Р°СѓРЅС‡РµСЂРµ Р·Р°РїСѓСЃРєР°РµРј Uvicorn РЅР° 127.0.0.1:8765;

РѕРєРЅРѕ Edge РѕС‚РєСЂС‹РІР°РµРј СЃС‚СЂРѕРіРѕ РЅР° http://127.0.0.1:8765 (Р° РЅРµ РЅР° 5173/dev Рё РЅРµ РЅР° СЃР»СѓС‡Р°Р№РЅС‹Р№ РїРѕСЂС‚).

# launcher.py (РєСѓСЃРѕРє)
import subprocess, sys, time, os

PORT = "8765"

# РїРѕРґРЅРёРјР°РµРј Р±РµРєРµРЅРґ РєР°Рє РјРѕРґСѓР»СЊ uvicorn СЃ РЅР°С€РёРј РїСЂРёР»РѕР¶РµРЅРёРµРј
backend = subprocess.Popen([
    sys.executable, "-m", "uvicorn",
    "backend.main:app",
    "--host", "127.0.0.1",
    "--port", PORT,
    "--log-level", "info"
], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)

# РєРѕСЂРѕС‚РєР°СЏ РїР°СѓР·Р°, РјРѕР¶РЅРѕ Р·Р°РјРµРЅРёС‚СЊ РЅР° health-check
time.sleep(1.5)

# РѕС‚РєСЂС‹РІР°РµРј Edge РІ app-СЂРµР¶РёРјРµ РЅР° С‚РѕРј Р¶Рµ origin
subprocess.Popen([
    "msedge", f"--app=http://127.0.0.1:{PORT}",
    r"--user-data-dir=%TEMP%\KeySet",
    "--disable-extensions", "--disable-plugins"
])

РЁР°Рі 2 вЂ” Р Р°Р·РґР°С‘Рј React РєР°Рє SPA РёР· FastAPI

Р§С‚РѕР±С‹ РІСЃРµРіРґР° Р±С‹Р» РѕРґРёРЅ origin, РјРѕРЅС‚РёСЂСѓРµРј frontend/dist РІ РєРѕСЂРµРЅСЊ:

# backend/main.py (РІР°Р¶РЅРѕ СЂР°СЃРїРѕР»РѕР¶РёС‚СЊ РїРѕСЃР»Рµ include_router)
import os, sys
from pathlib import Path
from fastapi.staticfiles import StaticFiles

def _dist_dir() -> str:
    # РґР»СЏ РѕР±С‹С‡РЅРѕРіРѕ Р·Р°РїСѓСЃРєР° Рё РґР»СЏ PyInstaller (sys._MEIPASS)
    base = Path(getattr(sys, "_MEIPASS", Path(__file__).resolve().parents[2]))
    # РµСЃР»Рё dist Р»РµР¶РёС‚ СЂСЏРґРѕРј СЃ backend/, РїРѕРїСЂР°РІСЊ РїСѓС‚СЊ РїРѕРґ СЃРІРѕР№ РїСЂРѕРµРєС‚
    dist = base / "frontend" / "dist"
    return str(dist)

app.mount("/", StaticFiles(directory=_dist_dir(), html=True), name="static")


РўРµРїРµСЂСЊ UI Рё /api вЂ” РѕРґРёРЅ Рё С‚РѕС‚ Р¶Рµ http://127.0.0.1:8765. РќРёРєР°РєРёС… CORS Рё В«Failed to fetchВ» РёР·-Р·Р° РґСЂСѓРіРѕРіРѕ РїРѕСЂС‚Р°.

РЁР°Рі 3 вЂ” Р’С‹РЅРµСЃС‚Рё Р‘Р” РЅР°СЂСѓР¶Сѓ (С‡С‚РѕР±С‹ РЅРµ РїРµСЂРµСЃРѕР±РёСЂР°С‚СЊ .exe РёР·-Р·Р° Р±Р°Р·С‹)

РџСЂРё РїРµСЂРІРѕРј Р·Р°РїСѓСЃРєРµ РєРѕРїРёСЂСѓРµРј С€Р°Р±Р»РѕРЅ Р‘Р” РёР· СЂРµСЃСѓСЂСЃРѕРІ РІ %USERPROFILE%\.keyset\keyset.db Рё РІСЃРµРіРґР° СЂР°Р±РѕС‚Р°РµРј СЃ СЌС‚РёРј С„Р°Р№Р»РѕРј:

# keyset/core/db_path.py (РЅРѕРІС‹Р№ РјР°Р»РµРЅСЊРєРёР№ РјРѕРґСѓР»СЊ)
import os, sys, shutil
from pathlib import Path

APP_DIR = Path(os.environ.get("KEYSET_HOME", Path.home() / ".keyset"))
APP_DIR.mkdir(parents=True, exist_ok=True)
DB_PATH = APP_DIR / "keyset.db"

def _bundled_db() -> Path:
    base = Path(getattr(sys, "_MEIPASS", Path(__file__).resolve().parents[2]))
    # РїРѕРїСЂР°РІСЊ РїСѓС‚СЊ, РіРґРµ Р»РµР¶РёС‚ С€Р°Р±Р»РѕРЅ Р‘Р” РІ С‚РІРѕС‘Рј РїСЂРѕРµРєС‚Рµ/СЃРїРµРєРµ
    return base / "keyset" / "data" / "keyset.db"

if not DB_PATH.exists():
    src = _bundled_db()
    if src.exists():
        shutil.copy2(src, DB_PATH)

SQLALCHEMY_URL = f"sqlite:///{DB_PATH}"


Р РІ РёРЅРёС†РёР°Р»РёР·Р°С†РёРё РґРІРёР¶РєР°:

# keyset/core/db.py
from .db_path import SQLALCHEMY_URL
engine = create_engine(SQLALCHEMY_URL, connect_args={"check_same_thread": False})


РўР°Рє С‚С‹ РЅРёРєРѕРіРґР° РЅРµ РїРµСЂРµСЃРѕР±РёСЂР°РµС€СЊ РёР·-Р·Р° СЃРѕРґРµСЂР¶РёРјРѕРіРѕ Р‘Р”: РЅР°РґРѕ Р·Р°РјРµРЅРёС‚СЊ Р‘Р” вЂ” РїСЂРѕСЃС‚Рѕ РїРѕР»РѕР¶Рё РЅРѕРІС‹Р№ С„Р°Р№Р» РІ %USERPROFILE%\.keyset\keyset.db.

РЁР°Рі 4 вЂ” Р¤СЂРѕРЅС‚РµРЅРґ: Р±РµР· С…Р°СЂРґРєРѕРґР° baseURL

РџСЂРѕРІРµСЂСЊ РєР»РёРµРЅС‚ API. Р”РѕР»Р¶РЅРѕ Р±С‹С‚СЊ РѕС‚РЅРѕСЃРёС‚РµР»СЊРЅРѕРµ:

// src/shared/api.ts (РёР»Рё РіРґРµ Сѓ С‚РµР±СЏ fetch/axios)
const api = axios.create({ baseURL: "/api" }); // РЅРµ http://127.0.0.1:РїРѕСЂС‚


Р•СЃР»Рё РіРґРµ-С‚Рѕ РѕСЃС‚Р°Р»СЃСЏ С…Р°СЂРґРєРѕРґ http://localhost:5173 РёР»Рё 8765 вЂ” СѓР±РµСЂРё. РўРѕРіРґР° РїСЂРё Р»СЋР±РѕРј СЃРїРѕСЃРѕР±Рµ Р·Р°РїСѓСЃРєР° РІСЃС‘ В«РїСЂРёР»РёРїРЅРµС‚В» Рє С‚РµРєСѓС‰РµРјСѓ origin.

РЁР°Рі 5 вЂ” PyInstaller: РїРѕР»РѕР¶РёС‚СЊ СЃС‚Р°С‚РёРєСѓ Рё С€Р°Р±Р»РѕРЅ Р‘Р”

Р’ .spec РґРѕР»Р¶РЅС‹ Р±С‹С‚СЊ datas РґР»СЏ frontend/dist Рё РґР»СЏ С€Р°Р±Р»РѕРЅР° Р‘Р”/JSON:

a = Analysis(
    ['launcher.py'],
    datas=[
        ('frontend/dist', 'frontend/dist'),                 # React СЃС‚Р°С‚РёРєР°
        ('keyset/data/keyset.db', 'keyset/data'),           # С€Р°Р±Р»РѕРЅ Р‘Р”
        ('keyset/data/regions_tree_full.json', 'keyset/data')
    ],
    hiddenimports=['uvicorn', 'fastapi', ...],
    ...
)

Р‘С‹СЃС‚СЂС‹Р№ СЃР°РјРѕС‚РµСЃС‚ (3 С€Р°РіР°)

Р—Р°РїСѓСЃС‚Рё KeySet.exe.

Р’ Р°РґСЂРµСЃРЅРѕР№ СЃС‚СЂРѕРєРµ РѕРєРЅР° РЅР°Р±РµСЂРё http://127.0.0.1:8765/api/health вЂ” РґРѕР»Р¶РµРЅ РІРµСЂРЅСѓС‚СЊ 200 OK.

РћС‚РєСЂРѕР№ http://127.0.0.1:8765/api/accounts вЂ” РµСЃР»Рё РїСѓСЃС‚Рѕ, РїСЂРёРґС‘С‚ []; РµСЃР»Рё РѕС€РёР±РєР° вЂ” СѓРІРёРґРёС€СЊ РєРѕРґ/С‚РµРєСЃС‚ (Р·РЅР°С‡РёС‚ РµС‰С‘ Р‘Р”/РјРѕРґРµР»Рё).

Р•СЃР»Рё health РЅРµ РѕС‚РІРµС‡Р°РµС‚ вЂ” Р»Р°СѓРЅС‡РµСЂ РЅРµ РѕС‚РєСЂС‹Р» С‚РѕС‚ Р¶Рµ РїРѕСЂС‚, С‡РёРЅРёС‚СЊ РЁР°Рі 1.
Р•СЃР»Рё health РѕРє, Р° /api/accounts 500 вЂ” СЃРјРѕС‚СЂРё Р»РѕРі Р±СЌРєР° (С‡Р°С‰Рµ РІСЃРµРіРѕ Р‘Р” РЅРµ СЃРєРѕРїРёСЂРѕРІР°Р»Р°СЃСЊ/РїСѓС‚СЊ). РџРѕСЃР»Рµ РЁР°РіР° 3 СЌС‚Рѕ СѓР№РґС‘С‚.

РћС‚РІРµС‚С‹ РЅР° С‚РІРѕРё РІРѕРїСЂРѕСЃС‹ (РєРѕСЂРѕС‚РєРѕ)

РЎР±РѕСЂРєР° СЂР°РґРё Р‘Р”? РќРµС‚, РµСЃР»Рё Р‘Р” РІС‹РЅРµСЃРµРЅР° РЅР°СЂСѓР¶Сѓ (РєР°Рє РІС‹С€Рµ).

WebView2/РїРѕРґРїРёСЃСЊ/PySide6? РЈР±СЂР°Р»Рё вЂ” Рё РїСЂР°РІРёР»СЊРЅРѕ. Р”Р»СЏ Р·Р°РїСѓСЃРєР°/СЃРІСЏР·РєРё РЅРµ РЅСѓР¶РЅС‹.

РљСЂРѕСЃСЃРїР»Р°С‚С„РѕСЂРјРµРЅРЅРѕСЃС‚СЊ? РЎРµР№С‡Р°СЃ С†РµР»РёРјСЃСЏ РІ Win Рё Р±С‹СЃС‚СЂС‹Р№ Р·Р°РїСѓСЃРє. РџРѕРґ РґСЂСѓРіРёРµ РћРЎ вЂ” РѕС‚РґРµР»СЊРЅРѕ, РЅРѕ Р»РѕРіРёРєР° РѕСЃС‚Р°РЅРµС‚СЃСЏ С‚Р° Р¶Рµ (РѕРґРёРЅ origin + SPA РёР· FastAPI).

РҐРѕС‡РµС€СЊ вЂ” РґР°Рј РіРѕС‚РѕРІС‹Рµ РїР°С‚С‡Рё (РґРёС„С„С‹) РїРѕРґ С‚РІРѕРё С„Р°Р№Р»С‹ backend/main.py, keyset/core/db.py, launcher.py Рё РєСѓСЃРѕРє spec, С‡С‚РѕР±С‹ С‚С‹ РїСЂРѕСЃС‚Рѕ РІСЃС‚Р°РІРёР» Рё РїРµСЂРµСЃРѕР±СЂР°Р». Р­С‚Рѕ РєР°Рє СЂР°Р· 10вЂ“15 РјРёРЅСѓС‚ РїСЂР°РІРѕРє Рё СЃР±РѕСЂРєР°.

РѕРє, РґРµР»Р°РµРј В«РїРѕСЂС‚Р°С‚РёРІРЅС‹Р№В» KeySet: РѕРґРёРЅ РєР°С‚Р°Р»РѕРі СЃ .exe Рё РІСЃРµР№ РЅСѓР¶РЅРѕР№ РЅР°С‡РёРЅРєРѕР№ (Р‘Р”, РїСЂРѕС„РёР»Рё, РїР°СЂСЃРµСЂ, СЂРµРіРёРѕРЅС‹, Playwright-Р±СЂР°СѓР·РµСЂ), С‡С‚РѕР±С‹ РїРѕСЃР»Рµ СЃР±РѕСЂРєРё РјРѕР¶РЅРѕ Р±С‹Р»Рѕ РїРѕС‡РёСЃС‚РёС‚СЊ РјР°С€РёРЅСѓ Рё Р·Р°РїСѓСЃРєР°С‚СЊ РёР· РѕРґРЅРѕР№ РїР°РїРєРё.

РЅРёР¶Рµ вЂ” РіРѕС‚РѕРІС‹Р№ РїР»Р°РЅ + РІСЃС‚Р°РІРєРё РєРѕРґР°/СЃРїРµРєР°. Р±РµСЂРё Рё РІСЃС‚Р°РІР»СЏР№.

TL;DR

UI Рё API РЅР° РѕРґРЅРѕРј origin: FastAPI СЂР°Р·РґР°С‘С‚ frontend/dist (SPA) Рё СЃР»СѓС€Р°РµС‚ 127.0.0.1:8765.

РћРґРЅР° РїР°РїРєР° runtime/ СЂСЏРґРѕРј СЃ exe: С‚СѓС‚ Р»РµР¶Р°С‚ db/, profiles/, browsers/ (Chromium РґР»СЏ Playwright), geo/, config/, logs/.

Р‘Р” Рё РїСЂРѕС‡РµРµ РєРѕРїРёСЂСѓСЋС‚СЃСЏ РЅР° РїРµСЂРІС‹Р№ Р·Р°РїСѓСЃРє РёР· СЂРµСЃСѓСЂСЃРѕРІ exe РІ runtime/.

Playwright Р±СЂР°СѓР·РµСЂ РєР»Р°РґС‘Рј РІРЅСѓС‚СЂСЊ РїСЂРѕРµРєС‚Р° (Р±РµР· РІРЅРµС€РЅРёС… РєСЌС€РµР№).

PyInstaller СѓРїР°РєРѕРІС‹РІР°РµС‚ РІСЃС‘; РїРѕСЃР»Рµ СЃР±РѕСЂРєРё РјРѕР¶РЅРѕ СѓРґР°Р»СЏС‚СЊ venv, node_modules, РіР»РѕР±Р°Р»СЊРЅС‹Рµ РєСЌС€Рё Playwright.

1) Р¦РµР»РµРІР°СЏ СЃС‚СЂСѓРєС‚СѓСЂР° (РїРѕСЃР»Рµ СЃР±РѕСЂРєРё)
KeySet/
в”њв”Ђ KeySet.exe
в”њв”Ђ runtime/
в”‚  в”њв”Ђ db/                  # СЂР°Р±РѕС‡Р°СЏ Р‘Р” (РІРЅРµС€РЅРёР№ С„Р°Р№Р»)
в”‚  в”‚   в””в”Ђ keyset.db
в”‚  в”њв”Ђ profiles/            # РїСЂРѕС„РёР»Рё Р°РєРєР°СѓРЅС‚РѕРІ (user_data_dir)
в”‚  в”њв”Ђ browsers/            # ms-playwright Chromium (РІРЅСѓС‚СЂРё РїСЂРѕРµРєС‚Р°)
в”‚  в”њв”Ђ geo/
в”‚  в”‚   в””в”Ђ regions_tree_full.json
в”‚  в”њв”Ђ config/
в”‚  в”‚   в”њв”Ђ proxies.json
в”‚  в”‚   в””в”Ђ .env
в”‚  в””в”Ђ logs/
в””в”Ђ www/                    # СЃРѕР±СЂР°РЅРЅС‹Р№ React (frontend/dist)


Р’РЅСѓС‚СЂСЊ exe С‚Р°РєР¶Рµ РєР»Р°РґС‘Рј В«С€Р°Р±Р»РѕРЅС‹В» (dist, РґРµС„РѕР»С‚РЅСѓСЋ Р‘Р”, geo). РќР° РїРµСЂРІРѕРј Р·Р°РїСѓСЃРєРµ вЂ” РєРѕРїРёСЂСѓРµРј РІ runtime/.

2) Р¦РµРЅС‚СЂР°Р»РёР·РѕРІР°РЅРЅС‹Рµ РїСѓС‚Рё (РѕРґРёРЅ РјРѕРґСѓР»СЊ)

keyset/core/app_paths.py

from __future__ import annotations
import os, sys, shutil
from pathlib import Path

def _app_root() -> Path:
    # frozen exe -> СЂСЏРґРѕРј СЃ exe, dev -> РєРѕСЂРµРЅСЊ СЂРµРїРѕ
    if getattr(sys, 'frozen', False):
        return Path(sys.executable).resolve().parent
    return Path(__file__).resolve().parents[3]  # РїРѕРґСЃС‚СЂРѕР№ РїСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё

APP_ROOT = _app_root()
RUNTIME = APP_ROOT / 'runtime'
WWW_DIR = APP_ROOT / 'www'   # РєСѓРґР° РєРѕРїРёСЂСѓРµРј dist РЅР° СЃР±РѕСЂРєРµ

# РїРѕРґРїР°РїРєРё runtime
DB_DIR      = RUNTIME / 'db'
PROFILES    = RUNTIME / 'profiles'
BROWSERS    = RUNTIME / 'browsers'  # PLAYWRIGHT_BROWSERS_PATH
GEO_DIR     = RUNTIME / 'geo'
CONFIG_DIR  = RUNTIME / 'config'
LOGS_DIR    = RUNTIME / 'logs'

def ensure_runtime():
    for p in (DB_DIR, PROFILES, BROWSERS, GEO_DIR, CONFIG_DIR, LOGS_DIR):
        p.mkdir(parents=True, exist_ok=True)

def _bundle_dir() -> Path:
    # РіРґРµ Р»РµР¶Р°С‚ В«С€Р°Р±Р»РѕРЅС‹В» РІРЅСѓС‚СЂРё exe / РїСЂРё dev-СЃР±РѕСЂРєРµ
    base = Path(getattr(sys, "_MEIPASS", APP_ROOT))
    return base

def bootstrap_files():
    """РљРѕРїРёСЂСѓРµРј РґРµС„РѕР»С‚РЅСѓСЋ Р‘Р”/geo/РєРѕРЅС„РёРіРё РёР· СЂРµСЃСѓСЂСЃРѕРІ РІ runtime РїСЂРё РїРµСЂРІРѕРј Р·Р°РїСѓСЃРєРµ"""
    ensure_runtime()
    # Р‘Р”
    bundled_db = _bundle_dir() / 'keyset' / 'data' / 'keyset.db'
    target_db  = DB_DIR / 'keyset.db'
    if bundled_db.exists() and not target_db.exists():
        shutil.copy2(bundled_db, target_db)
    # GEO
    bundled_geo = _bundle_dir() / 'keyset' / 'data' / 'regions_tree_full.json'
    target_geo  = GEO_DIR / 'regions_tree_full.json'
    if bundled_geo.exists() and not target_geo.exists():
        shutil.copy2(bundled_geo, target_geo)
    # CONFIG (РµСЃР»Рё РЅСѓР¶РЅС‹ РґРµС„РѕР»С‚С‹)
    bundled_proxies = _bundle_dir() / 'keyset' / 'data' / 'proxies.json'
    if bundled_proxies.exists() and not (CONFIG_DIR / 'proxies.json').exists():
        shutil.copy2(bundled_proxies, CONFIG_DIR / 'proxies.json')

def sqlite_url() -> str:
    return f"sqlite:///{(DB_DIR / 'keyset.db').as_posix()}"

3) РџРѕРґРєР»СЋС‡Р°РµРј РїСѓС‚Рё РІ Р‘Р” Рё СЃРµСЂРІРёСЃР°С…

keyset/core/db.py (С„СЂР°РіРјРµРЅС‚)

from sqlalchemy import create_engine
from .app_paths import bootstrap_files, sqlite_url

bootstrap_files()
engine = create_engine(sqlite_url(), connect_args={"check_same_thread": False})


Playwright/РїР°СЂСЃРµСЂ: РєР»Р°РґС‘Рј РїСЂРѕС„РёР»Рё Рё Р±СЂР°СѓР·РµСЂ РІРЅСѓС‚СЂСЊ runtime/:

import os
from keyset.core.app_paths import PROFILES, BROWSERS

# Р±СЂР°СѓР·РµСЂ РІРЅСѓС‚СЂРё РїСЂРѕРµРєС‚Р°
os.environ["PLAYWRIGHT_BROWSERS_PATH"] = str(BROWSERS)

# user_data_dir РґР»СЏ Р°РєРєР°СѓРЅС‚РѕРІ
def profile_dir(account_id: int) -> str:
    p = PROFILES / f"acc_{account_id}"
    p.mkdir(parents=True, exist_ok=True)
    return str(p)


Р’ РІС‹Р·РѕРІРµ Playwright РёСЃРїРѕР»СЊР·СѓР№ user_data_dir=profile_dir(acc.id).

4) FastAPI СЂР°Р·РґР°С‘С‚ SPA (РѕРґРёРЅ origin)

backend/main.py (С„СЂР°РіРјРµРЅС‚)

from fastapi.staticfiles import StaticFiles
from keyset.core.app_paths import WWW_DIR, bootstrap_files, ensure_runtime

ensure_runtime(); bootstrap_files()

# ...routers...
app.mount("/", StaticFiles(directory=str(WWW_DIR), html=True), name="static")


Р’ СЃР±РѕСЂРєРµ РјС‹ Р·Р°СЂР°РЅРµРµ РєРѕРїРёСЂСѓРµРј frontend/dist РІ www/. РўРѕРіРґР° РѕРєРЅРѕ Edge РѕС‚РєСЂС‹РІР°РµС‚СЃСЏ РЅР° http://127.0.0.1:8765/, Рё РІСЃРµ /api/* вЂ” С‚РѕС‚ Р¶Рµ origin (РЅРёРєР°РєРёС… CORS В«Failed to fetchВ»).

5) Р›Р°СѓРЅС‡РµСЂ (Edge РІ app-СЂРµР¶РёРјРµ, РѕРґРёРЅ РїРѕСЂС‚)

launcher.py (РјРёРЅРёРјСѓРј)

import subprocess, sys, time, os
from keyset.core.app_paths import APP_ROOT

PORT = "8765"

backend = subprocess.Popen([
    sys.executable, "-m", "uvicorn", "backend.main:app",
    "--host", "127.0.0.1", "--port", PORT, "--log-level", "warning"
], cwd=str(APP_ROOT), stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)

time.sleep(1.5)  # РјРѕР¶РЅРѕ Р·Р°РјРµРЅРёС‚СЊ РЅР° health-check

subprocess.Popen([
    "msedge", f"--app=http://127.0.0.1:{PORT}/",
    rf"--user-data-dir={APP_ROOT}\runtime\edge_profile",
    "--disable-extensions", "--disable-plugins"
], cwd=str(APP_ROOT))

6) Р“РѕС‚РѕРІРёРј Р±СЂР°СѓР·РµСЂ Playwright РІРЅСѓС‚СЂСЊ РїСЂРѕРµРєС‚Р°

РџРµСЂРµРґ СЃР±РѕСЂРєРѕР№ РµРґРёРЅРѕР¶РґС‹ РїРѕСЃС‚Р°РІСЊ Chromium РІ runtime/browsers:

REM РёР· РєРѕСЂРЅСЏ РїСЂРѕРµРєС‚Р°
set PLAYWRIGHT_BROWSERS_PATH=runtime\browsers
py -m pip install playwright
py -m playwright install chromium


Р’ СЂРµР·СѓР»СЊС‚Р°С‚Рµ РїР°РїРєР° runtime\browsers\ СЃРѕРґРµСЂР¶РёС‚ РЅСѓР¶РЅС‹Рµ Р±РёРЅР°СЂРЅРёРєРё в†’ PyInstaller РёС… Р·Р°Р±РµСЂС‘С‚ РєР°Рє datas.

7) PyInstaller spec (РѕРґРёРЅ С„Р°Р№Р», РІСЃС‘ РІРЅСѓС‚СЂРё)

build/KeySet.spec (С„СЂР°РіРјРµРЅС‚)
(РїСѓС‚Рё РїРѕРґРєРѕСЂСЂРµРєС‚РёСЂСѓР№ РїРѕРґ СЃРІРѕР№ СЂРµРїРѕ)

# РљРѕРјР°РЅРґР°: pyinstaller -y build/KeySet.spec
block_cipher = None

a = Analysis(
    ['launcher.py'],
    pathex=['.'],
    datas=[
        ('frontend/dist', 'www'),                                 # СЃС‚Р°С‚РёРєР° SPA
        ('keyset/data/keyset.db', 'keyset/data'),                 # С€Р°Р±Р»РѕРЅ Р‘Р”
        ('keyset/data/regions_tree_full.json', 'keyset/data'),    # GEO
        ('runtime/browsers', 'runtime/browsers'),                 # Playwright Chromium
        ('keyset/data/proxies.json', 'keyset/data'),              # РґРµС„РѕР»С‚ РєРѕРЅС„РёРі (РµСЃР»Рё РµСЃС‚СЊ)
    ],
    hiddenimports=[
        'uvicorn', 'fastapi', 'jinja2', 'playwright',
        'playwright._impl._driver', 'playwright._impl._transport',
        'playwright._impl._api_structures',  # С‡С‚РѕР±С‹ РЅРµ РІС‹СЂРµР·Р°Р»Рѕ
    ],
    excludes=['numpy','pandas','matplotlib'],  # СЌРєРѕРЅРѕРјРёСЏ СЂР°Р·РјРµСЂР°
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)
exe = EXE(
    pyz, a.scripts, a.binaries, a.zipfiles, a.datas,
    name='KeySet', console=False, icon='build/icon.ico'
)
coll = COLLECT(exe, a.binaries, a.zipfiles, a.datas, name='KeySet')

8) РљРѕРїРёСЂСѓРµРј dist РІ www/ РїРµСЂРµРґ СЃР±РѕСЂРєРѕР№

РЎРєСЂРёРїС‚ В«РѕРґРЅРѕР№ РєРЅРѕРїРєРѕР№В»:

REM 1) Р±РёР»РґРёРј С„СЂРѕРЅС‚
cd frontend
npm run build
cd ..

REM 2) РєР»Р°РґС‘Рј dist РІ www
rmdir /S /Q www 2>nul
xcopy /E /I /Y frontend\dist www

REM 3) РіР°СЂР°РЅС‚РёСЂСѓРµРј Р±СЂР°СѓР·РµСЂ РІРЅСѓС‚СЂРё РїСЂРѕРµРєС‚Р°
set PLAYWRIGHT_BROWSERS_PATH=runtime\browsers
py -m playwright install chromium

REM 4) СЃРѕР±РёСЂР°РµРј exe
py -m pip install -r requirements.txt
py -m PyInstaller -y build\KeySet.spec

9) РЎР°РјРѕРїСЂРѕРІРµСЂРєР° РїРѕСЃР»Рµ СЃР±РѕСЂРєРё

Р—Р°РїСѓСЃС‚Рё KeySet\KeySet.exe.

РћС‚РєСЂРѕРµС‚СЃСЏ РѕРєРЅРѕ; РїРµСЂРµР№РґРё РЅР° http://127.0.0.1:8765/api/health вЂ” РґРѕР»Р¶РЅРѕ Р±С‹С‚СЊ 200 OK.

РЈР±РµРґРёСЃСЊ, С‡С‚Рѕ СЃРѕР·РґР°Р»РёСЃСЊ:

runtime\db\keyset.db (РµСЃР»Рё РЅРµ Р±С‹Р»Рѕ вЂ” СЃРєРѕРїРёСЂРѕРІР°Р»СЃСЏ РёР· С€Р°Р±Р»РѕРЅР°),

runtime\profiles\ (РїРѕСЃР»Рµ РїРµСЂРІРѕРіРѕ Р·Р°РїСѓСЃРєР° РїР°СЂСЃРµСЂР°),

runtime\logs\ вЂ” РµСЃС‚СЊ Р»РѕРіРё.

Р’РєР»Р°РґРєРё В«РђРєРєР°СѓРЅС‚С‹В» Рё В«Р”Р°РЅРЅС‹РµВ» вЂ” Р±РµР· В«Failed to fetchВ». Р•СЃР»Рё РїСѓСЃС‚Рѕ вЂ” СЌС‚Рѕ РЅРµ СЃРµС‚СЊ, Р° РїСЂРѕСЃС‚Рѕ РїСѓСЃС‚Р°СЏ Р‘Р” (РЅРѕСЂРјР°Р»СЊРЅРѕ).

10) Р§С‚Рѕ РјРѕР¶РЅРѕ СЃРјРµР»Рѕ СѓРґР°Р»РёС‚СЊ РїРѕСЃР»Рµ СЃР±РѕСЂРєРё (СЌРєРѕРЅРѕРјРёРј РјРµСЃС‚Рѕ)

node_modules/, .vite/, frontend/dist/ (РµСЃР»Рё www/ СѓР¶Рµ СЃРѕР·РґР°РЅ Рё РїРѕРїР°Р» РІ exe);

РІРёСЂС‚СѓР°Р»СЊРЅРѕРµ РѕРєСЂСѓР¶РµРЅРёРµ .venv/ (РµСЃР»Рё СЃС‚Р°РІРёС‚СЊ РЅРµ РїР»Р°РЅРёСЂСѓРµС€СЊ);

РіР»РѕР±Р°Р»СЊРЅС‹Р№ РєСЌС€ Playwright: %LOCALAPPDATA%\ms-playwright\ (РјС‹ РґРµСЂР¶РёРј Р±СЂР°СѓР·РµСЂ РІ runtime/browsers/);

build/, dist/ РѕС‚ PyInstaller, РєСЂРѕРјРµ С„РёРЅР°Р»СЊРЅРѕР№ РїР°РїРєРё СЃ exe;

С‚РµСЃС‚РѕРІС‹Рµ Р°СЂС‚РµС„Р°РєС‚С‹ .pytest_cache/, __pycache__/.

РџРѕС‡РµРјСѓ СЌС‚Рѕ Р·Р°РєСЂРѕРµС‚ С‚РІРѕРё В«С…РѕС‡СѓВ»

В«РІСЃС‘ РІ РѕРґРЅРѕРј РјРµСЃС‚Рµ, РјРѕРіСѓ РїРѕС‡РёСЃС‚РёС‚СЊ РєРѕРјРїВ» вЂ” РґР°, РІРµСЃСЊ СЂР°РЅС‚Р°Р№Рј РІ KeySet/ (exe + runtime + www).

В«РЅРёС‡РµРіРѕ РЅРµ СЂР°Р·Р±СЂРѕСЃР°РЅРѕВ» вЂ” РїСЂРѕС„РёР»Рё, Р‘Р”, Р±СЂР°СѓР·РµСЂ Playwright, geo, РєРѕРЅС„РёРіРё вЂ” РІСЃРµ РІ runtime/.

В«РЅРµ Р»РѕРјР°РµРј РїР°СЂСЃРµСЂ/Р“Р•Рћ/ReactВ» вЂ” Р±РёР·РЅРµСЃ-РєРѕРґ РЅРµ РјРµРЅСЏРµРј, С‚РѕР»СЊРєРѕ РїСѓС‚Рё Рё СѓРїР°РєРѕРІРєСѓ.

В«РјРёРЅРёРјСѓРј С‚РµР»РѕРґРІРёР¶РµРЅРёР№В» вЂ” РїСЂР°РІРєРё 3 С„Р°Р№Р»РѕРІ + spec; РґР°Р»СЊС€Рµ РѕРґРЅР° РєРѕРјР°РЅРґР° СЃР±РѕСЂРєРё.

РїРѕРЅСЏР». РќРёС‡РµРіРѕ РЅРµ СѓРґР°Р»СЏРµРј. Р”РµР»Р°РµРј В«РїРѕСЂС‚Р°С‚РёРІРЅСѓСЋВ» СЃР±РѕСЂРєСѓ С‚Р°Рє, С‡С‚РѕР±С‹ РІСЃС‘ Р»РµР¶Р°Р»Рѕ РІ РѕРґРЅРѕР№ РїР°РїРєРµ СЂСЏРґРѕРј СЃ .exe Рё СЃСЂР°Р·Сѓ СЂР°Р±РѕС‚Р°Р»Рѕ: Р‘Р”, РїСЂРѕС„РёР»Рё, Р±СЂР°СѓР·РµСЂ РґР»СЏ РїР°СЂСЃРµСЂР°, GEO, РєРѕРЅС„РёРіРё, С„СЂРѕРЅС‚. Р’РѕС‚ РіРѕС‚РѕРІС‹Р№ РїР»Р°РЅ + С„Р°Р№Р»С‹. РЎРєРѕРїРёСЂСѓР№/РІСЃС‚Р°РІСЊ вЂ” Рё Р·Р°РїСѓСЃРєР°Р№.

Р§С‚Рѕ РїРѕР»СѓС‡РёРј
KeySet/
в”њв”Ђ KeySet.exe
в”њв”Ђ runtime/
в”‚  в”њв”Ђ db/keyset.db           в†ђ СЂР°Р±РѕС‡Р°СЏ Р‘Р”
в”‚  в”њв”Ђ profiles/              в†ђ РїСЂРѕС„РёР»Рё Р°РєРєР°СѓРЅС‚РѕРІ (user_data_dir)
в”‚  в”њв”Ђ browsers/              в†ђ Chromium Playwright РІРЅСѓС‚СЂРё РїСЂРѕРµРєС‚Р°
в”‚  в”њв”Ђ geo/regions_tree_full.json
в”‚  в”њв”Ђ config/proxies.json  .env (РµСЃР»Рё РЅР°РґРѕ)
в”‚  в””в”Ђ logs/
в””в”Ђ www/                      в†ђ СЃРѕР±СЂР°РЅРЅС‹Р№ React (frontend/dist)


РџРѕСЃР»Рµ СЃР±РѕСЂРєРё РјРѕР¶РЅРѕ РѕС‚Р»Р°Р¶РёРІР°С‚СЊ РІ СЌС‚РѕР№ РїР°РїРєРµ. РќРёС‡РµРіРѕ РЅРµ С‡РёСЃС‚РёРј РґРѕ С‚РІРѕРµР№ РєРѕРјР°РЅРґС‹.

0) РћРґРёРЅ РјР°Р»РµРЅСЊРєРёР№ РјРѕРґСѓР»СЊ РїСѓС‚РµР№ (С†РµРЅС‚СЂ РІСЃРµРіРѕ)

РЎРѕР·РґР°Р№ keyset/core/app_paths.py:

from __future__ import annotations
import os, sys, shutil
from pathlib import Path

# СЂР°Р·СЂРµС€Р°РµРј СѓРєР°Р·Р°С‚СЊ РєРѕСЂРµРЅСЊ РїСЂРёР»РѕР¶РµРЅРёСЏ С‡РµСЂРµР· РїРµСЂРµРјРµРЅРЅСѓСЋ РѕРєСЂСѓР¶РµРЅРёСЏ РґР»СЏ СЃРјРѕСѓРє-С‚РµСЃС‚Р°
ENV_APP_ROOT = os.environ.get("KEYSET_APP_ROOT")

def _app_root() -> Path:
    if ENV_APP_ROOT:
        return Path(ENV_APP_ROOT).resolve()
    if getattr(sys, 'frozen', False):
        return Path(sys.executable).resolve().parent
    # dev-СЂРµР¶РёРј: РєРѕСЂРµРЅСЊ СЂРµРїРѕ
    return Path(__file__).resolve().parents[3]

APP_ROOT = _app_root()
RUNTIME   = APP_ROOT / "runtime"
WWW_DIR   = APP_ROOT / "www"

DB_DIR     = RUNTIME / "db"
PROFILES   = RUNTIME / "profiles"
BROWSERS   = RUNTIME / "browsers"   # PLAYWRIGHT_BROWSERS_PATH
GEO_DIR    = RUNTIME / "geo"
CONFIG_DIR = RUNTIME / "config"
LOGS_DIR   = RUNTIME / "logs"

def ensure_runtime():
    for p in (DB_DIR, PROFILES, BROWSERS, GEO_DIR, CONFIG_DIR, LOGS_DIR):
        p.mkdir(parents=True, exist_ok=True)

def _bundle_dir() -> Path:
    return Path(getattr(sys, "_MEIPASS", APP_ROOT))

def bootstrap_files():
    """РљРѕРїРёСЂСѓРµРј С€Р°Р±Р»РѕРЅС‹ РІ runtime РїСЂРё РїРµСЂРІРѕРј Р·Р°РїСѓСЃРєРµ"""
    ensure_runtime()
    # Р‘Р”
    bundled_db = _bundle_dir() / "keyset" / "data" / "keyset.db"
    target_db  = DB_DIR / "keyset.db"
    if bundled_db.exists() and not target_db.exists():
        shutil.copy2(bundled_db, target_db)
    # GEO
    bundled_geo = _bundle_dir() / "keyset" / "data" / "regions_tree_full.json"
    target_geo  = GEO_DIR / "regions_tree_full.json"
    if bundled_geo.exists() and not target_geo.exists():
        shutil.copy2(bundled_geo, target_geo)
    # РєРѕРЅС„РёРіРё (РµСЃР»Рё РЅСѓР¶РЅС‹ РґРµС„РѕР»С‚С‹)
    bundled_proxies = _bundle_dir() / "keyset" / "data" / "proxies.json"
    if bundled_proxies.exists() and not (CONFIG_DIR / "proxies.json").exists():
        shutil.copy2(bundled_proxies, CONFIG_DIR / "proxies.json")

def sqlite_url() -> str:
    return f"sqlite:///{(DB_DIR / 'keyset.db').as_posix()}"

РџРѕРґРєР»СЋС‡Р°РµРј РјРѕРґСѓР»СЊ

keyset/core/db.py

from sqlalchemy import create_engine
from .app_paths import bootstrap_files, sqlite_url

bootstrap_files()
engine = create_engine(sqlite_url(), connect_args={"check_same_thread": False})


Playwright/РїР°СЂСЃРµСЂ (РіРґРµ РёРЅРёС†РёР°Р»РёР·РёСЂСѓРµС€СЊ Р±СЂР°СѓР·РµСЂ/РїСЂРѕС„РёР»Рё):

import os
from keyset.core.app_paths import PROFILES, BROWSERS

os.environ["PLAYWRIGHT_BROWSERS_PATH"] = str(BROWSERS)

def profile_dir(account_id: int) -> str:
    d = PROFILES / f"acc_{account_id}"
    d.mkdir(parents=True, exist_ok=True)
    return str(d)
# РґР°Р»СЊС€Рµ user_data_dir=profile_dir(acc.id)


FastAPI СЂР°Р·РґР°С‘С‚ SPA вЂ” РѕРґРёРЅ origin:

# backend/main.py (РїРѕСЃР»Рµ include_router)
from fastapi.staticfiles import StaticFiles
from keyset.core.app_paths import WWW_DIR, ensure_runtime, bootstrap_files
ensure_runtime(); bootstrap_files()
app.mount("/", StaticFiles(directory=str(WWW_DIR), html=True), name="static")


Р¤СЂРѕРЅС‚РµРЅРґ API-РєР»РёРµРЅС‚ вЂ” Р±РµР· С…Р°СЂРґРєРѕРґР°:

// axios/fetch
const api = axios.create({ baseURL: "/api" });

1) Р›Р°СѓРЅС‡РµСЂ (Edge РІ app-СЂРµР¶РёРјРµ, РѕРґРёРЅ РїРѕСЂС‚)
# launcher.py
import subprocess, sys, time
from keyset.core.app_paths import APP_ROOT

PORT = "8765"

backend = subprocess.Popen([
    sys.executable, "-m", "uvicorn", "backend.main:app",
    "--host", "127.0.0.1", "--port", PORT, "--log-level", "warning"
], cwd=str(APP_ROOT), stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)

time.sleep(1.5)  # РјРѕР¶РЅРѕ Р·Р°РјРµРЅРёС‚СЊ РЅР° health-check

subprocess.Popen([
    "msedge", f"--app=http://127.0.0.1:{PORT}/",
    rf"--user-data-dir={APP_ROOT}\runtime\edge_profile",
    "--disable-extensions", "--disable-plugins"
], cwd=str(APP_ROOT))

2) РђСЃСЃРµРјР±Р»РµСЂ (СЃРѕР±РёСЂР°РµС‚ РІСЃС‘ РІ РѕРґРЅСѓ РїР°РїРєСѓ Рё РќРР§Р•Р“Рћ РЅРµ СѓРґР°Р»СЏРµС‚)

РЎРѕР·РґР°Р№ build\assemble_portable.bat:

@echo off
setlocal enableextensions

REM 0. Р§РёСЃС‚РёРј С‚РѕР»СЊРєРѕ staging-РїР°РїРєСѓ (РёСЃС…РѕРґРЅРёРєРё РЅРµ С‚СЂРѕРіР°РµРј)
rmdir /S /Q out 2>nul
mkdir out\KeySet\runtime\db
mkdir out\KeySet\runtime\profiles
mkdir out\KeySet\runtime\browsers
mkdir out\KeySet\runtime\geo
mkdir out\KeySet\runtime\config
mkdir out\KeySet\runtime\logs
mkdir out\KeySet\www

REM 1. РЎРѕР±РёСЂР°РµРј С„СЂРѕРЅС‚ Рё РєР»Р°РґС‘Рј РІ www
pushd frontend
call npm run build || goto :err
popd
xcopy /E /I /Y frontend\dist out\KeySet\www >nul

REM 2. Р“РѕС‚РѕРІРёРј Р±СЂР°СѓР·РµСЂ Playwright Р’РќРЈРўР Р РїСЂРѕРµРєС‚Р°
set PLAYWRIGHT_BROWSERS_PATH=out\KeySet\runtime\browsers
py -m pip install --disable-pip-version-check playwright >nul
py -m playwright install chromium >nul

REM 3. РљРѕРїРёСЂСѓРµРј С€Р°Р±Р»РѕРЅ Р‘Р”/geo/РєРѕРЅС„РёРіРё (РµСЃР»Рё РµСЃС‚СЊ)
if exist keyset\data\keyset.db xcopy /Y keyset\data\keyset.db out\KeySet\keyset\data\ >nul
if exist keyset\data\regions_tree_full.json xcopy /Y keyset\data\regions_tree_full.json out\KeySet\keyset\data\ >nul
if exist keyset\data\proxies.json xcopy /Y keyset\data\proxies.json out\KeySet\keyset\data\ >nul

REM 4. РЎРјРѕСѓРє-С‚РµСЃС‚ Р±РµР· СЃР±РѕСЂРєРё: РїРѕРґРЅРёРјР°РµРј Р±РµРєРµРЅРґ РЅР° out\KeySet РєР°Рє APP_ROOT
set KEYSET_APP_ROOT=%cd%\out\KeySet
start "" /B py -c "import uvicorn,os;os.environ['KEYSET_APP_ROOT']=r'%KEYSET_APP_ROOT%';from backend.main import app; uvicorn.run(app,host='127.0.0.1',port=8765,log_level='warning')" 
timeout /t 2 >nul
powershell -command "$r=iwr http://127.0.0.1:8765/api/health -UseBasicParsing; if($r.StatusCode -ne 200){exit 1}"
if errorlevel 1 goto :err
powershell -command "$r=iwr http://127.0.0.1:8765/ -UseBasicParsing; if($r.StatusCode -lt 200 -or $r.StatusCode -ge 400){exit 1}"
if errorlevel 1 goto :err
taskkill /FI "WINDOWTITLE=uvicorn*" /F >nul 2>&1

echo OK: portable assembled in out\KeySet
exit /b 0

:err
echo BUILD ERROR. Check logs above.
exit /b 1


РЎРєСЂРёРїС‚ РЅРёС‡РµРіРѕ РЅРµ СѓРґР°Р»СЏРµС‚ РІ РёСЃС…РѕРґРЅРёРєР°С…. РћРЅ РґРµР»Р°РµС‚ staging РІ out\KeySet\ Рё СЃСЂР°Р·Сѓ РїСЂРѕРІРµСЂСЏРµС‚, С‡С‚Рѕ API Рё SPA РѕС‚РІРµС‡Р°СЋС‚ РёР· СЌС‚РѕР№ РїР°РїРєРё (С‡РµСЂРµР· KEYSET_APP_ROOT). Р•СЃР»Рё С‚РµСЃС‚ РЅРµ РїСЂРѕС€С‘Р» вЂ” РѕСЃС‚Р°РЅР°РІР»РёРІР°РµРјСЃСЏ, РЅРёС‡РµРіРѕ РЅРµ СѓРґР°Р»СЏРµРј.

3) PyInstaller (РєР»Р°РґС‘Рј exe РІ С‚Сѓ Р¶Рµ РїР°РїРєСѓ)

build/KeySet.spec (РєРѕСЂРѕС‚РєРѕ):

# pyinstaller -y build/KeySet.spec
block_cipher=None
import os
APP_ROOT=os.path.abspath("out/KeySet")  # СЃРѕР±РёСЂР°РµРј РїСЂСЏРјРѕ РёР· staging

a = Analysis(
    ['launcher.py'],
    pathex=[APP_ROOT],
    datas=[
        (os.path.join(APP_ROOT,'www'),'www'),
        (os.path.join(APP_ROOT,'runtime','browsers'),'runtime/browsers'),
        ('keyset/data/keyset.db','keyset/data'),
        ('keyset/data/regions_tree_full.json','keyset/data'),
        ('keyset/data/proxies.json','keyset/data'),
    ],
    hiddenimports=['uvicorn','fastapi','jinja2','playwright','playwright._impl._driver',
                   'playwright._impl._transport','playwright._impl._api_structures'],
    excludes=['numpy','pandas','matplotlib'],
)
pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)
exe = EXE(pyz, a.scripts, a.binaries, a.zipfiles, a.datas, name='KeySet', console=False, icon='build/icon.ico')
coll = COLLECT(exe, a.binaries, a.zipfiles, a.datas, name='KeySet')

4) РљР°Рє Р·Р°РїСѓСЃРєР°С‚СЊ РІСЃС‘ СЌС‚Рѕ (Р±РµР· СѓРґР°Р»РµРЅРёСЏ С‡РµРіРѕ-Р»РёР±Рѕ)

build\assemble_portable.bat вЂ” РїРѕР»СѓС‡РёС€СЊ out\KeySet\ СЃ РїРѕР»РЅС‹Рј СЂР°РЅС‚Р°Р№РјРѕРј Рё РїСЂРѕР№РґРµРЅРЅС‹Рј СЃРјРѕСѓРє-С‚РµСЃС‚РѕРј.

py -m PyInstaller -y build\KeySet.spec вЂ” РїРѕР»РѕР¶РёС‚ KeySet.exe СЂСЏРґРѕРј (РІ dist\KeySet\ РёР»Рё РїРµСЂРµРЅРµСЃРё РІ out\KeySet\).

РЎС‚Р°СЂС‚СѓР№ out\KeySet\KeySet.exe.

РћС‚РєСЂРѕР№ В«РђРєРєР°СѓРЅС‚С‹/Р”Р°РЅРЅС‹РµВ» вЂ” Р·Р°РїСЂРѕСЃС‹ РёРґСѓС‚ РЅР° http://127.0.0.1:8765, Р‘Р” вЂ” runtime\db\keyset.db, РїСЂРѕС„РёР»Рё вЂ” runtime\profiles\вЂ¦, Р±СЂР°СѓР·РµСЂ вЂ” runtime\browsers\вЂ¦.

РљРѕРЅС‚СЂРѕР»СЊРЅС‹Р№ С‡РµРє-Р»РёСЃС‚ (С‡С‚Рѕ РґРѕР»Р¶РЅРѕ Р±С‹С‚СЊ РґРѕ РѕС‚Р»Р°РґРєРё)

 out\KeySet\www\index.html Рё assets/* РЅР° РјРµСЃС‚Рµ.

 out\KeySet\runtime\db\keyset.db РїРѕСЃР»Рµ РїРµСЂРІРѕРіРѕ Р·Р°РїСѓСЃРєР° РїРѕСЏРІРёР»СЃСЏ.

 out\KeySet\runtime\browsers\ РЅРµ РїСѓСЃС‚Р°СЏ (РµСЃС‚СЊ Chromium).

 GET http://127.0.0.1:8765/api/health в†’ 200.

 В«РђРєРєР°СѓРЅС‚С‹/Р”Р°РЅРЅС‹РµВ» Р±РµР· В«Failed to fetchВ».

 РџР°СЂСЃРµСЂ СЃС‚Р°СЂС‚СѓРµС‚, РїСЂРѕС„РёР»Рё РїРёС€СѓС‚СЃСЏ РІ runtime\profiles\acc_*.

РҐРѕС‡РµС€СЊ вЂ” РїСЂРёС€Р»СЋ РіРѕС‚РѕРІС‹Рµ DIFF-РІСЃС‚Р°РІРєРё СЃСЂР°Р·Сѓ РїРѕРґ С‚РІРѕРё С„Р°Р№Р»С‹ (app_paths.py, РёР·РјРµРЅРµРЅРёСЏ РІ db.py/main.py, launcher.py, Р±Р°С‚РЅРёРє Рё .spec). Р’СЃС‘ СЌС‚Рѕ СЂР°Р±РѕС‚Р°РµС‚ Р±РµР· СѓРґР°Р»РµРЅРёСЏ С‡РµРіРѕ-Р»РёР±Рѕ: СЃРЅР°С‡Р°Р»Р° СЃРѕР±РёСЂР°РµРј В«РїРѕСЂС‚Р°С‚РёРІРєСѓВ» Рё РїСЂРѕРіРѕРЅСЏРµРј СЃРјРѕСѓРє-С‚РµСЃС‚, С‚РѕР»СЊРєРѕ РїРѕС‚РѕРј СѓР¶Рµ, РєРѕРіРґР° СЃРєР°Р¶РµС€СЊ, РјРѕР¶РЅРѕ Р±СѓРґРµС‚ С‡РёСЃС‚РёС‚СЊ СЃС‚Р°СЂРѕРµ.