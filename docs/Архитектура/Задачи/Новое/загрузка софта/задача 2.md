Р§С‚Рѕ РґРµР»Р°РµРј РїСЂСЏРјРѕ СЃРµР№С‡Р°СЃ (РјРёРЅРёРјСѓРј РїСЂР°РІРѕРє)
1) Р”Р°С‚СЊ Р±СЌРєРµРЅРґСѓ РїСЂР°РІРёР»СЊРЅС‹Р№ РїСѓС‚СЊ Рє Р‘Р” (С‡С‚РѕР±С‹ В«РђРєРєР°СѓРЅС‚С‹В»/В«Р”Р°РЅРЅС‹РµВ» РЅР°РїРѕР»РЅРёР»РёСЃСЊ)

РЎРµР№С‡Р°СЃ .exe РїРѕРґРЅСЏР»СЃСЏ, РЅРѕ API СЃРјРѕС‚СЂРёС‚ РЅРµ РІ С‚Сѓ SQLite. Р”РµР»Р°РµРј СѓРЅРёРІРµСЂСЃР°Р»СЊРЅРѕ: Р±СЌРєРµРЅРґ СЃР°Рј РЅР°С…РѕРґРёС‚ СЂР°Р±РѕС‡СѓСЋ Р‘Р”.

Р¤Р°Р№Р»: keyset/core/db.py (Р·Р°РјРµРЅРё СЃРѕРґРµСЂР¶РёРјРѕРµ РЅР° СЌС‚Рѕ вЂ” РєРѕСЂРѕС‚РєРѕ Рё Р±РµР·РѕРїР°СЃРЅРѕ)

from __future__ import annotations
from sqlalchemy import create_engine
from pathlib import Path
import sys

def _db_path() -> Path:
    # 1) Р•СЃР»Рё Р·Р°РїСѓС‰РµРЅРѕ РёР· exe (dist\KeySet.exe), Р±РµСЂС‘Рј Р‘Р” СЂСЏРґРѕРј СЃ exe: dist\keyset.db
    if getattr(sys, "frozen", False):
        p = Path(sys.executable).resolve().parent / "keyset.db"
        if p.exists():
            return p
    # 2) Р•СЃР»Рё РµСЃС‚СЊ Р·Р°РїРѕР»РЅРµРЅРЅР°СЏ Р‘Р” РІ dist\keyset.db вЂ” РёСЃРїРѕР»СЊР·СѓРµРј РµС‘ РІ РґРµРІ-СЂРµР¶РёРјРµ
    dist_db = Path(__file__).resolve().parents[2] / "dist" / "keyset.db"
    if dist_db.exists():
        return dist_db
    # 3) Р¤РѕР»Р±СЌРє РЅР° РїСЂРѕРµРєС‚РЅСѓСЋ keyset\keyset.db (РїСѓСЃС‚Р°СЏ/РґРµС„РѕР»С‚)
    proj_db = Path(__file__).resolve().parents[1] / "keyset.db"
    return proj_db

DB_PATH = _db_path()
engine = create_engine(f"sqlite:///{DB_PATH.as_posix()}", connect_args={"check_same_thread": False})


Р•СЃР»Рё Сѓ С‚РµР±СЏ В«Р¶РёРІР°СЏВ» Р‘Р” СЃРµР№С‡Р°СЃ РІ dist\keyset.db вЂ” РЅРёС‡РµРіРѕ РєРѕРїРёСЂРѕРІР°С‚СЊ РЅРµ РЅСѓР¶РЅРѕ, Р±СЌРєРµРЅРґ СЃР°Рј РµС‘ РїРѕРґС…РІР°С‚РёС‚. Р•СЃР»Рё РѕРЅР° РІ РґСЂСѓРіРѕРј РјРµСЃС‚Рµ вЂ” СЃРєР°Р¶Рё, РїРѕРґРїСЂР°РІР»СЋ РїРѕСЂСЏРґРѕРє.

2) Р Р°Р·РґР°С‚СЊ С„СЂРѕРЅС‚ С‡РµСЂРµР· FastAPI (С‡С‚РѕР±С‹ UI СЂРµР°Р»СЊРЅРѕ РіСЂСѓР·РёР»СЃСЏ РёР· .exe)

Р¤Р°Р№Р»: backend/main.py (РґРѕР±Р°РІСЊ РІ СЃР°РјС‹Р№ РЅРёР·, РїРѕСЃР»Рµ include_router(...))

# --- SPA СЂР°Р·РґР°С‡Р° ---
from fastapi.staticfiles import StaticFiles
from pathlib import Path
import sys

def _spa_dir() -> Path:
    # dev: KeySet-MVP\frontend\dist
    dev_dist = Path(__file__).resolve().parents[1] / "frontend" / "dist"
    if dev_dist.exists():
        return dev_dist
    # exe: СЂСЏРґРѕРј СЃ exe РґРѕР»Р¶РЅР° Р»РµР¶Р°С‚СЊ РїР°РїРєР° www (СЃРј. .spec РЅРёР¶Рµ)
    if getattr(sys, "frozen", False):
        return Path(sys.executable).parent / "www"
    return dev_dist

app.mount("/", StaticFiles(directory=str(_spa_dir()), html=True), name="static")


Р­С‚Рѕ РґР°С‘С‚ РѕРґРёРЅ origin: UI (/) Рё API (/api/*) РІРјРµСЃС‚Рµ в†’ РёСЃС‡РµР·Р°СЋС‚ В«Failed to fetchВ».

3) РЈР±РµРґРёС‚СЊСЃСЏ, С‡С‚Рѕ С„СЂРѕРЅС‚ СЃС‚СѓС‡РёС‚СЃСЏ РЅР° /api (Р±РµР· С…Р°СЂРґРєРѕРґР° РїРѕСЂС‚РѕРІ)

РџСЂРѕРІРµСЂСЊ РІ React РєР»РёРµРЅС‚Рµ (РіРґРµ СЃРѕР·РґР°С‘С€СЊ axios/fetch), РґРѕР»Р¶РЅРѕ Р±С‹С‚СЊ С‚Р°Рє:

// РїСЂРёРјРµСЂ
export const api = axios.create({ baseURL: "/api" });


Р•СЃР»Рё РіРґРµ-С‚Рѕ РѕСЃС‚Р°Р»РѕСЃСЊ http://127.0.0.1:5173 РёР»Рё :8765 вЂ” СѓР±РµСЂРё, РёРЅР°С‡Рµ UI РІ exe Р±СѓРґРµС‚ Р±РёС‚СЊ РјРёРјРѕ.

4) Р’Р»РѕР¶РёС‚СЊ С„СЂРѕРЅС‚ РІ СЃР±РѕСЂРєСѓ (С‡С‚РѕР±С‹ .exe РёРјРµР» UI)

Р¤Р°Р№Р»: build/KeySet.spec вЂ” РґРѕР±Р°РІСЊ frontend/dist Рё Р±Р°Р·РѕРІС‹Рµ РґР°РЅРЅС‹Рµ РІ datas:

a = Analysis(
    ['launcher.py'],
    pathex=['.'],
    datas=[
        ('frontend/dist', 'www'),                              # UI РІРЅСѓС‚СЂСЊ exe
        ('keyset/data/regions_tree_full.json', 'keyset/data'),# GEO
        ('keyset/keyset.db', 'keyset'),                       # РґРµС„РѕР»С‚РЅР°СЏ Р‘Р” (РЅР° СЃР»СѓС‡Р°Р№ РѕС‚СЃСѓС‚СЃС‚РІРёСЏ dist\keyset.db)
    ],
    hiddenimports=[
        'uvicorn','fastapi','jinja2',
        'playwright','playwright._impl._driver','playwright._impl._transport','playwright._impl._api_structures'
    ],
    excludes=['numpy','pandas','matplotlib'],
)


Р­С‚Рѕ РЅРµ Р»РѕРјР°РµС‚ С‚РІРѕСЋ В«Р¶РёРІСѓСЋВ» Р‘Р”: РїРѕ РєРѕРґСѓ РёР· Рї.1, РїСЂРё РЅР°Р»РёС‡РёРё dist\keyset.db Р±СѓРґРµС‚ РІР·СЏС‚Р° РёРјРµРЅРЅРѕ РѕРЅР°.

5) РџСЂРѕС„РёР»Рё Р°РєРєР°СѓРЅС‚РѕРІ Рё Playwright (С‡С‚РѕР± РЅРµ РїСЂРѕРїР°Р»Рё)

РџРѕРєР° РЅРёС‡РµРіРѕ РЅРµ РїРµСЂРµРЅРѕСЃРёРј. Р•СЃР»Рё СЃС‚Р°СЂС‹Рµ РїСЂРѕС„РёР»Рё Р»РµР¶Р°С‚, РЅР°РїСЂРёРјРµСЂ, РІ keyset\.profiles\..., РїСЂРѕСЃС‚Рѕ РѕС‚РґР°Р№ РёС… С‡РµСЂРµР· СЌРЅРґРїРѕРёРЅС‚.

Р¤Р°Р№Р»: backend/routers/accounts.py (РґРѕР±Р°РІСЊ РїСЂРѕСЃС‚РѕР№ СЃРїРёСЃРѕРє РїСЂРѕС„РёР»РµР№)

from pathlib import Path
from fastapi import APIRouter
router = APIRouter(prefix="/api/accounts", tags=["accounts"])

PROFILES_ROOT = Path(__file__).resolve().parents[2] / "keyset" / ".profiles"

@router.get("")
def list_accounts():
    if not PROFILES_ROOT.exists():
        return []
    # Р»СЋР±РѕР№ РїСЂРѕСЃС‚РѕР№ С„РѕСЂРјР°С‚: id=РёРјСЏ РїР°РїРєРё, path=РїРѕР»РЅС‹Р№ РїСѓС‚СЊ
    return [
        {"id": p.name, "profile_path": str(p), "status": "unknown"}
        for p in PROFILES_ROOT.iterdir() if p.is_dir()
    ]


РџРѕРґРєР»СЋС‡Рё СЂРѕСѓС‚РµСЂ (РµСЃР»Рё РµС‰С‘ РЅРµ): РІ backend/main.py

from backend.routers import accounts
app.include_router(accounts.router)


Р­С‚РѕРіРѕ РґРѕСЃС‚Р°С‚РѕС‡РЅРѕ, С‡С‚РѕР±С‹ РІРєР»Р°РґРєР° В«РђРєРєР°СѓРЅС‚С‹В» С‡С‚Рѕ-С‚Рѕ СѓРІРёРґРµР»Р°. Р¤РѕСЂРјР°С‚ РїРѕРґРіРѕРЅРёРј РїРѕРґ С„СЂРѕРЅС‚ (СЃРєР°Р¶Рё, РєР°РєРёРµ РїРѕР»СЏ РѕРЅ Р¶РґС‘С‚ вЂ” id/login/status?).

6) Р”Р°РЅРЅС‹Рµ/С‡Р°СЃС‚РѕС‚РєР° вЂ” РІС‹С‚Р°С‰РёС‚СЊ РёР· Р‘Р” С‚Рѕ, С‡С‚Рѕ С„СЂРѕРЅС‚ Р¶РґС‘С‚

Р•СЃР»Рё Сѓ С‚РµР±СЏ СѓР¶Рµ РµСЃС‚СЊ routers/data.py вЂ” РїСЂРѕРІРµСЂСЊ, С‡С‚РѕР±С‹ СЃРїРёСЃРѕРє С„СЂР°Р·/СЂРµР·СѓР»СЊС‚Р°С‚РѕРІ РІРѕР·РІСЂР°С‰Р°Р» СЂРѕРІРЅРѕ С‚Рµ РїРѕР»СЏ, РєРѕС‚РѕСЂС‹Рµ РІ С‚Р°Р±Р»РёС†Рµ РЅР° С„СЂРѕРЅС‚Рµ:

id, phrase, region_id, freq_total, freq_exact, group, updated_at (РїСЂРёРјРµСЂ).

Р•СЃР»Рё С„Р°Р№Р»Р° РЅРµС‚ вЂ” РґРѕР±Р°РІСЊ Р±Р°Р·РѕРІС‹Р№:

# backend/routers/data.py
from fastapi import APIRouter
from sqlalchemy import text
from keyset.core.db import engine

router = APIRouter(prefix="/api/data", tags=["data"])

@router.get("/phrases")
def list_phrases(limit: int = 100):
    with engine.connect() as c:
        rows = c.execute(text("""
          SELECT id, phrase, region_id, freq_total, freq_exact, "group", updated_at
          FROM freq_results
          ORDER BY updated_at DESC
          LIMIT :limit
        """), {"limit": limit}).mappings().all()
    return {"rows": rows}

@router.get("/regions")
def list_regions():
    # РµСЃР»Рё С„СЂРѕРЅС‚Сѓ РЅСѓР¶РЅС‹ СЂРµРіРёРѕРЅС‹ вЂ” С‡РёС‚Р°РµРј json
    from pathlib import Path
    import json
    p = Path(__file__).resolve().parents[2] / "keyset" / "data" / "regions_tree_full.json"
    return json.loads(p.read_text(encoding="utf-8")) if p.exists() else []


Р РїРѕРґРєР»СЋС‡Рё:

from backend.routers import data
app.include_router(data.router)


Р•СЃР»Рё РїСЂРё Р·Р°РїСЂРѕСЃРµ /api/data/phrases РїРѕР»СѓС‡РёС€СЊ no such column вЂ” СЌС‚Рѕ РЅРµ UI, Р° СЃС…РµРјР° Р‘Р”. РўРѕРіРґР° Р±С‹СЃС‚СЂРѕ РґРѕРєРёРЅРµРј РјРёРіСЂР°С†РёСЋ/ALTER РїРѕРґ С‚РІРѕРё СЂРµР°Р»СЊРЅС‹Рµ РєРѕР»РѕРЅРєРё (СЃРєР°Р¶Рё СЃС‚СЂСѓРєС‚СѓСЂСѓ С‚Р°Р±Р»РёС†С‹ freq_results).

7) (РћРїС†РёРѕРЅР°Р»СЊРЅРѕ РЅР° Р·Р°РІС‚СЂР°) РљРЅРѕРїРєР° В«Р—Р°РїСѓСЃС‚РёС‚СЊ РїР°СЂСЃРёРЅРіВ»

РњРёРЅРёРјР°Р»СЊРЅРѕ: С„РѕРЅРѕРІР°СЏ Р·Р°РґР°С‡Р°, РєРѕС‚РѕСЂР°СЏ Р·РѕРІС‘С‚ С‚РІРѕР№ turbo_parser_improved.py.

# backend/routers/parsing.py
from fastapi import APIRouter, BackgroundTasks
router = APIRouter(prefix="/api/parsing", tags=["parsing"])

def run_parser(payload: dict):
    # С‚СѓС‚ РёРјРїРѕСЂС‚РёСЂСѓРµС€СЊ СЃРІРѕР№ РјРѕРґСѓР»СЊ Рё Р·Р°РїСѓСЃРєР°РµС€СЊ
    # СЃРѕС…СЂР°РЅСЏРµС€СЊ РІ С‚Сѓ Р¶Рµ Р‘Р”, РєРѕС‚РѕСЂСѓСЋ С‡РёС‚Р°РµРј РІ /api/data/phrases
    from keyset.services.turbo_parser_improved import run_batch
    run_batch(payload)

@router.post("/start")
def start_parsing(payload: dict, bg: BackgroundTasks):
    bg.add_task(run_parser, payload)
    return {"status": "queued"}


РџРѕРґРєР»СЋС‡Рё:

from backend.routers import parsing
app.include_router(parsing.router)

РљР°Рє РїСЂРѕРІРµСЂРёС‚СЊ (Р±С‹СЃС‚СЂРѕ)

РЎРѕР±РµСЂРё С„СЂРѕРЅС‚:
cd frontend && npm run build && cd ..

РЎРѕР±РµСЂРё exe:
py -m PyInstaller -y build\KeySet.spec

Р—Р°РїСѓСЃС‚Рё:
dist\KeySet\KeySet.exe

РџСЂРѕРІРµСЂСЊ РІ РѕРєРЅРµ:

http://127.0.0.1:8765/api/health в†’ 200

http://127.0.0.1:8765/api/accounts в†’ РјР°СЃСЃРёРІ (РїР°РїРєРё РїСЂРѕС„РёР»РµР№)

http://127.0.0.1:8765/api/data/phrases в†’ СЃС‚СЂРѕРєРё РёР· С‚РІРѕРµР№ Р‘Р”

РІРєР»Р°РґРєР° В«РђРєРєР°СѓРЅС‚С‹В»/В«Р”Р°РЅРЅС‹РµВ» вЂ” РїРѕРєР°Р·С‹РІР°РµС‚ СЃРѕРґРµСЂР¶РёРјРѕРµ

Р•СЃР»Рё В«РђРєРєР°СѓРЅС‚С‹/Р”Р°РЅРЅС‹РµВ» РїСѓСЃС‚С‹Рµ:

РЎРєР°Р¶Рё, РіРґРµ С‚РІРѕСЏ РЅР°СЃС‹С‰РµРЅРЅР°СЏ Р‘Р” (РїСѓС‚СЊ). РџРѕРґРєСЂСѓС‡Сѓ РїСЂРёРѕСЂРёС‚РµС‚ РІ db.py.

РџРѕРєР°Р¶Рё Network (СЃС‚Р°С‚СѓСЃ-РєРѕРґС‹ /api/*) вЂ” СЃСЂР°Р·Сѓ РїРѕР№РјСѓ, РїРѕР»Рµ/С‚Р°Р±Р»РёС†Р°/СЌРЅРґРїРѕРёРЅС‚.

РћС‚РІРµС‚ РЅР° С‚РІРѕР№ РІРѕРїСЂРѕСЃ В«РЅР°С‡РёРЅР°С‚СЊ СЃ Р­С‚Р°РїР° 1?В»

Р”Р°. Р­С‚Р°Рї 1 вЂ” СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёСЏ Р‘Р” СЏ РІС‹С€Рµ СѓР¶Рµ СЃРґРµР»Р°Р» В«РїСЂР°РІРёР»СЊРЅРѕВ»: РЅРµ РєРѕРїРёСЂСѓРµРј СЂСѓРєР°РјРё, Р° РґР°С‘Рј Р±СЌРєРµРЅРґСѓ РїРѕРґРѕР±СЂР°С‚СЊ РїСЂР°РІРёР»СЊРЅСѓСЋ Р‘Р” Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё (dist в†’ РїСЂРёРѕСЂРёС‚РµС‚). Р­С‚Рѕ РјРѕРјРµРЅС‚Р°Р»СЊРЅРѕ РѕР¶РёРІРёС‚ В«РђРєРєР°СѓРЅС‚С‹/Р”Р°РЅРЅС‹РµВ». Р”Р°Р»СЊС€Рµ РґС‘СЂРЅРµРј РїР°СЂСЃРµСЂ С‡РµСЂРµР· РїСЂРѕСЃС‚РѕР№ СЌРЅРґРїРѕРёРЅС‚.