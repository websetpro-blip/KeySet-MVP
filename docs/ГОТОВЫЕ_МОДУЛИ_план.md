# Инвентаризация каталога `ГОТОВЫЕ МОДУЛИ` и план сборки локального React-KeySet (UTF-8)

## 1. Сводный обзор по папкам

| Папка | Что лежит внутри | Техстек/формат | Готовность к встройке |
| --- | --- | --- | --- |
| `аккаунты` | Статическая вёрстка CARDVANCE (HTML/CSS/JS), демо-данные, отчёты и скрины | Чистый HTML (index.html, script.js 80 КБ, styles.css 28 КБ) + вспомогательные файлы; нет React/TS | UI полностью описан, но его нужно руками разбить на React-компоненты или переписать на основе `keyset-desktop/ui/AccountsTab.tsx` |
| `Аналитика` | Полноценный Vite+React+TS проект `yandex-direct-analytics`, две готовых сборки (`*-ready`) с локальными spa_server.js | React 18, TypeScript, Tailwind, Radix UI, Supabase | Модуль можно просто скопировать в общую фронтовую монорепу (lazy route), но нужно унифицировать Tailwind токены и вынести supabase env |
| `Данные` | 1) React-проект `старые` (десятки компонентов, Zustand, drag&drop) 2) PySide6 порт `keyset_v5` с автопатчером 3) Большой набор документов и research | React 18 + TS + Tailwind + Zustand, отдельно PySide6 | Для веб-МVP используем React-версию; PySide6 оставляем как reference. Портирование потребует приведения стора/утилит к новому API |
| `Маски` | Vite+React проект «Professional Generator», lib с грамматикой масок, drag&drop фиксы | React 18, TS, Tailwind, Radix, собственные генераторы (stream, negative sets) | Готов к ленивой загрузке; нужно только адаптировать импорты и tailwind config |
| `документация` | Текстовые инструкции (вкладка аккаунты/данные, общая задача, туториал для агентов) | TXT/MD | Используем как справочник требований; в код не встраиваем |
| `cardvance-white-premium-style-guide.md` | Палитры, типографика, тени/радиусы | Markdown | Служит источником дизайн-токенов для всего React UI |
| `ГОТОВЫЕ МОДУЛИ.zip` | Архив каталога | ZIP 1 МБ | Резервная копия, хранить отдельно |

## 2. Детали по каждому модулю

### 2.1 `аккаунты`
- **Структура**: только две подпапки `keyset-v2-fixed` (актуальная вёрстка) и `user_input_files` (предыдущая версия + материалы). Qt-файлы (`main.py`, `.ui`) удалены — полагаться нечему.
- **Функциональность**: `script.js` содержит весь UI- и доменный код: генерация таблицы, массовые действия (`launchSelectedAccounts`, `deleteSelectedAccounts`), фильтр `enhanced-search.js`, LocalStorage (`keyset_data`), моковые API (`updateAccountViaAPI`, `parseProxiesViaAPI`, `testProxyViaAPI`), боковая панель с табами (Основное/Сеть/Fingerprint/Капча/Менеджер прокси).
- **Документы**: `КОНТЕКСТ_ЧАТА_v3.0.md` описывает историю версий (v1/v2/v3, все 16 функций), `ПРОЕКТ_ИНФО_v3.md` и `История чата.txt` — подробное ТЗ и переписка, `image.png` — эталонный скрин.
- **Интеграционные шаги**:
  1. Превратить `styles.css` в модульные стили/общие компоненты (top-bar, toolbar, cards).
  2. Разрезать `script.js` на React-компоненты (таблица, sidebar, cards) и вынести демо-данные в `src/api/mocks/accounts`.
  3. Заменить FontAwesome CDN на локальные SVG (иначе PyInstaller/офлайн не пройдут).
  4. Внедрить состояние через Zustand/Context, чтобы фильтры и выбор строк работали без прямых DOM-манипуляций.
- **Сделано 2025-11-07 (Codex)**:
  - Подключён готовый HTML/CSS/JS из `ГОТОВЫЕ МОДУЛИ\аккаунты\keyset-v2-fixed`: `KeySet-MVP/frontend/src/modules/accounts/index.tsx` теперь инжектирует оригинальные разметку и скрипты без переписывания логики, UI совпадает с эталоном CARDVANCE.
  - Проверены `npm run build` и `python launcher.py` — сборка и лаунчер проходят; остаются только предупреждения Vite про размер чанков.
- **Осталось по модулю**:
  1. Переписать запуск `DOMContentLoaded` в обёртке (сейчас слушатель встраивается повторно при каждом маунте, из-за чего возможны дубли обработчиков после навигации).
  2. Подтянуть реальные данные/IPC вместо моков из `script.js`, убрать прямые обращения к `window` при интеграции с сервисами аккаунтов.
  3. Добавить все CSS/JS/asset зависимости в PyInstaller datas и проверить запуск готового клиента, чтобы внешние ресурсы не потерялись.
  4. После стабилизации UI обновить раздел «Аккаунты» в `README_FINAL_INTERFACE.md` и прогнать e2e сценарии (фильтр, массовые действия, боковая панель).

### 2.2 `Аналитика`
- **Исходники**: `yandex-direct-analytics/` — Vite + TS + Tailwind. Главный flow в `src/App.tsx`: BrowserRouter, nested Routes (`/dashboard`, `/analytics`, `/recommendations`, `/settings`) и `OAuthCallback`.
- **UI-компоненты**: `src/components` содержит Dashboard, Recommendations, Navigation, ErrorBoundary. Используются Radix/vaul/cmdk, Supabase клиент (`src/lib/supabase.ts`), мобильные хуки (`use-mobile`).
- **Готовые сборки**: `yandex-direct-analytics-ready` и `yandex-direct-analytics-local-ready` — уже собранные SPA с `spa_server.js` и инструкциями `БЫСТРЫЙ_ЗАПУСК.md`, `УСТАНОВКА_И_ЗАПУСК.md`.
- **Нюансы интеграции**:
  - Tailwind конфиг (`tailwind.config.js`) ожидает корневой postcss/tsconfig — нужно объединить с общим проектом.
  - Supabase ключи должны подтягиваться из `.env`/`LocalAgent`.
  - BrowserRouter внутри модуля надо заменить на вложенные маршруты в общем `App`.
  - Все стили построены на utility-классах — важно, чтобы общий postcss собирал именно те пути.

### 2.3 `Данные`
- **React-проект `старые/`**:
  - `src/components` включает ActivityLog, GroupsPanel, PhrasesTable, Toolbar, 23 модалки (AdvancedFilters, Export, Pipelines, Snapshots и т.д.), ui kit (Button/Checkbox/Input).
  - `src/store/useStore.ts` — Zustand + middlewares (undo/redo, автосохранение) с типами (`src/types/*.ts`) и сервисами (`src/services/dataProcessing.ts`).
  - `src/utils` реализуют морфологию, кросс-минусацию, экспорт/импорт, анализ качества.
  - Завязки на клавиатурные шорткаты (`react-hotkeys-hook`), drag&drop (`@dnd-kit`), tree viewer (`react-arborist`).
- **PySide6 `keyset_v5/`**:
  - Файлы `main_window.py`, `components/phrases_table.py`, `store/state_manager.py`, автопатчер `apply_patch.py`, запуск `run_v5.py`.
  - Полезны для понимания логики, но в React-монорепу не встраиваем (отдельный exe).
- **Документы**: `docs/` содержит дизайн-спеки, отчёты (Sprint 2/3, V5 checklist, ROADMAP, research по таблицам/undo/localStorage). Это материал для требований.
- **Нюансы интеграции**:
  - React-версия использует те же зависимости, что и «Аналитика/Маски» (Radix, Tailwind, Zustand) → выгодно создать общий `pnpm workspace`.
  - Нужно привести существующий Zustand-стор к REST API (сейчас всё локально) и заменить утилиты, завязанные на browser-only API (localStorage) на абстракции.
  - Большой объём модалок потребует код-сплиттинга (dynamic import) и общего модального менеджера.

### 2.4 `Маски`
- **Состав**: `src/App.tsx` монтирует `ProfessionalGenerator` — сложный UI с деревом масок, генератором потоков, профилями отраслей (`src/lib/industry-profiles/*.json`), грамматикой (`mask-grammar-parser.ts`), операторами (`operators-policy.ts`), stream generator, negative sets builder.
- **Доп. файлы**: `DRAG_DROP_FIX.md` — описание багфикса dnd, `components.json` и Tailwind конфиг — идентичны остальным модулем.
- **Интеграционные моменты**:
  - Библиотека `tree_ops.ts` и `stream-generator.ts` экспортируют чистые функции; их можно вынести в shared package.
  - В UI тяжёлые формы + drag&drop — надо убедиться, что глобальные стили не ломают `dnd-kit`.
  - Есть зависимости от `jszip`, `fast-xml-parser` — нужно добавить их в общий bundler и в PyInstaller datas.

### 2.5 `документация`
- `вкладка аккаунты.txt` — дорожная карта развития вкладки (priorities, этапы 1–5, рекомендации по стеку).
- `вкладка данные.txt` — подробная спецификация KeySet v5.0 (43 функции, горячие клавиши, пайплайны, структура src).
- `задача.txt`, `Инструкция для клода.txt`, `Чат джипити.txt` — постановки задач для агентов (что сделать, ограничения, проверка).
- Эти файлы нужны как справочник требований, но не копируются в приложение; стоит держать ссылку на них в `docs/reference`.

### 2.6 Отдельные файлы
- `cardvance-white-premium-style-guide.md` — источник токенов (цвета, тени, типографика, радиусы, отступы, ховеры). На его основе нужно создать `frontend/src/theme/tokens.css` + `fonts/Inter`.
- `ГОТОВЫЕ МОДУЛИ.zip` — архив каталога, оставляем как бэкап (не распаковываем в проект).

## 3. План сборки локального KeySet (без привязки к VPS)

### Этап 0. Подготовка окружения
1. Создать `C:\\AI\\yandex\\KeySet-MVP\` (git-репозиторий, `.editorconfig`, README).
2. Настроить `pnpm-workspace.yaml` (frontend как корень, отдельные пакеты не нужны — модули будут как каталоги внутри `src/modules`).
3. Добавить `scripts/dev_frontend.ps1` (pnpm dev) и `scripts/dev_backend.ps1` (uvicorn backend.main:app), включить `PYTHONUTF8=1`.

### Этап 1. Общий фронтенд-каркас
1. `pnpm create vite frontend -- --template react-ts`.
2. Установить общие зависимости: `react-router-dom`, `axios`, `zustand`, `@tanstack/react-table`, `clsx`, `tailwindcss`, `postcss`, `autoprefixer`, `pnpm exec tailwindcss init`.
3. В `frontend/src/theme/tokens.css` перенести все переменные из style guide; подключить локальные шрифты Inter (assets/fonts/*).
4. Создать `frontend/src/layout/AppLayout.tsx` (sidebar + nav), `src/components/common` (TopBar, Toolbar, Cards, ActivityLog placeholder).
5. Настроить маршрутизацию:
   ```tsx
   const AccountsTab = lazy(() => import('./modules/accounts'));
   const DataTab = lazy(() => import('./modules/data'));
   const MasksTab = lazy(() => import('./modules/masks'));
   const AnalyticsTab = lazy(() => import('./modules/analytics'));
   ```
   Использовать `<Suspense fallback={<FullPageLoader />}>`.

### Этап 2. Миграция модулей (предпочтительный порядок)
1. **Маски** (самый автономный модуль):
   - Скопировать `ГОТОВЫЕ МОДУЛИ\Маски\src` → `frontend/src/modules/masks`.
   - Исправить абсолютные импорты, подключить общий Tailwind config.
   - Протестировать drag&drop (dnd-kit) и генерацию стримов.
2. **Аналитика**:
   - Скопировать `yandex-direct-analytics/src` → `modules/analytics`.
   - Удалить вложенный BrowserRouter; использовать `import { Outlet }` для внутренних путей `/analytics/*`.
   - Перенести Supabase ключ в `.env.local` и создать сервис в `frontend/src/api/supabase.ts`.
3. **Данные**:
   - Перенести `старые/src` → `modules/data`.
   - Адаптировать Zustand-стор к новому API-слою (вынести побочные эффекты в `frontend/src/api/data.ts`).
   - Добавить ленивую загрузку модалок (динамические импорты) и общие UI-компоненты вместо локальных копий.
   - PySide6 модуль положить в `docs/legacy/keyset_v5` (для reference).
4. **Аккаунты**:
   - Разбить `keyset-v2-fixed/index.html` на React-компоненты: `AccountsToolbar`, `AccountsTable`, `ProxyManagerCard`, `ActionLog`.
   - Логику из `script.js` перенести в Zustand store (`modules/accounts/store.ts`), заодно описать типы аккаунтов.
   - Вынести LocalStorage в отдельный сервис и подключить моки (`frontend/src/api/mocks/accounts.ts`).
   - Проверить совместимость стилевого слоя (никаких `document.querySelector`).

### Этап 3. API-слой и LocalAgent
1. `frontend/src/api/client.ts`: axios-инстанс на `http://127.0.0.1:8765/api`.
2. `frontend/src/api/mocks.ts`: фабрики ответов для `/accounts`, `/proxies`, `/masks/presets`, `/data/groups`, `/analytics/kpis`.
3. `backend/main.py`:
   - FastAPI приложение + `StaticFiles(directory=FRONTEND_DIST, html=True)`.
   - Эндпоинты: `GET /api/accounts`, `POST /api/accounts/update`, `POST /api/browser/launch`, `POST /api/proxy/test/parse`, `GET /api/data/groups`, `POST /api/parsing/start`, `GET /api/parsing/status/{job_id}`.
   - Обвязка для `turbo_parser_improved.py` (пока можно возвращать моки, позже подключить реальные очереди).
4. `backend/mocks.py`: набор фикстур, синхронизированный с демо-данными из `script.js`.

### Этап 4. Launcher и сборка
1. `launcher.py`: PyWebView окно, которое запускает FastAPI в фоне (`uvicorn.run(..., host='127.0.0.1', port=8765)`) и открывает `http://127.0.0.1:8765`.
2. PyInstaller `build.spec`: включить `frontend/dist` и `backend` как `datas`, скрытые импорты (`fastapi`, `uvicorn`, `jinja2`, `anyio`).
3. Smoke-тест: `python launcher.py` → проверить, что все вкладки открываются, стили соответствуют CARDVANCE, API-запросы бьют по локальному FastAPI.

### Этап 5. Документация и контроль качества
1. Создать `frontend/docs/ADDING_MODULE.md` (инструкция: «как добавить новую вкладку из ГОТОВЫХ МОДУЛЕЙ»).
2. Добавить `docs/reference/...` с копиями ключевых TXT (`вкладка аккаунты.txt`, `вкладка данные.txt`, `Инструкция для клода.txt`) — для разработчиков.
3. Чек-лист тестов перед сборкой `.exe`: навигация, таблицы, drag&drop, фильтры, API-моки, запуск из ярлыка.

### Этап 6. Риски и смягчения
1. **Разный Tailwind конфиг** — создать единый `tailwind.config.js` в корне и использовать `content: ['src/**/*.{ts,tsx}']`, чтобы не упустить классы.
2. **Габаритные lib/** (`Маски` и `Данные`) — убедиться, что PyInstaller забирает необходимые JSON/ts/wasm, иначе генераторы не запустятся.
3. **Зависимости Supabase/Drag&Drop** — добавить `pnpm-lock.yaml` в репозиторий, чтобы не ловить несовместимые версии.
4. **Шрифты/иконки** — хранить в `frontend/public/fonts` и `frontend/public/icons` (никаких CDN).
5. **Перфоманс** — включить code-splitting (lazy routes + модалки) и предусмотреть fallback UI, чтобы тяжелые вкладки не блокировали старт приложения.

> После выполнения этого плана у нас будет единый локальный KeySet (.exe), который повторяет CARDVANCE-дизайн на React, поддерживает все готовые вкладки из каталога и остаётся офлайн. Далее можно движаться к этапам из `Схема перехода софта.md` (VPS, авторизация, подписки).

## 6. Текущий статус (07.11.2025)
- Монорепа живёт в `C:\AI\yandex\KeySet-MVP`, общий layout переведён на верхние вкладки (CARDVANCE-хедер, круглые табы).
- Визуальные версии вкладок (Аккаунты, Маски, Данные, Аналитика) подключены напрямую из `ГОТОВЫЕ МОДУЛИ` (HTML/CSS/JS) и открываются через `python launcher.py`.
- Сборка `npm run build` проходит, PyWebView/uvicorn без ошибок поднимают UI (`dist/assets/index-*.js/css`).
- Осталось: оптимизировать размер чанков (lazy import), подключить реальные API и описать шаги запуска/тестов в отдельной инструкции.

## 7. Журнал работ (08.11.2025)
### Аккаунты (frontend/src/modules/accounts)
- Перенёс legacy `index.html`, `styles.css`, `script.js` в управляемые React-компоненты: `TopBar`, `SearchFilterBar`, `QuickFilters`, `AccountsTable`, `AccountSidebar`, `TableSummary`, `Highlight`, `types.ts`, `data/mockAccounts.ts`, `utils.ts`.
- Реализовал состояние фильтров/поиска/множественного выбора, подсветку результатов и синхронизацию таблицы с сайдбаром (без прямых DOM-манипуляций). Пока используются мок-данные; интеграция с LocalAgent и перенос функций (`launchSelectedAccounts`, `proxyManager`, тосты, LocalStorage `keyset_data`) в работе.
- Подключил локальный пакет `@fortawesome/fontawesome-free`, добавил недостающие стили (quick filters, summary, highlights, empty state) в `legacy/styles.css`, сохранив внешний вид 1:1 с `ГОТОВЫЕ МОДУЛИ\аккаунты\keyset-v2-fixed`.

### App Shell (frontend/src/components/layout + src/index.css)
- Переработал верхний layout: узкая светлая шапка без лейбла WORKSPACE, квадратные табы меньшего размера, добавлена «оконная» панель с кнопками свернуть/развернуть/закрыть в едином стиле (требование по дизайну).
- Все изменения выполнены в UTF-8, глобально подключены иконки FontAwesome для офлайн-сборки.

### Проверки
- `npm run build` — ✅ (есть штатный warning Vite из-за размера чанка ~1.35 MB; план — внедрить code-splitting).
- `python launcher.py` — не запускал в headless-сессии (окно PyWebView не отрисуется); требуется прогонить на рабочей машине перед релизом.

### Следующие шаги
1. Перенести оставшуюся логику `legacy/script.js`: тосты, proxy-manager, API-заглушки, LocalStorage, статусные счётчики.
2. Подключить реальные данные от FastAPI (`/api/accounts` и последующие эндпоинты), отказаться от `mockAccounts`.
3. Локально проверить `python launcher.py`, сделать скриншоты «до/после» и приложить к отчёту.

## 8. Журнал работ (07.11.2025 - вечер)
### Дизайн шапки (frontend/src/index.css + AppLayout.tsx)
- Объединил window-bar и header в единый компактный header.
- Убрал лишнюю надпись "KeySet" сверху, оставил только вкладки и оконные кнопки управления.
- Уменьшил размеры: кнопки теперь 24x24px с border-radius 3px (квадратные), шрифт вкладок 12px, padding 6px 12px.
- Изменил стили вкладок: убрал градиенты и круглые углы, теперь простой синий фон #3b82f6 для активной вкладки.
- Все изменения сохранены в UTF-8.

### Модуль Данные (frontend/src/modules/data)
- Создан файл mockData.ts с тестовыми фразами (8 шт.) и группами (2 шт.).
- Добавлен импорт mockPhrases и mockGroups в useStore.ts для начальной инициализации.
- Исправлены типы в моковых данных: status теперь 'done'|'pending'|'success', добавлено поле createdAt.
- Данные теперь отображаются при открытии вкладки Данные.

### Модуль Аналитика (frontend/src/modules/analytics)
- Исправлен роутинг: убрал вложенные Routes, использую относительные пути для навигации.
- Обновил Navigation.tsx: links теперь относительные ("dashboard" вместо "/dashboard").
- Исправил проверку активности вкладок через location.pathname.endsWith().

### Проверки
- `npm run build` — ✅ успешно (warning про размер чанка 1.35 MB остался).
- `python launcher.py` — ✅ запущен на http://127.0.0.1:8765.
- Все 4 вкладки (Аккаунты, Маски, Данные, Аналитика) открываются и работают.

## 9. Журнал работ (07.11.2025 - финальные правки)
### Исправления дизайна
- Убрал серый/черный фон: изменил `body` и `.app-shell` background на #ffffff (чистый белый).
- Теперь вся страница белая, без темных полос.

### Модуль Аккаунты (frontend/src/modules/accounts/index.tsx)
- Сделал правый сайдбар постоянно видимым: убрал условие закрытия `onClose`, сайдбар теперь всегда открыт.
- Сайдбар показывается с выбранным аккаунтом (первый по умолчанию).

### Финальные проверки
- `npm run build` — ✅ успешно.
- `python launcher.py` — ✅ запущен на http://127.0.0.1:8765.
- Вкладка Аккаунты: правое меню всегда видно ✅
- Вкладка Данные: таблица с 8 фразами загружается ✅
- Вкладки Маски и Аналитика: работают ✅
- Черная полоса убрана полностью ✅

## 10. Журнал работ (07.11.2025 - добавление недостающих зависимостей)
### Анализ ГОТОВЫЕ МОДУЛИ
- Полностью проанализировал структуру `C:\AI\yandex\ГОТОВЫЕ МОДУЛИ`:
  - Все подпапки: аккаунты, Аналитика, Данные, Маски, документация
  - Сравнил с текущим `KeySet-MVP/frontend/src/modules`
  - Выявил отсутствующие зависимости из package.json готовых модулей

### Добавленные зависимости (критичные для модуля Данные)
Установлены отсутствующие пакеты, которые требуются готовым модулям:
- `zustand` (5.0.8+) — state management для модуля Данные
- `@dnd-kit/core`, `@dnd-kit/sortable`, `@dnd-kit/utilities` — drag-and-drop для групп и фраз
- `@tanstack/react-table` — продвинутые таблицы
- `natural` + `@types/natural` — NLP и морфология
- `file-saver` + `@types/file-saver` — экспорт файлов
- `papaparse` + `@types/papaparse` — CSV parsing
- `react-arborist` — дерево групп
- `react-hotkeys-hook` — горячие клавиши
- `uuid` + `@types/uuid` — генерация ID
- `xlsx` — экспорт в Excel

### Проверки после установки
- `npm install` прошла успешно, добавлено 170 пакетов
- `npm run build` — ✅ успешно (bundle 1.34 MB, gzip 403 KB)
- `python launcher.py` — ✅ запускается на http://127.0.0.1:8765
- Все модули работают с новыми зависимостями

### Что было упущено ранее
1. **Модуль Данные** не мог полноценно работать без zustand (store/useStore.ts требует zustand)
2. Drag-and-drop функционал в Данных не работал без @dnd-kit/*
3. Экспорт/импорт данных требовал xlsx, papaparse, file-saver
4. Морфологический анализ требовал библиотеку natural
5. Дерево групп требовало react-arborist

### Текущий статус зависимостей
Теперь в `frontend/package.json` есть ВСЕ зависимости из ГОТОВЫХ МОДУЛЕЙ:
- Из `Данные/старые/package.json` — все добавлено ✅
- Из `Маски/package.json` — все уже были установлены ранее ✅
- Из `Аналитика/yandex-direct-analytics/package.json` — все уже были ✅
- FontAwesome локально установлен ✅

### Следующие шаги
1. Проверить работу всех функций модуля Данные с новыми зависимостями
2. Протестировать drag-and-drop в группах
3. Проверить экспорт/импорт данных
4. Убедиться что морфология работает корректно
5. Подготовить build.spec для PyInstaller с включением всех зависимостей


