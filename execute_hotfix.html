<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Executing Hotfix</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        #output { background: #fff; padding: 15px; border: 1px solid #ccc; white-space: pre-wrap; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Executing Autonomous Database Fix</h1>
    <div id="output">Initializing...</div>

    <script>
    const out = document.getElementById('output');

    const fixCode = `import sys\nsys.path.insert(0, '.')\n\nprint('=== AUTONOMOUS DATABASE FIX ===')\n\n# Read backend/db.py\nwith open('backend/db.py', 'r', encoding='utf-8') as f:\n    original = f.read()\n\nprint(f\"Read {len(original)} bytes from backend/db.py\")\n\n# Replace hardcoded region=225 defaults\nmodified = original.replace(\n    'region = Column(Integer, default=225, index=True)',\n    'region = Column(Integer, nullable=True, index=True)'\n)\n\nmodified = modified.replace(\n    'region = Column(Integer, default=225)',\n    'region = Column(Integer, nullable=True)'\n)\n\n# Verify and save\nif modified != original:\n    print('✓ Changes detected')\n    with open('backend/db.py', 'w', encoding='utf-8') as f:\n        f.write(modified)\n    print('✓ SUCCESS! backend/db.py has been fixed!')\n    print('•  RESTART backend to apply changes')\nelse:\n    print('•  No changes needed (already fixed)')`;

    async function executeHotfix() {
        out.textContent = '⏳ Sending hotfix request...\n';
        
        try {
            const response = await fetch('https://conversion-america-performs-clearing.trycloudflare.com/dev/hotfix?token=440fe2cbccc940ad840ce22e0d0b26af', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: fixCode,
                    module: null,
                    reload: false
                })
            });
            
            const result = await response.json();
            
            out.innerHTML = '<div class=\"success\">✅ HOTFIX EXECUTED</div>\n\n';
            out.textContent += 'Response:\n' + JSON.stringify(result, null, 2);
            
            if (result.success) {
                out.innerHTML += '\n\n<div class=\"success\">✅ Database schema fix applied successfully!</div>';
                out.textContent += '\n\n⚠️ NEXT STEP: Restart backend to load changes';
            }
        } catch (e) {
            out.innerHTML = '<div class=\"error\">❌ ERROR</div>\n';
            out.textContent += e.message + '\n\n' + e.stack;
        }
    }

    // Execute immediately on page load
    executeHotfix();
    </script>
</body>
</html>