# 07. –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ KeySet-MVP

> **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–≥–∏–æ–Ω–∞–º–∏: 4414+ –≥–µ–æ, CDP-–ø–∞—Ç—á–∏–Ω–≥, GeoSelector –≤–∏–¥–∂–µ—Ç**

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–¶–µ–ª—å](#—Ü–µ–ª—å)
- [–î–ª—è –∫–æ–≥–æ](#–¥–ª—è-–∫–æ–≥–æ)
- [–°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã](#—Å–≤—è–∑–∞–Ω–Ω—ã–µ-–¥–æ–∫—É–º–µ–Ω—Ç—ã)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≥–µ–æ—Å–∏—Å—Ç–µ–º—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–≥–µ–æ—Å–∏—Å—Ç–µ–º—ã)
- [–î–∏–∞–≥—Ä–∞–º–º–∞](#–¥–∏–∞–≥—Ä–∞–º–º–∞)
- [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ regions.json](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-regionsjson)
- [–°–Ω–∏–ø–ø–µ—Ç—ã –∫–æ–¥–∞](#—Å–Ω–∏–ø–ø–µ—Ç—ã-–∫–æ–¥–∞)
- [–¢–∏–ø–æ–≤—ã–µ –æ—à–∏–±–∫–∏](#—Ç–∏–ø–æ–≤—ã–µ-–æ—à–∏–±–∫–∏)
- [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](#–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)
- [TL;DR](#tldr)
- [–ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è](#—á–µ–∫-–ª–∏—Å—Ç-–ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è)

---

## –¶–µ–ª—å

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã KeySet-MVP: –¥–µ—Ä–µ–≤–æ –∏–∑ 4414+ —Ä–µ–≥–∏–æ–Ω–æ–≤ Yandex, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ region_id –≤ API –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ CDP, UI –≤–∏–¥–∂–µ—Ç –≤—ã–±–æ—Ä–∞ —Ä–µ–≥–∏–æ–Ω–∞.

## –î–ª—è –∫–æ–≥–æ

- Frontend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏, —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å GeoSelector
- Backend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è CDP-–ø–∞—Ç—á–∏–Ω–≥–∞
- QA –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Ä–µ–≥–∏–æ–Ω–æ–≤
- Product managers –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è coverage

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [06_PARSING.md](./06_PARSING.md) ‚Äî –ø–∞—Ä—Å–∏–Ω–≥ —Å —É—á–µ—Ç–æ–º —Ä–µ–≥–∏–æ–Ω–∞
- [11_DATA_FLOW.md](./11_DATA_FLOW.md) ‚Äî –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö —Å —Ä–µ–≥–∏–æ–Ω–æ–º
- [08_FRONTEND_STRUCTURE.md](./08_FRONTEND_STRUCTURE.md) ‚Äî UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≥–µ–æ—Å–∏—Å—Ç–µ–º—ã

```mermaid
graph TD
    A[regions.json 4414+ —Ä–µ–≥–∏–æ–Ω–æ–≤] -->|–∑–∞–≥—Ä—É–∑–∫–∞| B[Backend GeoService]
    A -->|–∑–∞–≥—Ä—É–∑–∫–∞| C[Frontend GeoStore]
    
    B -->|API| D[/api/regions]
    C -->|–≤–∏–¥–∂–µ—Ç| E[GeoSelector UI]
    
    E -->|–≤—ã–±–æ—Ä| F[region_id]
    F -->|–ø–µ—Ä–µ–¥–∞—á–∞| G[–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–¥–∞—á–∞]
    
    G -->|–∑–∞–ø—É—Å–∫| H[TurboParser]
    H -->|CDP –ø–µ—Ä–µ—Ö–≤–∞—Ç| I[Browser Tab]
    
    I -->|–ø–∞—Ç—á–∏–Ω–≥| J[Yandex API –∑–∞–ø—Ä–æ—Å]
    J -->|lr=region_id| K[?lr=213&text=—Ñ—Ä–∞–∑–∞]
    
    K -->|–∑–∞–ø—Ä–æ—Å| L[Yandex Wordstat]
    L -->|—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —Ä–µ–≥–∏–æ–Ω–∞| M[freq_results]
```

---

## –î–∏–∞–≥—Ä–∞–º–º–∞

**–ü–æ—Ç–æ–∫ –≤—ã–±–æ—Ä–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ä–µ–≥–∏–æ–Ω–∞:**

```mermaid
sequenceDiagram
    participant UI as GeoSelector UI
    participant Store as Zustand Store
    participant API as FastAPI /api/wordstat
    participant Parser as TurboParser
    participant CDP as Chrome CDP
    participant YA as Yandex API
    
    UI->>Store: selectRegion(213)
    Store->>Store: update region_id
    UI->>API: POST /start {region_id: 213}
    API->>Parser: init with region_id
    Parser->>CDP: enable Network intercept
    CDP->>CDP: modify request URL
    CDP->>YA: add ?lr=213&region=213
    YA-->>CDP: data for Moscow region
    CDP-->>Parser: parsed results
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ regions.json

```json
{
  "regions": [
    {
      "id": 213,
      "name": "–ú–æ—Å–∫–≤–∞",
      "parent_id": 1,
      "type": "city"
    },
    {
      "id": 2,
      "name": "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
      "parent_id": 10174,
      "type": "city"
    }
  ]
}
```

---

## –°–Ω–∏–ø–ø–µ—Ç—ã –∫–æ–¥–∞

### GeoSelector –≤–∏–¥–∂–µ—Ç

```python
# —Ñ–∞–π–ª: keyset/app/widgets/geo_selector.py:98-132
def normalize_regions_tree(raw_root: dict) -> RegionModel:
    """–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–π JSON –≤ –ø–ª–æ—Å–∫–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏."""

    flat: List[RegionRow] = []
    by_id: Dict[int, RegionRow] = {}
    children: Dict[int, List[int]] = {}

    def walk(node: dict, trail: List[str], depth: int, parent_id: Optional[int]) -> None:
        try:
            node_id = int(node["value"])
        except (KeyError, TypeError, ValueError):
            return
        label = str(node.get("label") or "").strip()
        if not label:
            return

        branch = trail + [label]
        row = RegionRow(
            id=node_id,
            name=label,
            path=" / ".join(branch),
            parent_id=parent_id,
            depth=depth,
        )
        flat.append(row)
        by_id[node_id] = row
        if parent_id is not None:
            children.setdefault(parent_id, []).append(node_id)

        for child in node.get("children") or []:
            walk(child, branch, depth + 1, node_id)

    walk(raw_root, [], 0, None)
    return RegionModel(flat=flat, by_id=by_id, children=children)
```

### CDP –ø–∞—Ç—á–∏–Ω–≥ region –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

```python
# —Ñ–∞–π–ª: keyset/workers/cdp_frequency_runner.py:125-151
def replay_export_http(self, masks: list[str], export_url_template: str, region: int = 225) -> list[dict]:
    """
    –†–µ–ø–ª–µ–∏–º –∑–∞–ø—Ä–æ—Å —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –º–∞—Å–∫–∏ —á–µ—Ä–µ–∑ HTTP
    –ë–ï–ó –±—Ä–∞—É–∑–µ—Ä–∞! –í 10 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ!
    """
    import time
    import random
    
    if not self.session:
        raise RuntimeError("HTTP session not initialized")
    
    results = []
    
    for idx, mask in enumerate(masks, 1):
        # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –º–∞—Å–∫—É –≤ URL
        url = export_url_template.replace("{q}", quote(mask))
        url = re.sub(r'words=[^&]*', f'words={quote(mask)}', url)
        
        try:
            resp = self.session.get(url, timeout=30)
            
            if resp.status_code == 200 and "csv" in resp.headers.get("content-type", ""):
                # –ü–∞—Ä—Å–∏–º CSV
                freq = self._parse_csv_response(resp.text, mask)
```

### –ó–∞–≥—Ä—É–∑–∫–∞ regions.json

```python
# —Ñ–∞–π–ª: keyset/app/widgets/geo_selector.py:88-95
def _load_raw_tree(dataset_path: Path) -> dict:
    if dataset_path.exists():
        try:
            return json.loads(dataset_path.read_text(encoding="utf-8"))
        except (OSError, json.JSONDecodeError):
            pass
    return _DEFAULT_TREE
```

### GeoTree toggle logic

```python
# —Ñ–∞–π–ª: keyset/app/widgets/geo_selector.py:148-174
def toggle_region(
    selection: Set[int],
    region_id: int,
    checked: bool,
    model: RegionModel,
) -> Set[int]:
    updated = set(selection)

    def drop_descendants(node_id: int) -> None:
        for child_id in model.children.get(node_id, []):
            updated.discard(child_id)
            drop_descendants(child_id)

    def drop_ancestors(node_id: int) -> None:
        parent = model.by_id.get(node_id).parent_id if node_id in model.by_id else None
        while parent is not None:
            updated.discard(parent)
            parent = model.by_id.get(parent).parent_id if parent in model.by_id else None

    if checked:
        updated.add(region_id)
        drop_descendants(region_id)
        drop_ancestors(region_id)
    else:
        updated.discard(region_id)

    return updated
```

---

## –¢–∏–ø–æ–≤—ã–µ –æ—à–∏–±–∫–∏ / –ö–∞–∫ —á–∏–Ω–∏—Ç—å

### ‚ùå –û—à–∏–±–∫–∞: "Region not found"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π region_id –ø–µ—Ä–µ–¥–∞–Ω –≤ API.

**–ö–∞–∫ —á–∏–Ω–∏—Ç—å:**
1. –ù–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ –ø–µ—Ä–µ–¥ POST /start –≤—ã–∑—ã–≤–∞–π—Ç–µ `useGeoStore.getState().ensureRegion()` ‚Äî –æ–Ω –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –≤—ã–±–æ—Ä.
2. –í backend middleware –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ, —á—Ç–æ `region_id` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ `load_region_model(Path('data/regions_tree_full.json'))`; –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ 422.
3. –í –ª–æ–≥–∞—Ö `backend/routers/wordstat.py` –≤–∫–ª—é—á–∏—Ç–µ –ø–æ–∏—Å–∫ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∏ –ø—É—Å—Ç—ã—Ö –ø—É—Ç–µ–π, —á—Ç–æ–±—ã –≤—ã—è–≤–∏—Ç—å –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω–æ–µ –¥—Ä–µ–≤–æ.

### ‚ùå –û—à–∏–±–∫–∞: "CDP –Ω–µ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç region"

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–µ—Ä–µ—Ö–≤–∞—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø–æ—Å–ª–µ navigate.

**–ö–∞–∫ —á–∏–Ω–∏—Ç—å:**
1. –ù–∞–≤–µ—à–∏–≤–∞–π—Ç–µ `page.on("response", ...)` –∏ `page.route` –¥–æ –ø–µ—Ä–≤–æ–≥–æ `page.goto`.
2. –î–æ–±–∞–≤—å—Ç–µ `await page.wait_for_load_state("networkidle")` –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `region` –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ `export_url_template`.
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø—Ä–∏ —Ä–µ–ø–ª–µ–µ `replay_export_http` –ø–∞—Ä–∞–º–µ—Ç—Ä `regions=...` –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

### ‚ùå –û—à–∏–±–∫–∞: "–ù–µ–≤–µ—Ä–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —Ä–µ–≥–∏–æ–Ω–∞"

**–ü—Ä–∏—á–∏–Ω–∞:** –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Yandex –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ cookies.

**–ö–∞–∫ —á–∏–Ω–∏—Ç—å:**
1. –ü–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω—ã–º –∑–∞–ø—É—Å–∫–æ–º –≤—ã–ø–æ–ª–Ω—è–π—Ç–µ `context.clear_cookies()` –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —á–µ—Ä–µ–∑ `_extract_profile_cookies`.
2. –î–æ–±–∞–≤–ª—è–π—Ç–µ –≤ URL –ø–∞—Ä–∞–º–µ—Ç—Ä –∫—ç—à-–±–∞—Å—Ç–µ—Ä–∞: `rand=int(time.time())`.
3. –†–æ—Ç—É–π—Ç–µ User-Agent –≤ `self.session.headers` (`build_http_session`) –∏ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ, —á—Ç–æ –∫—É–∫–∏ —Å–≤–µ–∂–∏–µ.

---

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤

```python
from keyset.services.geo_service import GeoService

geo = GeoService()
regions = geo.get_all_regions()
print(f"Loaded {len(regions)} regions")
```

### 2. –í—ã–±–æ—Ä —Ä–µ–≥–∏–æ–Ω–∞ –≤ UI

```typescript
import { useGeoStore } from '@/stores/geo';

const { selectedRegion, setRegion } = useGeoStore();

// –í—ã–±—Ä–∞—Ç—å –ú–æ—Å–∫–≤—É
setRegion(213);
```

### 3. –ü–∞—Ä—Å–∏–Ω–≥ —Å —Ä–µ–≥–∏–æ–Ω–æ–º

```python
task_id = await manager.start_parsing(
    phrases=["–∫—É–ø–∏—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É"],
    account_ids=[1],
    region_id=213  # –ú–æ—Å–∫–≤–∞
)
```

---

## TL;DR

- **4414+ —Ä–µ–≥–∏–æ–Ω–æ–≤** ‚Äî –ø–æ–ª–Ω–æ–µ –¥–µ—Ä–µ–≤–æ Yandex –≥–µ–æ–ª–æ–∫–∞—Ü–∏–π
- **CDP-–ø–∞—Ç—á–∏–Ω–≥** ‚Äî –∞–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ lr/region –≤ API –∑–∞–ø—Ä–æ—Å—ã
- **GeoSelector UI** ‚Äî —É–¥–æ–±–Ω—ã–π –≤–∏–¥–∂–µ—Ç –≤—ã–±–æ—Ä–∞ —Ä–µ–≥–∏–æ–Ω–∞
- **regions.json** ‚Äî –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è –≥–µ–æ
- **–í–∞–ª–∏–¥–∞—Ü–∏—è** ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ region_id –Ω–∞ frontend –∏ backend

---

## –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

- [ ] regions.json –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] GeoSelector –≤–∏–¥–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω –≤ UI
- [ ] CDP –ø–µ—Ä–µ—Ö–≤–∞—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–µ–≥–∏–æ–Ω–∞
- [ ] region_id –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –≤—Å–µ —Å–ª–æ–∏ (UI ‚Üí API ‚Üí Parser)
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è region_id —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- [ ] –¢–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç —Ä–∞–∑–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ region_id –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö
- [ ] Fallback –Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ä–µ–≥–∏–æ–Ω –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
- [ ] UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–µ–≥–∏–æ–Ω
- [ ] –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Å region_id

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-01-17

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** [08_FRONTEND_STRUCTURE.md](./08_FRONTEND_STRUCTURE.md) ‚Äî –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
