# Памятка Codex (UTF-8)\

Пиши на русском

Всегда работай через кодировку UTF-8, если где видишь кракозябры исправляй чтобы их небыло и было все на русском в правильной UTF-8 кодировке, я запрещаю тебе работать в других кодировках.

Всегда пушь в хаб измененные файлы

Анализируй чат что сделал и веди отчет, не пропускай то что ты сделал и описал в чете, этого мало и нужно писать в отчет - это важно, чтобы ты и другие ии видели что и как ты делал

Обязательно анализируй что я пишу в чате (мои потребности) и добавляй в `C:\AI\yandex\бд\инструкции\Архитектура\Задачи\Новое\Аккаунты\задачи\Задача по аккаунтам.md` все задачи, а в `C:\AI\yandex\бд\инструкции\Архитектура\Задачи\Новое\Аккаунты\задачи\Мои потребности.md` — сами потребности. После правок по вкладке «Аккаунты» обновляй отчёты `C:\AI\yandex\бд\инструкции\Архитектура\Задачи\Новое\Аккаунты\отчеты\ЧТО УЖЕ СДЕЛАЛ.md` и `C:\AI\yandex\бд\инструкции\Архитектура\Задачи\Новое\Аккаунты\отчеты\Что осталось сделать.md`.

# КРИТИЧНО: НЕ ОСТАНАВЛИВАЙСЯ

1. НЕ ПИШИ "Finished working"
2. НЕ СПРАШИВАЙ "что дальше?"
3. НЕ ОТЧИТЫВАЙСЯ после каждого шага
4. ПРОСТО ДЕЛАЙ ЗАДАЧУ ДО КОНЦА

Если нужна помощь — я сам спрошу.


## 0. Последовательность действий
1. Прочитать `C:\AI\yandex\бд\инструкции\Архитектура\Задачи\Новое\загрузка софта` (последовательно проходи все файлы — первый раз или когда у тебя «обнулилась» память по логике софта).
2. Прочитать `C:\AI\yandex\бд\инструкции\Архитектура\Задачи\Новое\ARCHITECTURE` (последовательно все файлы — чтобы понимать общую архитектуру).
3. Прочитать `C:\AI\yandex\бд\инструкции\Архитектура\Задачи\Новое\Аккаунты\задачи` и `C:\AI\yandex\бд\инструкции\Архитектура\Задачи\Новое\Аккаунты\отчеты` — это локальная «память» именно по вкладке «Аккаунты».
3. Выбрать модуль → перенести исходники → настроить зависимости.
4. Проверить build + launcher.
5. Обновить `ГОТОВЫЕ_МОДУЛИ_план.md`.
6. Проверить заново эту памятку и C:\AI\yandex\бд\инструкции\Архитектура\Задачи\Новое\Аккаунты\задачи перед сдачей задачи.
Файл проверяю **перед стартом** любой правки и **после завершения** работы.

## 1. Базовые правила
- **Строго UTF-8** для всех файлов (`Set-Content -Encoding UTF8`, `Get-Content -Encoding UTF8`).
- Перед действиями читаю `C:\AI\yandex\бд\инструкции\Архитектура\Задачи\Новое\загрузка софта` и общий отчёт `C:\AI\yandex\бд\инструкции\Архитектура\Задачи\Отчет\ЧТО УЖЕ СДЕЛАЛ.md`, а также актуальные файлы в `…\Аккаунты\задачи` и `…\Аккаунты\отчеты`.
- После изменений по вкладке «Аккаунты» обновляю отчёты: глобальный `бд/инструкции/Архитектура/Задачи/Отчет/ГОТОВЫЕ_МОДУЛИ_план.md` и локальный `…\Аккаунты\отчеты\ЧТО УЖЕ СДЕЛАЛ.md`.



## 2. Работа с ГОТОВЫМИ МОДУЛЯМИ - МОДУЛИ ЧАСТИЧНО ПОДКЛЮЧЕНЫ (НЕ ДЕЛАЙ ЗАМЕНЯЙ ТО ЧТО УЖЕ РАБОТАЕТ) это означает, что React UI готов, но backend логика (API адаптеры) ещё требует интеграции
- **НЕ СОЗДАЮ UI с нуля.
- Подключаю **все зависимости** из исходного `package.json` (jszip, fast-xml-parser, Supabase и т.д.).
- Никаких `@ts-nocheck`, пока не пойму и не настрою типы. Если нужен временный `ts-nocheck`, фиксирую таск в плане.

## 3. Перед коммитом/отчётом
- Проверяю:
  1. `npm run build`
  2. `python launcher.py`
  3. UI совпадает с исходным HTML/CSS (`ГОТОВЫЕ МОДУЛИ/<модуль>/index.html`) – сверка по структуре и стилям.
- Обновляю `ГОТОВЫЕ_МОДУЛИ_план.md` (что сделал, что осталось).
- Если что-то не так — фиксирую в этом файле и в отчёте.

## 4. Типичные ошибки (запрещено)
- Игнорировать готовые HTML/CSS → **нельзя**.
- Писать стили/структуру “по памяти” → **нельзя**.
- Пропускать инструкции/доки перед стартом → **нельзя**.
- Оставлять неподтверждённые предположения в коде/ответах → **нельзя**.

## 5. Последовательность действий
1. Прочитать `C:\AI\yandex\бд\инструкции\Архитектура\Задачи\Новое\загрузка софта`.
2. Прочитать эту памятку.
3. Выбрать модуль → перенести исходники → настроить зависимости.
4. Проверить build + launcher.
5. Обновить `ГОТОВЫЕ_МОДУЛИ_план.md`.
5. После правок по вкладке «Аккаунты» сначала фиксировать изменения в `C:\AI\yandex\бд\инструкции\Архитектура\Задачи\Новое\Аккаунты\отчеты\ЧТО УЖЕ СДЕЛАЛ.md`, а при необходимости синхронизировать краткое резюме в общем `C:\AI\yandex\бд\инструкции\Архитектура\Задачи\Отчет\ЧТО УЖЕ СДЕЛАЛ.md`.
6. Проверить заново эту памятку перед сдачей задачи.

## 6. ЖЁСТКИЕ ПРАВИЛА ПО ЛОГИКЕ (НЕ ПЕРЕПИСЫВАТЬ)

### Что МОЖНО
- Копировать готовые файлы/модули из `C:\AI\yandex\KeySet-MVP\keyset\` и других legacy-папок в `C:\AI\yandex\KeySet-MVP\backend\...` / `frontend\...`.
- Менять импортЫ в **новом** проекте (`KeySet-MVP`), чтобы они указывали на новые копии модулей.
- Добавлять минимальные адаптеры:
  - FastAPI-роутеры, которые вызывают готовые функции (`wordstat_bridge.collect_frequency`, `accounts.get_accounts`, и т.п.).
  - Тонкие обёртки без новой бизнес-логики.

### Что НЕЛЬЗЯ
- Писать НОВУЮ реализацию логики, если уже есть готовый модуль в `keyset/` или других legacy-каталогах.
- Редактировать файлы внутри `C:\AI\yandex\KeySet-MVP\keyset\` (они read-only).
- Придумывать новые схемы БД, новые таблицы и новые API вместо уже существующих.
- Дублировать логику частотки, гео, аккаунтов, прокси – для этого уже есть модули в `keyset/services/...`.

### Если хочешь написать НОВУЮ функцию
1. Сначала ищешь по проекту (`keyset/`, `backend/`) по ключевым словам.
2. Если находишь готовую реализацию — используешь её через копирование и адаптер.
3. Если не находишь — фиксируешь это в `ЧТО УЖЕ СДЕЛАЛ.md` и только потом пишешь новую функцию.

---

## 7. ГРАНИЦЫ ПРАВОК

- Рабочая директория: **Только** `C:\AI\yandex\KeySet-MVP\...`.
- Каталог `C:\AI\yandex\KeySet-MVP\keyset\`:
  - ТОЛЬКО источник для копирования.
  - Запрещено редактировать файлы внутри, добавлять новые, менять структуру.
- Если нужно изменить логику из `keyset\...`:
  1. Скопируй файл в новую папку проекта (например, `backend\keyset\services\...`).
  2. Подключи КОПИЮ в новых импортАх.
  3. Меняй только копию.

---

## 8. API/АДАПТЕРЫ

- Новые роутеры FastAPI – только тонкие обёртки над уже существующими функциями из `keyset/`.
- Внутри роутера:
  - минимум логики: валидация входных данных, вызов функции, упаковка ответа.
  - **запрещено** писать там бизнес-логику, циклы обработки БД и т.д.
- Пример правильного адаптера:

```python
from fastapi import APIRouter
from keyset.services.wordstat_bridge import collect_frequency

router = APIRouter()

@router.post("/wordstat/collect")
def wordstat_collect(payload: CollectRequest):
    results = collect_frequency(
        payload.phrases,
        modes=payload.modes.enabled(),
        regions=payload.regions,
        profile=payload.profile,
    )
    return results
    
# КРИТИЧНО: НЕ ОСТАНАВЛИВАЙСЯ

1. НЕ ПИШИ "Finished working"
2. НЕ СПРАШИВАЙ "что дальше?"
3. НЕ ОТЧИТЫВАЙСЯ после каждого шага
4. ПРОСТО ДЕЛАЙ ЗАДАЧУ ДО КОНЦА

Если нужна помощь — я сам спрошу.


## 9. ПЛАН ПЕРЕД ЛЮБЫМИ ПРАВКАМИ

Перед тем как менять код или файлы, ТЫ ОБЯЗАН:

1. Составить короткий ПЛАН в формате чеклиста:
   - [ ] какие файлы будешь ЧИТАТЬ;
   - [ ] какие файлы будешь МЕНЯТЬ;
   - [ ] какие команды запустишь (build, тесты, скрипты);
   - [ ] какие доки/отчёты обновишь.

2. ЯВНО перечислить:
   - список файлов, которые МОЖНО трогать в этой задаче;
   - явно отметить, какие связанные файлы ОСОЗНАННО НЕ трогаешь.

3. Не начинать писать код, пока план не согласован (или явно не понятен из задачи).

---

## 10. ФОРМАТ ИЗМЕНЕНИЙ (МИНИМАЛЬНЫЙ DIFF)

1. ВСЕГДА вноси минимально необходимые изменения:
   - не переписывай файл целиком, если можно обойтись точечным diff;
   - не меняй форматирование/импорты/имена, если это не часть задачи;
   - не добавляй «рефакторинг по пути», если я об этом отдельно не просил.

2. НЕЛЬЗЯ:
   - трогать файлы вне списка разрешённых для этой задачи;
   - менять соседнюю логику "за компанию";
   - заводить новые API/структуры данных, если задача — только перенос готового кода.

3. Если понимаешь, что для решения задачи нужно менять СЛИШКОМ МНОГО файлов — ОСТАНОВИСЬ и явно опиши мне:
   - какие зависимости блокируют решение;
   - как лучше разрезать это на несколько задач.

---

## 11. ТЕСТЫ И ПРОВЕРКИ ПОСЛЕ БЛОКА ПРАВОК

После каждого ЗАВЕРШЁННОГО блока работы (не после каждой строчки) ты ОБЯЗАН:

1. Запустить проверки:
   - frontend: `npm run build`;
   - backend/launcher: `python launcher.py`;
   - при необходимости — тестовые скрипты/утилиты, которые описаны в доках по этому модулю.

2. Если что-то падает:
   - сначала разберись и почини;
   - только потом считай задачу выполненной.

3. В `ЧТО УЖЕ СДЕЛАЛ.md` кратко записывай:
   - какие команды запускал;
   - что прошло успешно;
   - какие ошибки были и как их устранил.

---

## 12. САМОПРОВЕРКА ПЕРЕД СДАЧЕЙ

Перед тем как считать задачу завершённой, ПРОЙДИСЬ ПО ЧЕКЛИСТУ:

- [ ] План из пункта 9 выполнен полностью.
- [ ] Не трогал файлы вне разрешённого списка.
- [ ] Нет случайных изменений (форматирование, переименования без причины).
- [ ] Все проверки из пункта 11 успешно прошли.
- [ ] Обновлены `ГОТОВЫЕ_МОДУЛИ_план.md` и `ЧТО УЖЕ СДЕЛАЛ.md` по факту.

Если что-то осталось недоделано из-за лимитов/ошибок:
- явно перечисли, ЧТО не успел и ПОЧЕМУ;
- предложи следующий шаг как отдельную задачу.

## КАК Я СТАВЛЮ ТЕБЕ ЗАДАЧИ

Всегда считай, что задача состоит минимум из трёх частей:

1. КОНТЕКСТ
   - Коротко: какая фича/баг, в какой вкладке/сценарии KeySet-MVP.
   - Ссылки на md-доки, которые нужно прочитать перед началом:
     - docs/АРХИТЕКТУРА/*.md
     - docs/ПАРСИНГ/*.md
     - docs/ГОТОВЫЕ_МОДУЛИ_план.md
     - docs/ЧТО УЖЕ СДЕЛАЛ.md
   - Если я дал ссылку на документ — ОБЯЗАТЕЛЬНО прочитай и используй его как источник правды.

2. ОБЛАСТЬ РАБОТЫ
   - Я ВСЕГДА буду перечислять:
     - какие файлы МОЖНО трогать,
     - какие файлы НЕЛЬЗЯ трогать.
   - Если в задаче это не прописано — СПРОСИ уточнения, прежде чем что-то менять.

3. ОЖИДАЕМЫЙ РЕЗУЛЬТАТ
   - Что именно должно измениться с точки зрения поведения:
     - пример входных данных,
     - пример ожидаемого результата/скрина,
     - какие статусы/ошибки считаются нормой.
   - Если результат непонятен — сначала уточни, а не придумывай сам.
🔹 Блок: План перед правками
Это как раз рекомендация из гайда Anthropic: сначала план, потом код.

md
Копировать код
## ПЛАН ПЕРЕД ЛЮБЫМИ ПРАВКАМИ

Перед тем как менять КОД или ФАЙЛЫ, ты ОБЯЗАН:

1. Составить короткий ПЛАН из 3–10 шагов в формате чеклиста:
   - [ ] какие файлы прочитаешь,
   - [ ] какие файлы изменишь,
   - [ ] какие команды запустишь (build, тесты, скрипты),
   - [ ] какие доки/комменты обновишь.

2. ОТДЕЛЬНО перечисли:
   - Файлы, КОТОРЫЕ БУДУТ ИЗМЕНЕНЫ.
   - Файлы, которые специально НЕ трогаешь, хотя они связаны с задачей.

3. Явно напиши:
   - "НЕ НАЧИНАЮ ПИСАТЬ КОД, пока ты не подтвердил план".

ЖДУ моего подтверждения плана. Только после подтверждения начинаешь вносить изменения.
🔹 Блок: Как именно менять файлы (минимальный diff, без разрушения архитектуры)
Тут опираемся на практику apply_patch/diff-форматов для LLM и твой опыт, что Codex любит переписать полфайла.

md
Копировать код
## ПРАВИЛА ИЗМЕНЕНИЯ КОДА

1. ВСЕГДА работай через патчи (diff), а НЕ переписывай файл целиком.
   - Изменяй только те строки, которые реально нужны под задачу.
   - Не меняй форматирование/стили/импорты, если это не часть задачи.

2. НИКОГДА не:
   - создавай новые "универсальные" data API, если уже есть готовые модули в keyset/;
   - придумывай новые схемы парсинга, если есть рабочий TurboParser и связка воркеров;
   - меняй архитектуру без прямого запроса в задаче.

3. Если видишь, что для решения задачи нужно трогать СЛИШКОМ МНОГО файлов:
   - ОСТАНОВИСЬ,
   - напиши мне: какие зависимости блокируют решение,
   - предложи, как разрезать работу на несколько отдельных задач.

4. Любая "оптимизация" или "рефакторинг" допускается ТОЛЬКО:
   - если я явно попросил об этом в задаче,
   - или если ты сначала предложил план рефакторинга и получил мой ОК.
🔹 Блок: Тесты и проверки после каждой задачи
Из статей по вайб-кодингу и практики Codex: просить модель писать тесты и явно гонять проверки после каждого блока.

md
Копировать код
## ТЕСТЫ И ПРОВЕРКИ — ОБЯЗАТЕЛЬНО

После ЛЮБОГО изменения логики ты ОБЯЗАН:

1. Написать или обновить тесты:
   - unit / интеграционные — если логика backend'а;
   - e2e / smoke — если меняется связка фронт+backend.
   - Если тесты неуместны (чистый UI-косметоз) — напиши, ПОЧЕМУ ты их не пишешь.

2. Запустить проверки:
   - frontend: npm run build
   - backend/воркеры: указанные в доках команды (парсинг, cron, тестовые скрипты)
   - если команда завершилась с ошибкой — сначала разберись и почини, затем продолжай.

3. В конце задачи дать КРАТКИЙ отчёт:
   - какие команды были выполнены;
   - что прошло успешно;
   - какие ошибки были и как ты их починил.
(Это не противоречит твоему «не отчитывайся после каждого микрошагa» — это отчёт после блока, а не после каждой строчки.)

🔹 Блок: Работа с docs/ и «памятью» проекта
Опираемся на советы «документируй архитектуру в md и обновляй по факту», плюс опыт, что народ хранит большие agent-файлы и Codex их уважает.

md
Копировать код
## ДОКИ — ТАКИЕ ЖЕ ВАЖНЫЕ, КАК КОД

1. Всегда считай docs/*.md и ПАМЯТКА_Codex.md частью кода проекта.

2. Если ты:
   - перенёс модуль,
   - поменял схему работы парсинга,
   - изменил GEO/региональную логику,
   - поменял формат данных, статусы, пути,

   ТО ОБЯЗАТЕЛЬНО:
   - обнови соответствующий md-файл в docs/ или добавь новый раздел;
   - добавь короткую заметку в ЧТО УЖЕ СДЕЛАЛ.md.

3. Если в доках написано одно, а в коде другое:
   - НЕ придумывай свою третью версию.
   - Вынеси расхождение в явный список:
     - что говорит код,
     - что написано в доке,
     - как ты предлагаешь синхронизировать.
   - Дальше либо правь код по доку, либо док по коду, но не молча.
🔹 Блок: Самопроверка Codex перед сдачей
Это как «мини-код-ревью», которое сам агент делает перед тем, как тебе отдавать результат (идея из гайда Anthropic — использовать чеклисты и явный self-review).

md
Копировать код
## САМОПРОВЕРКА ПЕРЕД СДАЧЕЙ

Перед тем как сказать, что задача выполнена, ты ОБЯЗАН:

1. Пройтись по чеклисту:
   - [ ] Все пункты плана выполнены.
   - [ ] НЕТ правок вне списка разрешённых файлов.
   - [ ] Нет "случайных" изменений (форматирование, переносы строк, rename без причины).
   - [ ] Тесты и команды из секции "Тесты и проверки" прошли успешно.

2. Написать короткий summary:
   - какие файлы изменились (списком),
   - какие побочные эффекты могут быть (если есть),
   - что нужно будет проверить руками (UI, парсинг на живых данных и т.п.).

3. Если что-то осталось недоделано из-за лимитов/ошибок:
   - явно перечисли, ЧТО не успел и ПОЧЕМУ,
   - предложи следующий шаг для отдельной задачи.
