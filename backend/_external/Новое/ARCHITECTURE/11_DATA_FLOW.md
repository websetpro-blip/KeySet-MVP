# 11. –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö KeySet-MVP

> **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –¥–∞–Ω–Ω—ã—Ö: UI ‚Üí API ‚Üí Parser ‚Üí DB ‚Üí UI**

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–¶–µ–ª—å](#—Ü–µ–ª—å)
- [–î–ª—è –∫–æ–≥–æ](#–¥–ª—è-–∫–æ–≥–æ)
- [–°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã](#—Å–≤—è–∑–∞–Ω–Ω—ã–µ-–¥–æ–∫—É–º–µ–Ω—Ç—ã)
- [–û–±—â–∞—è —Å—Ö–µ–º–∞ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö](#–æ–±—â–∞—è-—Å—Ö–µ–º–∞-–ø–æ—Ç–æ–∫–∞-–¥–∞–Ω–Ω—ã—Ö)
- [–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏](#–¥–∏–∞–≥—Ä–∞–º–º–∞-–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
- [–û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏](#–æ—Å–Ω–æ–≤–Ω—ã–µ-—Å—Ü–µ–Ω–∞—Ä–∏–∏)
- [–°–Ω–∏–ø–ø–µ—Ç—ã –∫–æ–¥–∞](#—Å–Ω–∏–ø–ø–µ—Ç—ã-–∫–æ–¥–∞)
- [–¢–∏–ø–æ–≤—ã–µ –æ—à–∏–±–∫–∏](#—Ç–∏–ø–æ–≤—ã–µ-–æ—à–∏–±–∫–∏)
- [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](#–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)
- [TL;DR](#tldr)
- [–ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è](#—á–µ–∫-–ª–∏—Å—Ç-–ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è)

---

## –¶–µ–ª—å

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ—Ç–æ–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö KeySet-MVP: –æ—Ç –≤–≤–æ–¥–∞ —Ñ—Ä–∞–∑ –≤ UI –¥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –ë–î –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ.

## –î–ª—è –∫–æ–≥–æ

- Tech Lead –¥–ª—è –æ—Ü–µ–Ω–∫–∏ end-to-end –ø–æ—Ç–æ–∫–∞
- Backend –∏ frontend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏
- QA –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∫–≤–æ–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- Data analysts –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [06_PARSING.md](./06_PARSING.md) ‚Äî –ø–∞—Ä—Å–∏–Ω–≥ —Å–∏—Å—Ç–µ–º–∞
- [10_API_INTEGRATION.md](./10_API_INTEGRATION.md) ‚Äî API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- [01_DATABASE.md](./01_DATABASE.md) ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î
- [09_TABS_OVERVIEW.md](./09_TABS_OVERVIEW.md) ‚Äî UI –º–æ–¥—É–ª–∏

---

## –û–±—â–∞—è —Å—Ö–µ–º–∞ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö

```mermaid
graph TD
    A[Frontend UI] -->|GraphQL/REST| B[API Layer]
    B -->|Commands| C[Task Queue]
    C -->|Tasks| D[Parsing Workers]
    D -->|CDP Requests| E[Yandex Wordstat]
    E -->|Responses| D
    D -->|Results| F[Database]
    F -->|Queries| G[Analytics Engine]
    G -->|Data| A
    F -->|Exports| H[CSV/XLSX]
```

---

## –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```mermaid
sequenceDiagram
    participant UI as Frontend UI
    participant API as API Server
    participant Worker as Parsing Worker
    participant DB as Database
    participant WS as WebSocket
    participant YA as Yandex API
    
    UI->>API: POST /api/wordstat/start (phrases, region_id)
    API->>Worker: enqueue task
    Worker->>YA: fetch frequency
    YA-->>Worker: frequency JSON
    Worker->>DB: save freq_results
    Worker->>WS: send progress update
    WS-->>UI: real-time updates
    UI->>API: GET /api/data/phrases
    API->>DB: query results
    DB-->>API: rows
    API-->>UI: table data
```

---

## –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### 1. –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Å–ø–∏—Å–æ–∫ —Ñ—Ä–∞–∑
- –í—ã–±–∏—Ä–∞–µ—Ç —Ä–µ–≥–∏–æ–Ω –∏ –∞–∫–∫–∞—É–Ω—Ç—ã
- UI –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å `/api/wordstat/start`
- API —Å–æ–∑–¥–∞—ë—Ç –∑–∞–¥–∞—á—É –≤ –æ—á–µ—Ä–µ–¥–∏
- Worker —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ñ—Ä–∞–∑—ã –ø–æ –∞–∫–∫–∞—É–Ω—Ç–∞–º

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- Worker –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã –æ—Ç Yandex API
- –ü–∞—Ä—Å–∏—Ç JSON –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É `freq_results`
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket
- API –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —á–µ—Ä–µ–∑ `/api/data/phrases`

### 3. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
- Analytics Tab –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ –æ—Ç—á—ë—Ç–æ–≤

---

## –°–Ω–∏–ø–ø–µ—Ç—ã –∫–æ–¥–∞

### –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞

```python
# —Ñ–∞–π–ª: keyset/services/multiparser_manager.py:375-397
def create_task(
    self, 
    profile_email: str,
    profile_path: str,
    proxy_uri: Optional[str],
    phrases: List[str]
) -> ParsingTask:
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –ø–∞—Ä—Å–∏–Ω–≥–∞"""
    task_id = f"{profile_email}_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
    
    task = ParsingTask(
        task_id=task_id,
        profile_email=profile_email,
        profile_path=Path(profile_path),
        proxy_uri=proxy_uri,
        phrases=phrases
    )
    
    with self._lock:
        self.tasks[task_id] = task
        
    logger.info(f"Created task {task_id} for {profile_email} with {len(phrases)} phrases")
    return task
```

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –ë–î

```python
# —Ñ–∞–π–ª: backend/db.py:110-138
class FrequencyResult(Base):
    """Frequency parsing result model"""

    __tablename__ = "freq_results"

    # Primary key
    id = Column(Integer, primary_key=True, index=True)

    # Phrase and region
    mask = Column(String(500), nullable=False, index=True)
    region = Column(Integer, nullable=True, index=True)

    # Frequencies
    freq_total = Column(Integer, default=0)  # Broad match (WS)
    freq_quotes = Column(Integer, default=0)  # Phrase match ("WS")
    freq_exact = Column(Integer, default=0)  # Exact match (!WS)

    # Metadata
    group = Column(String(255))  # Group for organization
    status = Column(String(50), default="queued")
    attempts = Column(Integer, default=0)
    error = Column(Text)

    # Timestamps
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    __table_args__ = (UniqueConstraint("mask", "region", name="uq_mask_region"),)
```

### WebSocket –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–∫–æ–Ω—Ü–µ–ø—Ç)

```python
# —Ñ–∞–π–ª: backend/main.py (–ø—Ä–∏–º–µ—Ä –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è)
async def send_parsing_update(websocket: WebSocket, task_id: str, progress: int):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ WebSocket"""
    message = {
        "type": "parsing_progress",
        "task_id": task_id,
        "progress": progress,
        "timestamp": datetime.utcnow().isoformat()
    }
    await websocket.send_json(message)
```

### Frontend –∑–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö

```typescript
// —Ñ–∞–π–ª: frontend/src/modules/data/api/data.ts:66-80
export function fetchPhrases(params: FetchPhraseParams = {}): Promise<PhraseListResponse> {
  const query = new URLSearchParams();
  if (params.limit) query.set('limit', String(params.limit));
  if (params.offset) query.set('offset', String(params.offset));
  if (params.search) query.set('search', params.search);
  if (params.status) query.set('status', params.status);
  if (params.q) query.set('q', params.q);
  if (params.cursor !== undefined && params.cursor !== null) {
    query.set('cursor', String(params.cursor));
  }
  if (params.sort) query.set('sort', params.sort);

  const suffix = query.toString() ? `?${query.toString()}` : '';
  return request<PhraseListResponse>(`/phrases${suffix}`);
}
```

---

## –¢–∏–ø–æ–≤—ã–µ –æ—à–∏–±–∫–∏ / –ö–∞–∫ —á–∏–Ω–∏—Ç—å

### ‚ùå –û—à–∏–±–∫–∞: "Data not syncing between tabs"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ WebSocket –∏–ª–∏ Zustand store –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è.

**–ö–∞–∫ —á–∏–Ω–∏—Ç—å:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ `ws://localhost:8000/ws` –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ —Å–æ–±—ã—Ç–∏—è –≤ `useEffect`.
2. –û–±–Ω–æ–≤–ª—è–π—Ç–µ store —á–µ—Ä–µ–∑ `useStore.setState` –≤–Ω—É—Ç—Ä–∏ `ws.onmessage`.
3. –î–æ–±–∞–≤—å—Ç–µ fallback: —Ä–∞–∑ –≤ 30 —Å–µ–∫ –∑–∞–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ `/api/data/phrases` –µ—Å–ª–∏ WebSocket –æ—Ç–∫–ª—é—á—ë–Ω.

### ‚ùå –û—à–∏–±–∫–∞: "Stale data in analytics"

**–ü—Ä–∏—á–∏–Ω–∞:** –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –±–µ–∑ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–∏—è.

**–ö–∞–∫ —á–∏–Ω–∏—Ç—å:**
1. –î–æ–±–∞–≤—å—Ç–µ timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –µ–≥–æ –ø–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –≥—Ä–∞—Ñ–∏–∫–æ–≤.
2. –°–±—Ä–∞—Å—ã–≤–∞–π—Ç–µ memoized –¥–∞–Ω–Ω—ã–µ –≤ Analytics Module –ø—Ä–∏ –Ω–æ–≤–æ–º —Å–æ–±—ã—Ç–∏–∏ WS.
3. –í backend –¥–æ–±–∞–≤—å—Ç–µ ETag/Last-Modified –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤.

### ‚ùå –û—à–∏–±–∫–∞: "Missing region_id in results"

**–ü—Ä–∏—á–∏–Ω–∞:** `region_id` –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –¥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞.

**–ö–∞–∫ —á–∏–Ω–∏—Ç—å:**
1. –ù–∞ —Ñ—Ä–æ–Ω—Ç–µ –¥–µ–ª–∞–π—Ç–µ `ensureRegion()` –∏ –∑–∞–ø—Ä–µ—â–∞–π—Ç–µ –∑–∞–ø—É—Å–∫ –±–µ–∑ region.
2. –í API —Ç—Ä–µ–±—É–π—Ç–µ `regions` –≤ `CollectRequest` (–≤–∞–ª–∏–¥–∞—Ç–æ—Ä —É–∂–µ –ø—Ä–∏–≤–æ–¥–∏–ª –∫ [225]).
3. –í worker –ª–æ–≥–∏—Ä—É–π—Ç–µ payload –∑–∞–¥–∞—á–∏ –∏ –∑–∞–≤–µ—Ä–Ω–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ assert: `assert region_id is not None`.

---

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö

```mermaid
graph LR
    UI[UI] --> API[API]
    API --> Worker[Worker]
    Worker --> DB[DB]
    DB --> UI
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î

```sql
SELECT phrase, shows, region_id
FROM freq_results
ORDER BY created_at DESC
LIMIT 20;
```

### 3. –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ WebSocket

```typescript
const ws = new WebSocket('ws://localhost:8000/ws');

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  updateDataStore(data);
};
```

---

## TL;DR

- **UI ‚Üí API ‚Üí Worker ‚Üí DB ‚Üí UI** ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –¥–∞–Ω–Ω—ã—Ö
- **WebSocket** ‚Äî real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
- **freq_results** ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- **region_id** ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π
- **Zustand** ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏

---

## –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

- [ ] UI –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ API
- [ ] API –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç payload –∑–∞–¥–∞—á–∏
- [ ] Worker —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –ë–î
- [ ] WebSocket –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Ö–æ–¥—è—Ç –¥–æ UI
- [ ] Analytics –ø–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- [ ] region_id –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏
- [ ] –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö
- [ ] –¢–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤–µ—Å—å –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö
- [ ] –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ CSV/XLSX
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2024-11-10

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** [12_PRODUCTION_WINDOWS_BUILD.md](./12_PRODUCTION_WINDOWS_BUILD.md) ‚Äî Production —Å–±–æ—Ä–∫–∞ Windows
